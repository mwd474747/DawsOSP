# Work Plan - October 27, 2025

## Context
Based on review of:
- [PRODUCT_SPEC.md](PRODUCT_SPEC.md) - Master build spec
- [.ops/TASK_INVENTORY_2025-10-24.md](.ops/TASK_INVENTORY_2025-10-24.md) - Canonical backlog (CORRECTED)
- [CLAUDE.md](CLAUDE.md) - Current system status (≈60-70% complete - CORRECTED)
- [CLEANUP_AND_REMEDIATION_PLAN.md](CLEANUP_AND_REMEDIATION_PLAN.md) - Immediate cleanup needs
- [TRUTH_AUDIT_2025-10-27.md](TRUTH_AUDIT_2025-10-27.md) - Corrected status (60-70% complete - CORRECTED)

---

## Current System Status (Verified)

### ✅ What Works (60-70% Complete - CORRECTED)
- **Core Execution**: Executor API, Pattern Orchestrator, Agent Runtime operational
- **Agents**: 9/9 registered (financial_analyst, macro_hound, data_harvester, claude, ratings, optimizer, reports, alerts, charts)
- **Services**: 26 service files implemented (ratings, optimizer, reports, auth, audit, pricing, ledger, macro, risk, cycles, scenarios)
- **Database**: 25 tables, RLS policies, ADR pay-date FX (migrations/008), rating rubrics
- **Tests**: 48 test files found (pytest collection failed - cannot verify actual test count)
- **P0 Complete**: Rating rubrics, FMP transformation, ADR FX
- **P1 Partial**: Macro scenarios (22 tests), DaR, provider transformations

### ⚠️ What Needs Work (CORRECTED)
1. **PDF Reports Implementation** - WeasyPrint integration NOT implemented (returns placeholder text)
2. **Optimizer integration** (P1-CODE-3: 40h) - Riskfolio-Lib wiring to patterns (service scaffold exists, not wired)
3. **Authentication & RBAC** - JWT validation replacing stub X-User-ID header (service exists, not integrated)
4. **Nightly job orchestration** - Scheduler exists but NOT tested end-to-end
5. **Observability activation** - Infrastructure exists but disabled by default
6. **Testing uplift** - pytest collection failed, need to fix test infrastructure

---

## Immediate Priorities (P0 - BLOCKING)

### BLOCKING-1: Register Reports Agent ⏱️ 5 minutes
**Why Critical**: reports_agent.py exists (322 lines, 3 capabilities) but capability routing fails because agent not registered

**Task**: Add 3 lines to [backend/app/api/executor.py](backend/app/api/executor.py)

**Delegation**: **general-purpose** agent (simple code edit)

**Acceptance**:
```bash
grep -c "register_agent" backend/app/api/executor.py  # Should return 7, not 6
curl -X POST http://localhost:8000/v1/execute -H "Content-Type: application/json" \
  -d '{"pattern_id":"export_portfolio_report","inputs":{...}}'  # Should route to reports_agent
```

### BLOCKING-2: Verify Application Startup ⏱️ 15 minutes
**Why Critical**: Cannot test anything until we verify clean startup

**Task**:
1. Kill all stuck processes
2. Start backend cleanly
3. Run health check
4. Verify all 7 agents registered
5. Test simple pattern execution

**Delegation**: **general-purpose** agent (verification task)

**Acceptance**:
```bash
curl http://localhost:8000/health  # Returns 200 OK
curl http://localhost:8000/health/pack  # Returns pack status
# Logs show "Agent runtime initialized with 7 agents"
```

### BLOCKING-3: Run Test Suite and Measure Coverage ⏱️ 20 minutes
**Why Critical**: We have comprehensive tests but don't know actual coverage percentage

**Task**:
```bash
pytest backend/tests/ -v --cov=backend/app --cov-report=term --cov-report=html
```

**Delegation**: **general-purpose** agent (test execution)

**Acceptance**:
- All tests pass OR failures documented with root cause
- Coverage report generated (actual percentage measured, not estimated)
- HTML coverage report saved for detailed analysis

---

## High Priority (P1 - NEXT SPRINT)

### P1-1: Complete Optimizer Integration ⏱️ 40 hours
**Status**: Service exists (1,283 lines), OptimizerAgent exists (514 lines, 4 capabilities), NOT wired to patterns

**Task Breakdown**:
1. Install riskfolio-lib dependency (1h)
2. Test optimizer service methods in isolation (4h)
3. Wire policy_rebalance pattern to optimizer.propose_trades (8h)
4. Test pattern execution end-to-end (4h)
5. Add optimizer UI screen (12h)
6. Create integration tests (8h)
7. Documentation and examples (3h)

**Delegation**: **general-purpose** agent (multi-step complex task)

**Acceptance**:
- `policy_rebalance` pattern executes successfully
- Returns proposed trades with Riskfolio-Lib optimization
- UI screen displays rebalance recommendations
- Integration tests passing

### P1-2: Rights-Enforced PDF Exports ⏱️ 16 hours
**Status**: ReportsService exists (584 lines), templates exist (3 files), NOT tested, WeasyPrint not installed

**Task Breakdown**:
1. Install weasyprint dependency (1h)
2. Test PDF generation with templates (4h)
3. Test rights enforcement (attribution footers, watermarks) (4h)
4. Wire to export_portfolio_report pattern (4h)
5. Add export tests (3h)

**Delegation**: **general-purpose** agent (implementation + testing)

**Acceptance**:
- PDF exports generate successfully
- Rights attribution included in footers
- Watermarks applied for restricted data
- Export tests passing

### P1-3: Authentication & RBAC ⏱️ 20 hours
**Status**: AuthService exists (399 lines, JWT/bcrypt), audit_log table exists (migrations/010), NOT wired to executor

**Task Breakdown**:
1. Replace stub X-User-ID with JWT validation middleware (8h)
2. Wire RBAC permission checks to pattern execution (6h)
3. Test role enforcement (VIEWER/USER/MANAGER/ADMIN) (4h)
4. Audit logging for sensitive operations (2h)

**Delegation**: **general-purpose** agent (security-critical implementation)

**Acceptance**:
- JWT tokens required for all /v1/execute calls
- Role-based access enforced (e.g., VIEWER cannot execute optimizer patterns)
- Audit log populated for sensitive operations
- Security tests passing

### P1-4: Nightly Job Orchestration Testing ⏱️ 12 hours
**Status**: scheduler.py enhanced (545 lines), jobs exist (build_pack, reconcile, metrics, prewarm, alerts), NOT tested end-to-end

**Task Breakdown**:
1. Test sacred job order in isolation (4h)
2. Test pack freshness gate (3h)
3. Test error handling (job failures, retries) (3h)
4. Documentation of nightly workflow (2h)

**Delegation**: **general-purpose** agent (testing + documentation)

**Acceptance**:
- Jobs execute in correct order
- Pack freshness gate enforced (/health/pack returns is_fresh=true after prewarm)
- Failed jobs don't break pipeline
- Runbook documented

---

## Medium Priority (P2 - NEXT 2 SPRINTS)

### P2-1: Chart Placeholders ⏱️ 60 hours
**Status**: Holding deep dive pattern references visualization capabilities, NOT implemented

**Task**: Implement chart capabilities for holding_deep_dive pattern (allocation donut, attribution waterfall, etc.)

**Delegation**: **general-purpose** agent (UI/visualization work)

### P2-2: Observability Wiring ⏱️ 24 hours
**Status**: OpenTelemetry/Prometheus instrumentation exists (toggled via ENABLE_OBSERVABILITY), dashboards NOT created

**Task**:
1. Wire OpenTelemetry exporter
2. Create Prometheus dashboards
3. Configure alert routing

**Delegation**: **general-purpose** agent (observability setup)

### P2-3: Provider Integration Hardening ⏱️ 16 hours
**Status**: Providers work with seed data, rate limiting/retries NOT fully tested

**Task**: Test provider integrations under failure scenarios (rate limits, outages, malformed data)

**Delegation**: **general-purpose** agent (chaos testing)

---

## Delegation Strategy

### Immediate (Today)
1. **BLOCKING-1**: Register reports_agent → **general-purpose** (5 min)
2. **BLOCKING-2**: Verify startup → **general-purpose** (15 min)
3. **BLOCKING-3**: Run test suite → **general-purpose** (20 min)

### This Week
4. **P1-1**: Optimizer integration → **general-purpose** (40h, split into 4x 10h sessions)
5. **P1-2**: PDF exports → **general-purpose** (16h, 2 sessions)
6. **P1-3**: Auth/RBAC → **general-purpose** (20h, 2 sessions)

### Next 2 Weeks
7. **P1-4**: Nightly jobs → **general-purpose** (12h, 1 session)
8. **P2-1**: Charts → **general-purpose** (60h, 6 sessions)
9. **P2-2**: Observability → **general-purpose** (24h, 3 sessions)

---

## Success Criteria

### This Session (Next 1 Hour)
- [x] Agent spec updates complete (DONE)
- [ ] Reports agent registered (BLOCKING-1)
- [ ] Application starts cleanly (BLOCKING-2)
- [ ] Test suite runs successfully (BLOCKING-3)
- [ ] Actual coverage measured (BLOCKING-3)

### This Week (Next 5 Days)
- [ ] Optimizer integration complete (P1-1)
- [ ] PDF exports working (P1-2)
- [ ] Auth/RBAC enforced (P1-3)
- [ ] Coverage ≥ 70% (measured)

### Next Sprint (2 Weeks)
- [ ] All P1 items complete
- [ ] Charts implemented (P2-1 started)
- [ ] Observability wired (P2-2 started)
- [ ] System ready for staging deployment

---

## Ground Rules (From Updated ORCHESTRATOR.md)

Before starting any work:
- [ ] Follow session checklist (ORCHESTRATOR.md:277-286)
- [ ] Use status taxonomy (SEEDED/PARTIAL/COMPLETE)
- [ ] Run verification protocol before claiming complete
- [ ] Use AGENT_SPEC_TEMPLATE.md for any new implementations
- [ ] Clean up processes at end of session

---

**Date**: October 27, 2025
**Purpose**: Plan next work based on honest assessment and user requirements
**Next Action**: Delegate BLOCKING-1 (register reports_agent) to general-purpose agent
