{
  "id": "portfolio_scenario_analysis",
  "name": "Portfolio Scenario Analysis",
  "description": "Stress test portfolio with macro scenarios and identify hedge opportunities",
  "version": "1.0.0",
  "category": "risk",
  "tags": ["scenario", "stress_test", "hedge", "risk"],
  "author": "DawsOS",
  "created": "2025-10-23",
  "inputs": {
    "portfolio_id": {
      "type": "uuid",
      "required": true,
      "description": "Portfolio UUID"
    },
    "scenario_id": {
      "type": "string",
      "required": false,
      "description": "Preset scenario ID (e.g., 'late_cycle_rates_up')"
    },
    "custom_shocks": {
      "type": "object",
      "required": false,
      "description": "Custom scenario shocks (rates_bps, usd_vs_cad_pct, cpi_surprise_pct)"
    }
  },
  "outputs": ["valued_base", "scenario_result", "hedge_suggestions", "charts"],
  "steps": [
    {
      "capability": "portfolio.get_valued_positions",
      "args": {
        "portfolio_id": "{{inputs.portfolio_id}}",
        "pack_id": "{{ctx.pricing_pack_id}}"
      },
      "as": "valued_base"
    },
    {
      "capability": "macro.run_scenario",
      "args": {
        "portfolio_id": "{{inputs.portfolio_id}}",
        "pack_id": "{{ctx.pricing_pack_id}}",
        "scenario_id": "{{inputs.scenario_id}}"
      },
      "as": "scenario_result"
    },
    {
      "capability": "financial_analyst.suggest_hedges",
      "args": {
        "portfolio_id": "{{inputs.portfolio_id}}",
        "scenario_result": "{{scenario_result}}",
        "pricing_pack_id": "{{ctx.pricing_pack_id}}"
      },
      "as": "hedge_suggestions"
    },
    {
      "capability": "financial_analyst.scenario_charts",
      "args": {
        "base": "{{valued_base}}",
        "shocked": "{{scenario_result}}"
      },
      "as": "charts"
    }
  ],
  "presentation": {
    "scenario_summary": {
      "metrics": [
        {
          "label": "Scenario Name",
          "value": "{{scenario_result.scenario_name}}",
          "format": "text"
        },
        {
          "label": "Total P&L Impact",
          "value": "{{scenario_result.total_pnl_delta}}",
          "format": "currency",
          "color_condition": "sign"
        },
        {
          "label": "Return Impact",
          "value": "{{scenario_result.return_delta}}",
          "format": "percentage",
          "color_condition": "sign"
        },
        {
          "label": "Max Position Loss",
          "value": "{{scenario_result.max_position_loss}}",
          "format": "currency",
          "color": "red"
        },
        {
          "label": "Positions Impacted",
          "value": "{{scenario_result.positions_impacted}}",
          "format": "number"
        }
      ]
    },
    "delta_table": {
      "columns": [
        {"field": "symbol", "header": "Symbol", "width": 100},
        {"field": "base_value", "header": "Base Value", "format": "currency", "width": 120},
        {"field": "shocked_value", "header": "Shocked Value", "format": "currency", "width": 120},
        {"field": "delta_value", "header": "Delta ($)", "format": "currency", "width": 120, "color_condition": "sign"},
        {"field": "delta_pct", "header": "Delta (%)", "format": "percentage", "width": 100, "color_condition": "sign"},
        {"field": "primary_driver", "header": "Driver", "width": 120}
      ],
      "data": "{{scenario_result.position_deltas}}"
    },
    "winners_losers": {
      "winners": {
        "title": "Top 5 Winners",
        "data": "{{scenario_result.winners}}",
        "value_field": "delta_value",
        "label_field": "symbol"
      },
      "losers": {
        "title": "Top 5 Losers",
        "data": "{{scenario_result.losers}}",
        "value_field": "delta_value",
        "label_field": "symbol"
      }
    },
    "hedge_suggestions": {
      "cards": "{{hedge_suggestions.suggestions}}",
      "card_template": {
        "title": "{{instrument}}",
        "subtitle": "{{strategy}}",
        "metrics": [
          {"label": "Estimated Cost", "value": "{{cost_bps}}", "format": "bps"},
          {"label": "Hedge Effectiveness", "value": "{{effectiveness}}", "format": "percentage"},
          {"label": "Suggested Size", "value": "{{size}}", "format": "currency"}
        ]
      }
    }
  },
  "rights_required": ["portfolio_read", "scenario_analysis"],
  "export_allowed": {
    "pdf": true,
    "csv": true
  }
}
