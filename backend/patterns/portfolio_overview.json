{
  "id": "portfolio_overview",
  "name": "Portfolio Overview",
  "description": "Comprehensive portfolio snapshot with performance, attribution, and ratings",
  "version": "1.0.0",
  "category": "portfolio",
  "tags": ["portfolio", "performance", "attribution", "overview"],
  "author": "DawsOS",
  "created": "2025-10-23",
  "inputs": {
    "portfolio_id": {
      "type": "uuid",
      "required": true,
      "description": "Portfolio UUID"
    },
    "lookback_days": {
      "type": "integer",
      "default": 252,
      "description": "Historical period in days (default 1 year)"
    }
  },
  "outputs": ["perf_metrics", "currency_attr", "valued_positions", "sector_allocation", "historical_nav"],
  "output_schemas": {
    "perf_metrics": {
      "description": "Performance metrics including TWR, volatility, Sharpe ratio",
      "type": "object",
      "required": ["twr_1y", "volatility", "sharpe_ratio", "max_drawdown"],
      "properties": {
        "twr_1y": {"type": "number", "description": "1-year time-weighted return"},
        "volatility": {"type": "number", "description": "Annualized volatility"},
        "sharpe_ratio": {"type": "number", "description": "Sharpe ratio"},
        "max_drawdown": {"type": "number", "description": "Maximum drawdown"}
      }
    },
    "currency_attr": {
      "description": "Currency attribution breakdown",
      "type": "object",
      "required": ["local_return", "fx_return", "interaction"],
      "properties": {
        "local_return": {"type": "number"},
        "fx_return": {"type": "number"},
        "interaction": {"type": "number"}
      }
    },
    "valued_positions": {
      "description": "Portfolio positions with current values",
      "type": "object",
      "required": ["positions", "total_value"],
      "properties": {
        "positions": {
          "type": "array",
          "items": {
            "type": "object",
            "required": ["symbol", "quantity", "market_value", "weight"],
            "properties": {
              "symbol": {"type": "string"},
              "name": {"type": "string"},
              "quantity": {"type": "number"},
              "market_value": {"type": "number"},
              "weight": {"type": "number"},
              "unrealized_pnl": {"type": "number"},
              "dividend_safety": {"type": ["string", "null"]},
              "moat_strength": {"type": ["string", "null"]}
            }
          }
        },
        "total_value": {"type": "number"}
      }
    },
    "sector_allocation": {
      "description": "Sector allocation breakdown",
      "type": "object",
      "properties": {
        "sectors": {
          "type": "array",
          "items": {
            "type": "object",
            "required": ["sector", "value", "weight"],
            "properties": {
              "sector": {"type": "string"},
              "value": {"type": "number"},
              "weight": {"type": "number"}
            }
          }
        }
      }
    },
    "historical_nav": {
      "description": "Historical NAV time series",
      "type": "object",
      "properties": {
        "dates": {"type": "array", "items": {"type": "string", "format": "date"}},
        "values": {"type": "array", "items": {"type": "number"}}
      }
    }
  },
  "display": {
    "panels": [
      {
        "id": "performance_strip",
        "title": "Performance Metrics",
        "type": "metrics_grid",
        "refresh_ttl": 300
      },
      {
        "id": "historical_nav",
        "title": "Portfolio Value Over Time",
        "type": "line_chart",
        "refresh_ttl": 300
      },
      {
        "id": "currency_attribution",
        "title": "Currency Attribution",
        "type": "donut_chart",
        "refresh_ttl": 300
      },
      {
        "id": "sector_allocation",
        "title": "Sector Allocation",
        "type": "pie_chart",
        "refresh_ttl": 300
      },
      {
        "id": "holdings",
        "title": "Holdings",
        "type": "table",
        "refresh_ttl": 60
      },
      {
        "id": "allocation",
        "title": "Asset Allocation",
        "type": "pie_chart",
        "refresh_ttl": 300
      }
    ]
  },
  "steps": [
    {
      "capability": "portfolio.get_valued_positions",
      "args": {
        "portfolio_id": "{{inputs.portfolio_id}}",
        "pack_id": "{{ctx.pricing_pack_id}}"
      },
      "as": "valued_positions"
    },
    {
      "capability": "metrics.compute_twr",
      "args": {
        "portfolio_id": "{{inputs.portfolio_id}}",
        "pack_id": "{{ctx.pricing_pack_id}}",
        "lookback_days": "{{inputs.lookback_days}}"
      },
      "as": "perf_metrics"
    },
    {
      "capability": "attribution.currency",
      "args": {
        "portfolio_id": "{{inputs.portfolio_id}}",
        "pack_id": "{{ctx.pricing_pack_id}}",
        "lookback_days": "{{inputs.lookback_days}}"
      },
      "as": "currency_attr"
    },
    {
      "capability": "portfolio.sector_allocation",
      "args": {
        "valued_positions": "{{valued_positions.positions}}"
      },
      "as": "sector_allocation"
    },
    {
      "capability": "portfolio.historical_nav",
      "args": {
        "portfolio_id": "{{inputs.portfolio_id}}",
        "lookback_days": "{{inputs.lookback_days}}"
      },
      "as": "historical_nav"
    }
  ],
  "presentation": {
    "performance_strip": {
      "metrics": [
        {
          "label": "TWR (1Y)",
          "value": "{{perf_metrics.twr_1y}}",
          "format": "percentage",
          "color_condition": "sign"
        },
        {
          "label": "Volatility",
          "value": "{{perf_metrics.volatility}}",
          "format": "percentage"
        },
        {
          "label": "Sharpe Ratio",
          "value": "{{perf_metrics.sharpe_ratio}}",
          "format": "decimal_2"
        },
        {
          "label": "Max Drawdown",
          "value": "{{perf_metrics.max_drawdown}}",
          "format": "percentage",
          "color": "red"
        },
        {
          "label": "Total Value",
          "value": "{{valued_positions.total_value}}",
          "format": "currency"
        }
      ]
    },
    "currency_attribution": {
      "chart": {
        "type": "donut",
        "title": "Return Attribution (Local vs FX)",
        "series": [
          {
            "name": "Local Return",
            "value": "{{currency_attr.local_return}}",
            "color": "#00d9ff"
          },
          {
            "name": "FX Return",
            "value": "{{currency_attr.fx_return}}",
            "color": "#e74c3c"
          },
          {
            "name": "Interaction",
            "value": "{{currency_attr.interaction}}",
            "color": "#9b59b6"
          }
        ]
      }
    },
    "holdings": {
      "columns": [
        {"field": "symbol", "header": "Symbol", "width": 100},
        {"field": "name", "header": "Name", "width": 200},
        {"field": "quantity", "header": "Qty", "format": "number", "width": 100},
        {"field": "market_value", "header": "Value", "format": "currency", "width": 120},
        {"field": "weight", "header": "Weight", "format": "percentage", "width": 100},
        {"field": "unrealized_pnl", "header": "P&L", "format": "currency", "width": 120, "color_condition": "sign"},
        {"field": "dividend_safety", "header": "Div Safety", "format": "rating", "width": 100},
        {"field": "moat_strength", "header": "Moat", "format": "rating", "width": 100}
      ],
      "data": "{{valued_positions.positions}}"
    }
  },
  "rights_required": ["portfolio_read"],
  "export_allowed": {
    "pdf": true,
    "csv": true,
    "excel": true
  }
}
