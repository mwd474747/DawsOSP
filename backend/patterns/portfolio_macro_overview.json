{
  "id": "portfolio_macro_overview",
  "name": "Portfolio Macro Overview",
  "description": "Macro regime analysis with factor exposures and DaR for portfolio",
  "version": "1.0.0",
  "category": "macro",
  "tags": ["macro", "regime", "factors", "dar", "risk"],
  "author": "DawsOS",
  "created": "2025-10-23",
  "inputs": {
    "portfolio_id": {
      "type": "uuid",
      "required": true,
      "description": "Portfolio UUID"
    },
    "confidence_level": {
      "type": "number",
      "default": 0.95,
      "description": "Confidence level for DaR (default 95%)"
    }
  },
  "outputs": {
    "panels": [
      {
        "id": "regime_card",
        "title": "Current Regime",
        "type": "regime_widget",
        "refresh_ttl": 3600
      },
      {
        "id": "factor_exposures",
        "title": "Factor Exposures",
        "type": "bar_chart",
        "refresh_ttl": 3600
      },
      {
        "id": "dar_widget",
        "title": "Drawdown at Risk",
        "type": "gauge_with_waterfall",
        "refresh_ttl": 3600
      }
    ]
  },
  "steps": [
    {
      "capability": "ledger.positions",
      "args": {
        "portfolio_id": "{{inputs.portfolio_id}}"
      },
      "as": "positions"
    },
    {
      "capability": "macro.detect_regime",
      "args": {
        "asof_date": "{{ctx.asof_date}}"
      },
      "as": "regime"
    },
    {
      "capability": "macro.get_indicators",
      "args": {
        "asof_date": "{{ctx.asof_date}}"
      },
      "as": "indicators"
    },
    {
      "capability": "risk.compute_factor_exposures",
      "args": {
        "portfolio_id": "{{inputs.portfolio_id}}",
        "pack_id": "{{ctx.pricing_pack_id}}"
      },
      "as": "factor_exposures"
    },
    {
      "capability": "macro.compute_dar",
      "args": {
        "portfolio_id": "{{inputs.portfolio_id}}",
        "pack_id": "{{ctx.pricing_pack_id}}",
        "confidence_level": "{{inputs.confidence_level}}"
      },
      "as": "dar"
    },
    {
      "capability": "charts.macro_overview",
      "args": {
        "regime": "{{state.regime}}",
        "indicators": "{{state.indicators}}",
        "factor_exposures": "{{state.factor_exposures}}",
        "dar": "{{state.dar}}"
      },
      "as": "charts"
    }
  ],
  "presentation": {
    "regime_card": {
      "regime_name": "{{regime.regime_name}}",
      "confidence": "{{regime.confidence}}",
      "date": "{{regime.date}}",
      "indicators": "{{regime.indicators}}",
      "zscores": "{{regime.zscores}}",
      "chart": {
        "type": "regime_probabilities",
        "data": "{{regime.regime_scores}}"
      }
    },
    "factor_exposures": {
      "chart": {
        "type": "horizontal_bar",
        "title": "Factor Exposures",
        "categories": ["Real Rates", "Inflation", "Credit Spread", "FX", "Equity Risk"],
        "series": [
          {
            "name": "Beta",
            "data": "{{factor_exposures.betas}}",
            "color": "#00d9ff"
          },
          {
            "name": "Variance Share",
            "data": "{{factor_exposures.variance_shares}}",
            "color": "#9b59b6"
          }
        ]
      }
    },
    "dar_widget": {
      "gauge": {
        "value": "{{dar.dar_value}}",
        "min": "{{dar.min_dar}}",
        "max": "{{dar.max_dar}}",
        "threshold": "{{dar.threshold}}",
        "color": "red"
      },
      "waterfall": {
        "title": "Factor Contribution to DaR",
        "categories": ["Real Rates", "Inflation", "Credit", "FX", "Equity", "Total DaR"],
        "values": "{{dar.factor_contributions}}"
      }
    }
  },
  "rights_required": ["portfolio_read", "macro_data_read"],
  "export_allowed": {
    "pdf": true,
    "csv": true
  },
  "observability": {
    "otel_span_name": "pattern.portfolio_macro_overview",
    "metrics": [
      "pattern_execution_duration_seconds",
      "dar_computation_duration_seconds"
    ]
  }
}
