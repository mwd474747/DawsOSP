{
  "id": "export_portfolio_report",
  "name": "Export Portfolio Report",
  "description": "Generate comprehensive portfolio PDF report with rights enforcement",
  "version": "1.0.0",
  "category": "export",
  "tags": ["export", "report", "pdf", "compliance"],
  "author": "DawsOS",
  "created": "2025-10-23",
  "inputs": {
    "portfolio_id": {
      "type": "uuid",
      "required": true,
      "description": "Portfolio UUID"
    },
    "include_holdings": {
      "type": "boolean",
      "default": true,
      "description": "Include detailed holdings table"
    },
    "include_performance": {
      "type": "boolean",
      "default": true,
      "description": "Include performance charts"
    },
    "include_macro": {
      "type": "boolean",
      "default": false,
      "description": "Include macro analysis"
    }
  },
  "outputs": {
    "panels": [
      {
        "id": "report_status",
        "title": "Export Status",
        "type": "status",
        "refresh_ttl": 0
      }
    ]
  },
  "steps": [
    {
      "capability": "ledger.positions",
      "args": {
        "portfolio_id": "{{inputs.portfolio_id}}"
      },
      "as": "positions"
    },
    {
      "capability": "pricing.apply_pack",
      "args": {
        "positions": "{{positions.positions}}",
        "pack_id": "{{ctx.pricing_pack_id}}"
      },
      "as": "valued"
    },
    {
      "capability": "metrics.compute_twr",
      "args": {
        "portfolio_id": "{{inputs.portfolio_id}}",
        "pack_id": "{{ctx.pricing_pack_id}}"
      },
      "as": "performance",
      "condition": "{{inputs.include_performance}} == true"
    },
    {
      "capability": "attribution.currency",
      "args": {
        "portfolio_id": "{{inputs.portfolio_id}}",
        "pack_id": "{{ctx.pricing_pack_id}}"
      },
      "as": "currency_attr",
      "condition": "{{inputs.include_performance}} == true"
    },
    {
      "capability": "macro.detect_regime",
      "args": {
        "asof_date": "{{ctx.asof_date}}"
      },
      "as": "regime",
      "condition": "{{inputs.include_macro}} == true"
    },
    {
      "capability": "reports.render_pdf",
      "args": {
        "portfolio_id": "{{inputs.portfolio_id}}",
        "positions": "{{valued.positions}}",
        "performance": "{{performance}}",
        "currency_attr": "{{currency_attr}}",
        "regime": "{{regime}}",
        "pricing_pack_id": "{{ctx.pricing_pack_id}}",
        "ledger_commit_hash": "{{ctx.ledger_commit_hash}}",
        "include_sections": {
          "holdings": "{{inputs.include_holdings}}",
          "performance": "{{inputs.include_performance}}",
          "macro": "{{inputs.include_macro}}"
        }
      },
      "as": "pdf_result"
    }
  ],
  "presentation": {
    "report_status": {
      "status": "{{pdf_result.status}}",
      "file_size_bytes": "{{pdf_result.file_size}}",
      "download_url": "{{pdf_result.download_url}}",
      "attributions": "{{pdf_result.attributions}}",
      "watermark_applied": "{{pdf_result.watermark_applied}}",
      "metadata": {
        "pricing_pack_id": "{{ctx.pricing_pack_id}}",
        "ledger_commit_hash": "{{ctx.ledger_commit_hash}}",
        "generated_at": "{{pdf_result.generated_at}}"
      }
    }
  },
  "rights_required": ["portfolio_read", "export_pdf"],
  "export_allowed": {
    "pdf": true,
    "csv": false,
    "excel": false
  },
  "observability": {
    "otel_span_name": "pattern.export_portfolio_report",
    "metrics": [
      "pattern_execution_duration_seconds",
      "pdf_generation_duration_seconds",
      "pdf_file_size_bytes"
    ]
  }
}
