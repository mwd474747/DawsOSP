{% extends "base.html" %}

{% block title %}Buffett Checklist - {{ report_data.symbol | default('Holdings Analysis') }}{% endblock %}

{% block content %}
<!-- Cover Page -->
<div class="cover-page">
    <h1>Buffett Investment Checklist</h1>
    <div class="subtitle">
        {% if report_data.symbol %}
        {{ report_data.symbol }} - {{ report_data.company_name | default(report_data.symbol) }}
        {% else %}
        Portfolio Holdings Analysis
        {% endif %}
    </div>
    <div class="timestamp">
        Generated: {{ timestamp }}
    </div>
</div>

<div class="page-break"></div>

<!-- Table of Contents -->
<h1>Table of Contents</h1>
<div class="toc">
    <div class="toc-item">
        <span class="toc-title">Overall Rating</span>
        <span class="toc-page">3</span>
    </div>
    <div class="toc-item">
        <span class="toc-title">Business Quality</span>
        <span class="toc-page">4</span>
    </div>
    <div class="toc-item">
        <span class="toc-title">Management Quality</span>
        <span class="toc-page">5</span>
    </div>
    <div class="toc-item">
        <span class="toc-title">Financial Strength</span>
        <span class="toc-page">6</span>
    </div>
    <div class="toc-item">
        <span class="toc-title">Valuation Analysis</span>
        <span class="toc-page">7</span>
    </div>
    <div class="toc-item">
        <span class="toc-title">Detailed Ratings</span>
        <span class="toc-page">8</span>
    </div>
</div>

<div class="page-break"></div>

<!-- Overall Rating -->
<h1>Overall Investment Rating</h1>

{% if report_data.overall_score is defined or report_data.aggregate_score is defined %}
{% set overall = report_data.overall_score or report_data.aggregate_score %}

<div class="rating-card" style="text-align: center; padding: 2em; background: linear-gradient(135deg, #00ACC1 0%, #00838F 100%); color: white;">
    <div style="font-size: 18pt; margin-bottom: 0.5em;">Overall Buffett Score</div>
    <div style="font-size: 72pt; font-weight: 700; margin: 0.5em 0;">{{ "%.1f".format(overall) }}</div>
    <div style="font-size: 18pt; opacity: 0.8;">/10.0</div>
    <div style="margin-top: 1em; font-size: 14pt;">
        {% if overall >= 8.0 %}
        ✓ Strong Investment Candidate
        {% elif overall >= 6.0 %}
        → Worth Further Investigation
        {% else %}
        ✗ Does Not Meet Criteria
        {% endif %}
    </div>
</div>

{% if report_data.recommendation %}
<h2>Recommendation</h2>
<div style="background: #f8f9fa; padding: 1.5em; border-left: 4px solid #00ACC1; margin: 1em 0;">
    <p style="font-size: 12pt; line-height: 1.8;">{{ report_data.recommendation }}</p>
</div>
{% endif %}

{% endif %}

<!-- Component Scores -->
<h2>Component Scores</h2>

<div class="kpi-grid">
    {% if report_data.ratings %}
    {% set ratings = report_data.ratings %}

    {% if ratings.dividend_safety is defined %}
    <div class="kpi-card">
        <div class="kpi-label">Dividend Safety</div>
        <div class="kpi-value">{{ "%.1f".format(ratings.dividend_safety) }}<span style="font-size: 14pt; color: #999;">/10</span></div>
        <div class="progress-bar">
            <div class="progress-fill" style="width: {{ ratings.dividend_safety * 10 }}%;"></div>
        </div>
    </div>
    {% endif %}

    {% if ratings.moat_strength is defined or ratings.moat is defined %}
    <div class="kpi-card">
        <div class="kpi-label">Moat Strength</div>
        <div class="kpi-value">{{ "%.1f".format(ratings.moat_strength | default(ratings.moat)) }}<span style="font-size: 14pt; color: #999;">/10</span></div>
        <div class="progress-bar">
            <div class="progress-fill" style="width: {{ (ratings.moat_strength | default(ratings.moat)) * 10 }}%;"></div>
        </div>
    </div>
    {% endif %}

    {% if ratings.resilience is defined %}
    <div class="kpi-card">
        <div class="kpi-label">Resilience</div>
        <div class="kpi-value">{{ "%.1f".format(ratings.resilience) }}<span style="font-size: 14pt; color: #999;">/10</span></div>
        <div class="progress-bar">
            <div class="progress-fill" style="width: {{ ratings.resilience * 10 }}%;"></div>
        </div>
    </div>
    {% endif %}

    {% if ratings.financial_strength is defined %}
    <div class="kpi-card">
        <div class="kpi-label">Financial Strength</div>
        <div class="kpi-value">{{ "%.1f".format(ratings.financial_strength) }}<span style="font-size: 14pt; color: #999;">/10</span></div>
        <div class="progress-bar">
            <div class="progress-fill" style="width: {{ ratings.financial_strength * 10 }}%;"></div>
        </div>
    </div>
    {% endif %}
    {% endif %}
</div>

<div class="page-break"></div>

<!-- Business Quality -->
<h1>Business Quality</h1>

{% if report_data.business_quality or report_data.ratings.moat_components %}
{% set business = report_data.business_quality or {} %}
{% set moat_components = report_data.ratings.moat_components or [] %}

<h2>Competitive Moat Analysis</h2>

{% if moat_components %}
<ul class="component-list">
    {% for component in moat_components %}
    <li class="component-item">
        <span class="component-name">{{ component.name }}</span>
        <span>
            <span class="component-score">{{ "%.1f".format(component.score) }}</span>
            <span class="component-weight">(weight: {{ "%.0f".format(component.weight * 100) }}%)</span>
        </span>
    </li>
    {% endfor %}
</ul>
{% endif %}

<h3>Key Strengths</h3>
{% if business.strengths %}
<ul>
    {% for strength in business.strengths %}
    <li style="margin: 0.5em 0;">{{ strength }}</li>
    {% endfor %}
</ul>
{% else %}
<ul>
    <li>Brand recognition and customer loyalty</li>
    <li>Network effects and switching costs</li>
    <li>Cost advantages and economies of scale</li>
    <li>Regulatory barriers and licenses</li>
</ul>
{% endif %}

{% if business.concerns or business.weaknesses %}
<h3>Areas of Concern</h3>
<ul>
    {% for concern in (business.concerns or business.weaknesses) %}
    <li style="margin: 0.5em 0;">{{ concern }}</li>
    {% endfor %}
</ul>
{% endif %}

{% endif %}

<div class="page-break"></div>

<!-- Management Quality -->
<h1>Management Quality</h1>

{% if report_data.management or report_data.ratings.management_score is defined %}
{% set mgmt = report_data.management or {} %}

<h2>Capital Allocation</h2>

<table>
    <thead>
        <tr>
            <th>Metric</th>
            <th class="numeric">Value</th>
            <th>Assessment</th>
        </tr>
    </thead>
    <tbody>
        {% if mgmt.roe is defined %}
        <tr>
            <td>Return on Equity (ROE)</td>
            <td class="numeric monospace">{{ "%.1f".format(mgmt.roe * 100) }}%</td>
            <td>
                {% if mgmt.roe >= 0.15 %}
                <span class="badge badge-high">Excellent</span>
                {% elif mgmt.roe >= 0.10 %}
                <span class="badge badge-medium">Good</span>
                {% else %}
                <span class="badge badge-low">Weak</span>
                {% endif %}
            </td>
        </tr>
        {% endif %}

        {% if mgmt.roic is defined %}
        <tr>
            <td>Return on Invested Capital (ROIC)</td>
            <td class="numeric monospace">{{ "%.1f".format(mgmt.roic * 100) }}%</td>
            <td>
                {% if mgmt.roic >= 0.12 %}
                <span class="badge badge-high">Excellent</span>
                {% elif mgmt.roic >= 0.08 %}
                <span class="badge badge-medium">Good</span>
                {% else %}
                <span class="badge badge-low">Weak</span>
                {% endif %}
            </td>
        </tr>
        {% endif %}

        {% if mgmt.fcf_margin is defined %}
        <tr>
            <td>Free Cash Flow Margin</td>
            <td class="numeric monospace">{{ "%.1f".format(mgmt.fcf_margin * 100) }}%</td>
            <td>
                {% if mgmt.fcf_margin >= 0.15 %}
                <span class="badge badge-high">Strong</span>
                {% elif mgmt.fcf_margin >= 0.08 %}
                <span class="badge badge-medium">Adequate</span>
                {% else %}
                <span class="badge badge-low">Weak</span>
                {% endif %}
            </td>
        </tr>
        {% endif %}
    </tbody>
</table>

<h3>Shareholder Returns</h3>

{% if mgmt.dividend_info or report_data.ratings.dividend_components %}
<table>
    <thead>
        <tr>
            <th>Aspect</th>
            <th class="numeric">Value</th>
        </tr>
    </thead>
    <tbody>
        {% if mgmt.dividend_yield is defined %}
        <tr>
            <td>Dividend Yield</td>
            <td class="numeric monospace">{{ "%.2f".format(mgmt.dividend_yield * 100) }}%</td>
        </tr>
        {% endif %}

        {% if mgmt.payout_ratio is defined %}
        <tr>
            <td>Payout Ratio</td>
            <td class="numeric monospace">{{ "%.1f".format(mgmt.payout_ratio * 100) }}%</td>
        </tr>
        {% endif %}

        {% if mgmt.growth_streak is defined %}
        <tr>
            <td>Dividend Growth Streak</td>
            <td class="numeric monospace">{{ mgmt.growth_streak }} years</td>
        </tr>
        {% endif %}
    </tbody>
</table>
{% endif %}

{% endif %}

<div class="page-break"></div>

<!-- Financial Strength -->
<h1>Financial Strength</h1>

{% if report_data.financials or report_data.fundamentals %}
{% set financials = report_data.financials or report_data.fundamentals %}

<h2>Balance Sheet Health</h2>

<table>
    <thead>
        <tr>
            <th>Metric</th>
            <th class="numeric">Value</th>
            <th>Status</th>
        </tr>
    </thead>
    <tbody>
        {% if financials.debt_to_equity is defined %}
        <tr>
            <td>Debt to Equity Ratio</td>
            <td class="numeric monospace">{{ "%.2f".format(financials.debt_to_equity) }}</td>
            <td>
                {% if financials.debt_to_equity <= 0.5 %}
                <span class="badge badge-high">Conservative</span>
                {% elif financials.debt_to_equity <= 1.0 %}
                <span class="badge badge-medium">Moderate</span>
                {% else %}
                <span class="badge badge-low">High</span>
                {% endif %}
            </td>
        </tr>
        {% endif %}

        {% if financials.current_ratio is defined %}
        <tr>
            <td>Current Ratio</td>
            <td class="numeric monospace">{{ "%.2f".format(financials.current_ratio) }}</td>
            <td>
                {% if financials.current_ratio >= 2.0 %}
                <span class="badge badge-high">Strong</span>
                {% elif financials.current_ratio >= 1.0 %}
                <span class="badge badge-medium">Adequate</span>
                {% else %}
                <span class="badge badge-low">Weak</span>
                {% endif %}
            </td>
        </tr>
        {% endif %}

        {% if financials.interest_coverage is defined %}
        <tr>
            <td>Interest Coverage Ratio</td>
            <td class="numeric monospace">{{ "%.1f".format(financials.interest_coverage) }}x</td>
            <td>
                {% if financials.interest_coverage >= 5.0 %}
                <span class="badge badge-high">Excellent</span>
                {% elif financials.interest_coverage >= 2.5 %}
                <span class="badge badge-medium">Good</span>
                {% else %}
                <span class="badge badge-low">Risky</span>
                {% endif %}
            </td>
        </tr>
        {% endif %}
    </tbody>
</table>

<h3>Profitability Trends</h3>

<table>
    <thead>
        <tr>
            <th>Metric</th>
            <th class="numeric">Current</th>
            <th class="numeric">5Y Avg</th>
            <th>Trend</th>
        </tr>
    </thead>
    <tbody>
        {% if financials.gross_margin is defined %}
        <tr>
            <td>Gross Margin</td>
            <td class="numeric monospace">{{ "%.1f".format(financials.gross_margin * 100) }}%</td>
            <td class="numeric monospace">{{ "%.1f".format(financials.gross_margin_avg * 100) if financials.gross_margin_avg else '-' }}%</td>
            <td>
                {% if financials.gross_margin_trend == 'up' %}↑{% elif financials.gross_margin_trend == 'down' %}↓{% else %}→{% endif %}
            </td>
        </tr>
        {% endif %}

        {% if financials.operating_margin is defined %}
        <tr>
            <td>Operating Margin</td>
            <td class="numeric monospace">{{ "%.1f".format(financials.operating_margin * 100) }}%</td>
            <td class="numeric monospace">{{ "%.1f".format(financials.operating_margin_avg * 100) if financials.operating_margin_avg else '-' }}%</td>
            <td>
                {% if financials.operating_margin_trend == 'up' %}↑{% elif financials.operating_margin_trend == 'down' %}↓{% else %}→{% endif %}
            </td>
        </tr>
        {% endif %}

        {% if financials.net_margin is defined %}
        <tr>
            <td>Net Profit Margin</td>
            <td class="numeric monospace">{{ "%.1f".format(financials.net_margin * 100) }}%</td>
            <td class="numeric monospace">{{ "%.1f".format(financials.net_margin_avg * 100) if financials.net_margin_avg else '-' }}%</td>
            <td>
                {% if financials.net_margin_trend == 'up' %}↑{% elif financials.net_margin_trend == 'down' %}↓{% else %}→{% endif %}
            </td>
        </tr>
        {% endif %}
    </tbody>
</table>

{% endif %}

<div class="page-break"></div>

<!-- Valuation -->
<h1>Valuation Analysis</h1>

{% if report_data.valuation %}
{% set valuation = report_data.valuation %}

<h2>Intrinsic Value Estimate</h2>

<div style="background: #f8f9fa; padding: 1.5em; border-left: 4px solid #00ACC1; margin: 1em 0;">
    {% if valuation.intrinsic_value is defined %}
    <div style="font-size: 18pt; margin-bottom: 0.5em;">
        Intrinsic Value: <span style="font-weight: 700; color: #00ACC1;">${{ "%.2f".format(valuation.intrinsic_value) }}</span>
    </div>
    {% endif %}

    {% if valuation.current_price is defined %}
    <div style="font-size: 14pt; margin-bottom: 0.5em;">
        Current Price: <span style="font-weight: 600;">${{ "%.2f".format(valuation.current_price) }}</span>
    </div>
    {% endif %}

    {% if valuation.margin_of_safety is defined %}
    <div style="font-size: 14pt;">
        Margin of Safety: <span style="font-weight: 600; {% if valuation.margin_of_safety >= 0.25 %}color: #2e7d32;{% elif valuation.margin_of_safety >= 0 %}color: #f57f17;{% else %}color: #c62828;{% endif %}">
            {{ "%.1f".format(valuation.margin_of_safety * 100) }}%
        </span>
    </div>
    {% endif %}
</div>

<h3>Valuation Multiples</h3>

<table>
    <thead>
        <tr>
            <th>Multiple</th>
            <th class="numeric">Current</th>
            <th class="numeric">Industry Avg</th>
            <th>Assessment</th>
        </tr>
    </thead>
    <tbody>
        {% if valuation.pe_ratio is defined %}
        <tr>
            <td>P/E Ratio</td>
            <td class="numeric monospace">{{ "%.1f".format(valuation.pe_ratio) }}</td>
            <td class="numeric monospace">{{ "%.1f".format(valuation.industry_pe) if valuation.industry_pe else '-' }}</td>
            <td>
                {% if valuation.pe_assessment == 'undervalued' %}
                <span class="badge badge-high">Attractive</span>
                {% elif valuation.pe_assessment == 'fair' %}
                <span class="badge badge-medium">Fair</span>
                {% else %}
                <span class="badge badge-low">Expensive</span>
                {% endif %}
            </td>
        </tr>
        {% endif %}

        {% if valuation.pb_ratio is defined %}
        <tr>
            <td>P/B Ratio</td>
            <td class="numeric monospace">{{ "%.2f".format(valuation.pb_ratio) }}</td>
            <td class="numeric monospace">{{ "%.2f".format(valuation.industry_pb) if valuation.industry_pb else '-' }}</td>
            <td>
                {% if valuation.pb_assessment == 'undervalued' %}
                <span class="badge badge-high">Attractive</span>
                {% elif valuation.pb_assessment == 'fair' %}
                <span class="badge badge-medium">Fair</span>
                {% else %}
                <span class="badge badge-low">Expensive</span>
                {% endif %}
            </td>
        </tr>
        {% endif %}

        {% if valuation.peg_ratio is defined %}
        <tr>
            <td>PEG Ratio</td>
            <td class="numeric monospace">{{ "%.2f".format(valuation.peg_ratio) }}</td>
            <td class="numeric monospace">-</td>
            <td>
                {% if valuation.peg_ratio <= 1.0 %}
                <span class="badge badge-high">Good Value</span>
                {% elif valuation.peg_ratio <= 2.0 %}
                <span class="badge badge-medium">Fair</span>
                {% else %}
                <span class="badge badge-low">Expensive</span>
                {% endif %}
            </td>
        </tr>
        {% endif %}
    </tbody>
</table>

{% endif %}

<div class="page-break"></div>

<!-- Detailed Ratings Breakdown -->
<h1>Detailed Ratings Breakdown</h1>

{% if report_data.ratings %}
{% set ratings = report_data.ratings %}

{% if ratings.dividend_components %}
<h2>Dividend Safety Components</h2>
<ul class="component-list">
    {% for component in ratings.dividend_components %}
    <li class="component-item">
        <span class="component-name">{{ component.name }}</span>
        <span>
            <span class="component-score">{{ "%.1f".format(component.score) }}</span>
            <span class="component-weight">(weight: {{ "%.0f".format(component.weight * 100) }}%)</span>
        </span>
    </li>
    {% endfor %}
</ul>
{% endif %}

{% if ratings.moat_components %}
<h2>Moat Strength Components</h2>
<ul class="component-list">
    {% for component in ratings.moat_components %}
    <li class="component-item">
        <span class="component-name">{{ component.name }}</span>
        <span>
            <span class="component-score">{{ "%.1f".format(component.score) }}</span>
            <span class="component-weight">(weight: {{ "%.0f".format(component.weight * 100) }}%)</span>
        </span>
    </li>
    {% endfor %}
</ul>
{% endif %}

{% if ratings.resilience_components %}
<h2>Resilience Components</h2>
<ul class="component-list">
    {% for component in ratings.resilience_components %}
    <li class="component-item">
        <span class="component-name">{{ component.name }}</span>
        <span>
            <span class="component-score">{{ "%.1f".format(component.score) }}</span>
            <span class="component-weight">(weight: {{ "%.0f".format(component.weight * 100) }}%)</span>
        </span>
    </li>
    {% endfor %}
</ul>
{% endif %}

{% endif %}

<!-- Metadata Footer -->
<div class="metadata-footer">
    {% if report_data._metadata %}
    {% set metadata = report_data._metadata %}

    {% if metadata.pricing_pack_id %}
    <div class="metadata-item">
        <div class="metadata-label">Pricing Pack</div>
        <div class="metadata-value">{{ metadata.pricing_pack_id[:20] }}</div>
    </div>
    {% endif %}

    {% if metadata.ledger_commit_hash %}
    <div class="metadata-item">
        <div class="metadata-label">Ledger Hash</div>
        <div class="metadata-value">{{ metadata.ledger_commit_hash[:12] }}</div>
    </div>
    {% endif %}

    <div class="metadata-item">
        <div class="metadata-label">Generated</div>
        <div class="metadata-value">{{ timestamp[:19] }}</div>
    </div>
    {% endif %}
</div>

{% endblock %}
