================================================================================
REPORTS AGENT - VISUAL ARCHITECTURE & DATA FLOW OVERVIEW
================================================================================

1. HIGH-LEVEL ARCHITECTURE
================================================================================

┌─────────────────────────────────────────────────────────────────────────┐
│                        ReportsAgent (BaseAgent)                         │
│  - get_capabilities() returns ["reports.render_pdf", "reports.export_csv", "reports.export_excel"]
└─────────────────────────────────────────────────────────────────────────┘
         │
         ├─→ reports_render_pdf()      (108 lines, lines 54-161)
         │      ↓
         │   ReportService.render_pdf()
         │      ├── RightsRegistry.ensure_allowed()  [may raise]
         │      ├── Jinja2 Template Rendering
         │      └── WeasyPrint HTML→PDF
         │      ↓ returns: PDF bytes
         │   ↓
         │   base64.b64encode() → "pdf_base64" key
         │
         ├─→ reports_export_csv()      (90 lines, lines 163-252)
         │      ↓
         │   ReportService.generate_csv()
         │      ├── RightsRegistry.check_export()   [returns result]
         │      ├── flatten_dict() recursively
         │      └── csv.writer(StringIO)
         │      ↓ returns: CSV bytes
         │   ↓
         │   base64.b64encode() → "csv_base64" key
         │
         └─→ reports_export_excel()    (29 lines, lines 254-282) [STUB]
                ↓
             Returns: {"status": "not_implemented", ...}


2. DATA FLOW: PDF GENERATION (DETAIL)
================================================================================

Input: RequestCtx + State Dict
  ↓
├─ Extract report_data from state
│  └─ Filter internal keys (starting with "_")
│
├─ Add metadata to report_data
│  ├─ pricing_pack_id
│  ├─ ledger_commit_hash
│  ├─ asof_date
│  └─ user_id
│
├─ Merge additional kwargs
│
├─ Create ReportService instance (NEW each call)
│
├─ Call report_service.render_pdf()
│  ├─ Extract providers from metadata/sources
│  │
│  ├─ RightsRegistry.ensure_allowed()
│  │  └─ MAY RAISE: RightsViolationError
│  │
│  ├─ Enforce rights (filter blocked provider data)
│  │
│  ├─ Generate attribution notices
│  │
│  ├─ Render Jinja2 template
│  │  ├─ Load template file from backend/templates/
│  │  ├─ FALLBACK: Generate simple HTML if template missing
│  │  └─ Returns: HTML string
│  │
│  ├─ Generate PDF
│  │  ├─ WeasyPrint.HTML(string=html_content)
│  │  ├─ Apply font config
│  │  ├─ Apply CSS stylesheets
│  │  ├─ Apply watermark if required
│  │  └─ Returns: PDF bytes
│  │
│  └─ Returns: bytes (PDF or HTML fallback)
│
├─ Base64 encode PDF bytes
│
├─ Collect attributions from rights check
│
├─ Build result dict
│  ├─ pdf_base64 (base64 string)
│  ├─ size_bytes (len(pdf_bytes))
│  ├─ attributions (list)
│  ├─ watermark_applied (bool)
│  ├─ template_name
│  ├─ providers
│  ├─ download_filename
│  ├─ status: "success"
│  └─ generated_at (ISO timestamp)
│
├─ Attach agent metadata
│  └─ _metadata key with agent_name, source, asof, ttl=0
│
Output: Success Dict with all keys above
  OR
Output: Error Dict with {"status": "error", "error": str, ...}


3. DATA FLOW: CSV GENERATION (DETAIL)
================================================================================

Input: RequestCtx + State Dict
  ↓
├─ Extract data from state
│  └─ Filter internal keys (starting with "_")
│
├─ Auto-detect providers (if not provided)
│  ├─ Check metadata.source
│  ├─ Check _sources dict
│  └─ Default to "Manual" if none found
│
├─ Create ReportService instance (NEW each call)
│
├─ Call report_service.generate_csv()
│  ├─ RightsRegistry.check_export()
│  │  └─ Returns result (doesn't raise)
│  │
│  ├─ Create StringIO buffer (in-memory)
│  │
│  ├─ Write CSV.writer to buffer
│  │  ├─ Attribution header comments
│  │  ├─ Flatten nested dict structure
│  │  │  ├─ For nested dicts: "path.to.key"
│  │  │  ├─ For lists: "path[0]", "path[1]", ...
│  │  │  └─ RISK: Circular refs or deep nesting → RecursionError
│  │  │
│  │  └─ Data rows (key, value pairs)
│  │
│  ├─ Encode StringIO to UTF-8 bytes
│  │
│  └─ Returns: bytes (CSV)
│
├─ Base64 encode CSV bytes
│
├─ Collect attributions from rights check
│
├─ Build result dict
│  ├─ csv_base64
│  ├─ size_bytes
│  ├─ attributions
│  ├─ filename
│  ├─ providers
│  ├─ download_filename
│  ├─ status: "success"
│  └─ generated_at
│
├─ Attach agent metadata
│  └─ _metadata key
│
Output: Success Dict
  OR
Output: Error Dict


4. MEMORY CONSUMPTION VISUAL
================================================================================

PDF Generation: 1MB Portfolio Report
┌─────────────────────────────────────────┐
│ Peak Memory Breakdown                   │
├─────────────────────────────────────────┤
│ State dict input:           500 KB       │
│ Metadata additions:          50 KB       │
│ Jinja2 HTML expansion:    1,500 KB  3x  │
│ PDF generation buffer:      400 KB       │
│ Base64 encoding:            533 KB 1.33x│
├─────────────────────────────────────────┤
│ TOTAL PEAK:               2,500 KB       │
│                          ~2.5 MB         │
└─────────────────────────────────────────┘

CSV Generation: 500KB Holdings Data
┌─────────────────────────────────────────┐
│ Peak Memory Breakdown                   │
├─────────────────────────────────────────┤
│ State dict input:           500 KB       │
│ Flatten dict (nested):    1,200 KB  2.4x│
│ CSV StringIO buffer:        800 KB       │
│ Base64 encoding:          1,060 KB 1.33x│
├─────────────────────────────────────────┤
│ TOTAL PEAK:               2,300 KB       │
│                          ~2.3 MB         │
└─────────────────────────────────────────┘


5. RETURN STRUCTURE VISUAL
================================================================================

SUCCESS RESPONSE (PDF Example):
┌────────────────────────────────────────────┐
│ {                                          │
│   "pdf_base64": "JVBERi0xLjQKJeLj..." │
│   "size_bytes": 425687,                    │
│   "attributions": [                        │
│     "Data © FMP",                          │
│     "Data © Polygon",                      │
│     "Generated by DawsOS..."               │
│   ],                                       │
│   "watermark_applied": false,              │
│   "template_name": "portfolio_summary",    │
│   "providers": ["FMP", "Polygon"],         │
│   "download_filename": "portfolio_...",    │
│   "status": "success",                     │
│   "generated_at": "2025-11-03T16:06...",   │
│   "_metadata": {                           │
│     "agent_name": "reports_agent",         │
│     "source": "report_service:fmp_v1",     │
│     "asof": "2025-11-02",                  │
│     "ttl": 0,                              │
│     "confidence": null                     │
│   }                                        │
│ }                                          │
└────────────────────────────────────────────┘

ERROR RESPONSE:
┌────────────────────────────────────────────┐
│ {                                          │
│   "status": "error",                       │
│   "error": "WeasyPrint rendering failed:..│
│   "template_name": "portfolio_summary",    │
│   "pdf_base64": null                       │
│ }                                          │
│ (NO _metadata attached)                    │
└────────────────────────────────────────────┘


6. EXCEPTION HANDLING PATHS
================================================================================

PDF/CSV Exception Handler (Identical Pattern):
┌─────────────────────────────────────────────────┐
│ try:                                            │
│    pdf_bytes = await report_service.render_pdf()│
│    # ... build success result ...               │
│    return success_dict                          │
├─────────────────────────────────────────────────┤
│ except Exception as e:                          │
│    logger.error(f"X generation failed: {e}", ...) │
│    return error_dict                            │
└─────────────────────────────────────────────────┘

Exception Types Caught:
  • RightsViolationError (rights denied)
  • ServiceError (WeasyPrint/generation failures)
  • FileNotFoundError (template not found)
  • TemplateError (Jinja2 rendering)
  • RecursionError (deep nesting in CSV - RISK)
  • AttributeError (malformed data)
  • MemoryError (large exports - NO PROTECTION)

Issue: All exceptions treated identically
       (no distinction between recoverable/fatal)


7. RIGHTS ENFORCEMENT FLOW
================================================================================

PDF Method:
  ├─ report_service.render_pdf()
  │  ├─ RightsRegistry.ensure_allowed()  [STRICT]
  │  │  └─ IF blocked: RAISES RightsViolationError
  │  └─ Exception bubbles up
  └─ Caught by broad except, returns error_dict

CSV Method:
  ├─ report_service.generate_csv()
  │  ├─ RightsRegistry.check_export()   [PERMISSIVE]
  │  │  └─ IF blocked: Returns result with blocked_providers list
  │  └─ Continues (may generate CSV with filtered data)
  └─ No exception, returns success_dict

INCONSISTENCY: PDF raises on blocked rights, CSV doesn't
IMPACT: CSV could theoretically generate without proper authorization


8. RESOURCE LIMITS VISUAL
================================================================================

Current State (NO LIMITS):
┌─────────────────────────────────────────┐
│ Requested → Generate → Return            │
│ (any size)   (any time)   (any size)     │
│             ⚠️ RISK      ⚠️ RISK         │
│         Timeout?      Memory?            │
│         None!         No limit!          │
└─────────────────────────────────────────┘

Recommended (Week 5):
┌─────────────────────────────────────────┐
│ Requested → [SIZE CHECK] → Generate      │
│            PDF≤50MB      (with timeout)  │
│            CSV≤10MB      ┌──────────┐    │
│            XLSX≤20MB     │wait_for()│    │
│                          │ 30s      │    │
│                          └──────────┘    │
│                             ↓            │
│                          Returns/Error   │
└─────────────────────────────────────────┘


9. SERVICE INSTANTIATION PATTERN
================================================================================

Current (NEW Instance Per Call):
┌─────────────────────────────────────────┐
│ reports_render_pdf()                    │
│  ├─ ReportService(env=...) ← NEW INSTANCE
│  ├─ Jinja2 env loaded                   │
│  ├─ RightsRegistry loaded                │
│  └─ Return                              │
│                                         │
│ reports_export_csv()                    │
│  ├─ ReportService(env=...) ← NEW INSTANCE
│  ├─ Jinja2 env loaded (wasteful)        │
│  ├─ RightsRegistry loaded (singleton)   │
│  └─ Return                              │
└─────────────────────────────────────────┘
⚠️ Jinja2 environment rebuilt each call

Recommended (Singleton):
┌─────────────────────────────────────────┐
│ ReportService._instance (class var)     │
│  ├─ Jinja2 env (loaded once)            │
│  ├─ RightsRegistry (singleton)          │
│  └─ Reused by all methods               │
│                                         │
│ reports_render_pdf()                    │
│  ├─ Get singleton instance              │
│  └─ Use existing Jinja2 env             │
│                                         │
│ reports_export_csv()                    │
│  ├─ Get singleton instance              │
│  └─ Use existing Jinja2 env             │
└─────────────────────────────────────────┘
✓ Jinja2 env created once (better performance)


10. BASE64 ENCODING OVERHEAD
================================================================================

Cost-Benefit Analysis:

COST: 33% Memory Overhead
  ┌──────────────────────────┐
  │ PDF bytes:       100 KB   │
  │ After base64:    133 KB   │
  │ Overhead:         33 KB   │
  └──────────────────────────┘

WHY USED: Transport over JSON APIs
  Client receives: {"pdf_base64": "JVBERi0xLjQK..."}
  
RECOMMENDATION: 
  Keep base64 for API responses
  But return raw bytes internally
  Let HTTP layer handle encoding


11. CODE QUALITY SCORECARD
================================================================================

                          STRENGTH    WEAKNESS
                          --------    --------
Rights Enforcement        ✓ Good      
Async/Await Patterns      ✓ Correct   
Logging Coverage          ✓ Good      
Error Handling                        ✗ Too broad
Input Validation                      ✗ Minimal
Resource Limits                       ✗ None
Timeout Protection                    ✗ None
File I/O                  ✓ In-memory 
Template System           ✓ Fallback  
Provider Detection        ✓ Heuristic
Memory Efficiency                     ✗ 33% overhead
Code Duplication                      ✗ PDF/CSV similar
Service Pooling                       ✗ New per call

OVERALL: 6/12 strengths = 50% quality
ASSESSMENT: Production-ready with guardrails needed


12. WEEK 5 CONSOLIDATION: BEFORE & AFTER
================================================================================

BEFORE (Current):
┌─────────────────────┐  ┌─────────────────────┐  ┌─────────────────┐
│  ReportsAgent       │  │  ReportsAgent       │  │  ReportsAgent   │
│ .render_pdf()       │  │ .export_csv()       │  │ .export_excel() │
│ 108 lines           │  │ 90 lines            │  │ 29 lines (stub) │
│ Duplicated logic    │  │ Duplicated logic    │  │ Not implemented │
└──────────┬──────────┘  └──────────┬──────────┘  └────────┬────────┘
           │                       │                      │
           └───────────┬───────────┴──────────┬───────────┘
                       │                      │
              ReportService    ← Separate instance per call
              (no pooling)      ← No timeout protection
                                ← No size limits


AFTER (Proposed DataHarvester):
┌──────────────────────────────────────────────────────────┐
│           DataHarvester                                  │
│                                                          │
│  async def export(                                       │
│      format: str,      # "pdf", "csv", "excel"           │
│      data: Dict,                                         │
│      **options                                           │
│  ) -> bytes:           # Raw bytes (HTTP encodes)        │
│      # Single unified interface                          │
│      # Resource guards (size, timeout, memory)           │
│      # Singleton ReportService                          │
│      # Consistent error handling                         │
│      # Metrics collection                                │
│                                                          │
└──────────────────────────────────────────────────────────┘

Benefits:
  ✓ No code duplication
  ✓ Unified error handling
  ✓ Resource protection
  ✓ Better observability
  ✓ Easier Excel integration

================================================================================
