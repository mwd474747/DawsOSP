<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>API Client Enhancement Test Suite</title>
    <script src="https://unpkg.com/axios@1.6.2/dist/axios.min.js"></script>
    <style>
        body {
            font-family: monospace;
            padding: 20px;
            background: #1a1a1a;
            color: #e0e0e0;
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #444;
            border-radius: 5px;
        }
        .test-title {
            font-size: 18px;
            font-weight: bold;
            color: #4CAF50;
            margin-bottom: 10px;
        }
        .test-result {
            margin: 10px 0;
            padding: 10px;
            border-radius: 3px;
        }
        .success {
            background: rgba(76, 175, 80, 0.2);
            color: #4CAF50;
        }
        .error {
            background: rgba(244, 67, 54, 0.2);
            color: #f44336;
        }
        .info {
            background: rgba(33, 150, 243, 0.2);
            color: #2196F3;
        }
        button {
            padding: 10px 20px;
            margin: 5px;
            background: #2196F3;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
        }
        button:hover {
            background: #1976D2;
        }
        .log-entry {
            margin: 5px 0;
            padding: 5px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 3px;
        }
        pre {
            background: rgba(0, 0, 0, 0.5);
            padding: 10px;
            border-radius: 3px;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <h1>API Client Enhancement Test Suite</h1>
    
    <div class="test-section">
        <div class="test-title">Test Configuration</div>
        <button onclick="testTokenRefresh()">Test Token Refresh Logic</button>
        <button onclick="testRetryMechanism()">Test Retry Mechanism</button>
        <button onclick="testErrorHandling()">Test Error Handling</button>
        <button onclick="testSimultaneousRefresh()">Test Simultaneous Refresh Prevention</button>
        <button onclick="runAllTests()">Run All Tests</button>
        <button onclick="clearLogs()">Clear Logs</button>
    </div>
    
    <div id="test-results" class="test-section">
        <div class="test-title">Test Results</div>
        <div id="results-container"></div>
    </div>

    <script>
        // Import the enhanced API client code
        const API_BASE = '';
        
        // Copy of the TokenManager from full_ui_fixed.html with test modifications
        const TokenManager = {
            getToken: () => localStorage.getItem('test_access_token'),
            setToken: (token) => localStorage.setItem('test_access_token', token),
            removeToken: () => localStorage.removeItem('test_access_token'),
            
            refreshPromise: null,
            refreshAttempts: 0,
            
            async performTokenRefresh() {
                this.refreshAttempts++;
                logMessage(`Token refresh attempt #${this.refreshAttempts}`, 'info');
                
                // Simulate token refresh with a delay
                return new Promise((resolve) => {
                    setTimeout(() => {
                        const newToken = 'refreshed_token_' + Date.now();
                        this.setToken(newToken);
                        logMessage(`Token refreshed successfully: ${newToken.substring(0, 20)}...`, 'success');
                        resolve(newToken);
                    }, 1000);
                });
            },
            
            async refreshToken() {
                if (this.refreshPromise) {
                    logMessage('Reusing existing refresh promise (preventing simultaneous refresh)', 'info');
                    return this.refreshPromise;
                }
                
                this.refreshPromise = this.performTokenRefresh();
                
                try {
                    const token = await this.refreshPromise;
                    return token;
                } finally {
                    this.refreshPromise = null;
                }
            }
        };
        
        // Enhanced error handler
        const handleApiError = (error) => {
            if (error.response) {
                return {
                    type: 'server',
                    message: error.response.data?.detail || error.response.data?.message || 'Server error',
                    code: error.response.status,
                    details: error.response.data,
                };
            } else if (error.request) {
                return {
                    type: 'network',
                    message: 'Network error - please check your connection',
                    code: 'NETWORK_ERROR',
                };
            } else {
                return {
                    type: 'unknown',
                    message: error.message || 'An unexpected error occurred',
                    code: 'UNKNOWN_ERROR',
                };
            }
        };
        
        // Retry configuration
        const retryConfig = {
            maxRetries: 3,
            shouldRetry: (error, attemptNumber) => {
                if (error.response?.status >= 400 && error.response?.status < 500 && error.response?.status !== 401) {
                    return false;
                }
                return attemptNumber < retryConfig.maxRetries;
            },
            getRetryDelay: (attemptNumber) => {
                return Math.min(1000 * Math.pow(2, attemptNumber - 1), 30000);
            }
        };
        
        // Create a test instance of axios with interceptors
        const testAxios = axios.create({
            baseURL: API_BASE,
            timeout: 30000
        });
        
        // Request interceptor
        testAxios.interceptors.request.use(
            config => {
                const token = TokenManager.getToken();
                if (token) {
                    config.headers.Authorization = `Bearer ${token}`;
                    logMessage(`Request sent with token: ${token.substring(0, 20)}...`, 'info');
                }
                
                if (!config._retryCount) {
                    config._retryCount = 0;
                }
                
                return config;
            },
            error => Promise.reject(error)
        );
        
        // Response interceptor with retry and refresh logic
        testAxios.interceptors.response.use(
            response => response,
            async error => {
                const originalRequest = error.config;
                
                // Handle 401 errors
                if (error.response?.status === 401 && !originalRequest._retry) {
                    logMessage('401 Unauthorized - attempting token refresh', 'info');
                    originalRequest._retry = true;
                    
                    try {
                        const newToken = await TokenManager.refreshToken();
                        
                        if (newToken) {
                            originalRequest.headers.Authorization = `Bearer ${newToken}`;
                            logMessage('Retrying original request with new token', 'info');
                            return testAxios(originalRequest);
                        }
                    } catch (refreshError) {
                        logMessage('Token refresh failed', 'error');
                        return Promise.reject(refreshError);
                    }
                }
                
                // Handle other errors with retry logic
                if (error.response?.status !== 401 && originalRequest._retryCount < retryConfig.maxRetries) {
                    if (retryConfig.shouldRetry(error, originalRequest._retryCount + 1)) {
                        originalRequest._retryCount++;
                        
                        const delay = retryConfig.getRetryDelay(originalRequest._retryCount);
                        logMessage(`Retrying request (attempt ${originalRequest._retryCount}/${retryConfig.maxRetries}) after ${delay}ms`, 'info');
                        
                        await new Promise(resolve => setTimeout(resolve, delay));
                        
                        return testAxios(originalRequest);
                    }
                }
                
                const enhancedError = handleApiError(error);
                error.enhancedError = enhancedError;
                
                logMessage(`Request failed: ${enhancedError.message} (${enhancedError.type})`, 'error');
                
                return Promise.reject(error);
            }
        );
        
        // Utility functions
        function logMessage(message, type = 'info') {
            const container = document.getElementById('results-container');
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            entry.innerHTML = `[${new Date().toLocaleTimeString()}] ${message}`;
            container.appendChild(entry);
        }
        
        function clearLogs() {
            document.getElementById('results-container').innerHTML = '';
            TokenManager.refreshAttempts = 0;
        }
        
        // Test functions
        async function testTokenRefresh() {
            logMessage('=== Testing Token Refresh Logic ===', 'info');
            
            // Set an initial token
            TokenManager.setToken('initial_token_123');
            
            // Mock server to return 401
            const mockAdapter = {
                request: () => Promise.reject({
                    response: { status: 401, data: { message: 'Token expired' } },
                    config: { url: '/test/endpoint' }
                })
            };
            
            try {
                // This should trigger token refresh
                await testAxios.get('/health');
            } catch (error) {
                // Expected to fail for this test
            }
            
            logMessage('Token refresh test completed', 'success');
        }
        
        async function testRetryMechanism() {
            logMessage('=== Testing Retry Mechanism ===', 'info');
            
            let attempts = 0;
            
            // Create a mock interceptor to simulate server errors
            testAxios.interceptors.response.use(
                null,
                error => {
                    if (error.config.url === '/test-retry' && attempts < 2) {
                        attempts++;
                        error.response = { status: 503, data: { message: 'Service unavailable' } };
                    }
                    return Promise.reject(error);
                }
            );
            
            try {
                await testAxios.get('/test-retry');
            } catch (error) {
                logMessage(`Request failed after ${attempts} retry attempts`, 'info');
            }
            
            logMessage('Retry mechanism test completed', 'success');
        }
        
        function testErrorHandling() {
            logMessage('=== Testing Error Handling ===', 'info');
            
            // Test server error
            const serverError = {
                response: { status: 500, data: { message: 'Internal server error' } }
            };
            const serverResult = handleApiError(serverError);
            logMessage(`Server error: ${JSON.stringify(serverResult)}`, 'info');
            
            // Test network error
            const networkError = {
                request: {}
            };
            const networkResult = handleApiError(networkError);
            logMessage(`Network error: ${JSON.stringify(networkResult)}`, 'info');
            
            // Test unknown error
            const unknownError = {
                message: 'Something went wrong'
            };
            const unknownResult = handleApiError(unknownError);
            logMessage(`Unknown error: ${JSON.stringify(unknownResult)}`, 'info');
            
            logMessage('Error handling test completed', 'success');
        }
        
        async function testSimultaneousRefresh() {
            logMessage('=== Testing Simultaneous Refresh Prevention ===', 'info');
            
            TokenManager.refreshAttempts = 0;
            
            // Trigger multiple simultaneous refresh attempts
            const promises = [
                TokenManager.refreshToken(),
                TokenManager.refreshToken(),
                TokenManager.refreshToken()
            ];
            
            await Promise.all(promises);
            
            logMessage(`Total refresh attempts: ${TokenManager.refreshAttempts} (should be 1)`, 
                TokenManager.refreshAttempts === 1 ? 'success' : 'error');
            
            logMessage('Simultaneous refresh test completed', 'success');
        }
        
        async function runAllTests() {
            clearLogs();
            logMessage('=== Running All Tests ===', 'info');
            
            await testTokenRefresh();
            await testRetryMechanism();
            testErrorHandling();
            await testSimultaneousRefresh();
            
            logMessage('=== All Tests Completed ===', 'success');
        }
        
        // Display initial message
        logMessage('API Client Enhancement Test Suite Ready', 'success');
        logMessage('Click the buttons above to run individual tests or all tests', 'info');
    </script>
</body>
</html>