<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DawsOS Portfolio Intelligence</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container { max-width: 1600px; margin: 0 auto; padding: 1rem; }
        
        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }
        
        .header h1 {
            font-size: 2.5rem;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 0.5rem;
        }
        
        .header p { color: #666; font-size: 1.1rem; }
        
        .auth-section {
            background: white;
            border-radius: 20px;
            padding: 2rem;
            max-width: 400px;
            margin: 2rem auto;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }
        
        .auth-section h2 { margin-bottom: 1.5rem; color: #333; }
        
        .form-group { margin-bottom: 1.5rem; }
        
        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            color: #555;
            font-weight: 500;
        }
        
        .form-group input {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 1rem;
            transition: border-color 0.3s;
        }
        
        .form-group input:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .btn {
            width: 100%;
            padding: 1rem;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.3s, box-shadow 0.3s;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.4);
        }
        
        .dashboard { display: none; }
        .dashboard.active { display: block; }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .stat-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 1.5rem;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            transition: transform 0.3s, box-shadow 0.3s;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(0,0,0,0.15);
        }
        
        .stat-label {
            color: #666;
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
        }
        
        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            color: #333;
        }
        
        .stat-value.positive { color: #10b981; }
        .stat-value.negative { color: #ef4444; }
        
        .feature-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 1.5rem;
            margin-top: 2rem;
        }
        
        .feature-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 2rem;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            transition: all 0.3s;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }
        
        .feature-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 3px;
            background: linear-gradient(90deg, #667eea, #764ba2);
            transform: scaleX(0);
            transform-origin: left;
            transition: transform 0.3s;
        }
        
        .feature-card:hover::before { transform: scaleX(1); }
        
        .feature-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(0,0,0,0.15);
        }
        
        .feature-icon {
            width: 60px;
            height: 60px;
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            margin-bottom: 1rem;
        }
        
        .feature-card h3 {
            margin-bottom: 0.5rem;
            color: #333;
        }
        
        .feature-card p {
            color: #666;
            line-height: 1.6;
        }
        
        .holdings-table {
            background: white;
            border-radius: 20px;
            padding: 2rem;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            margin-top: 2rem;
        }
        
        .holdings-table h3 {
            margin-bottom: 1.5rem;
            color: #333;
        }
        
        .table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .table th {
            text-align: left;
            padding: 1rem;
            border-bottom: 2px solid #e0e0e0;
            color: #666;
            font-weight: 600;
        }
        
        .table td {
            padding: 1rem;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .table tr:hover {
            background: rgba(102, 126, 234, 0.05);
        }
        
        .scenario-section {
            display: none;
            background: white;
            border-radius: 20px;
            padding: 2rem;
            margin-top: 2rem;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        
        .scenario-section.active { display: block; }
        
        .scenario-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-top: 1.5rem;
        }
        
        .scenario-card {
            border: 2px solid #e0e0e0;
            border-radius: 15px;
            padding: 1.5rem;
            transition: all 0.3s;
            cursor: pointer;
        }
        
        .scenario-card:hover {
            border-color: #667eea;
            background: rgba(102, 126, 234, 0.05);
        }
        
        .logout-btn {
            position: absolute;
            top: 2rem;
            right: 2rem;
            padding: 0.75rem 1.5rem;
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid white;
            color: white;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }
        
        .logout-btn:hover {
            background: white;
            color: #764ba2;
        }
        
        .error-message {
            color: #ef4444;
            margin-top: 1rem;
            text-align: center;
            font-size: 0.9rem;
        }
        
        .success-message {
            color: #10b981;
            margin-top: 1rem;
            text-align: center;
            font-size: 0.9rem;
        }
        
        .loading {
            text-align: center;
            padding: 2rem;
            color: #666;
        }
        
        .tabs {
            display: flex;
            gap: 1rem;
            margin: 2rem 0;
            background: white;
            border-radius: 15px;
            padding: 0.5rem;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        }
        
        .tab {
            padding: 0.75rem 1.5rem;
            background: transparent;
            border: none;
            border-radius: 10px;
            color: #666;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s;
        }
        
        .tab.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        .alerts-container {
            background: white;
            border-radius: 20px;
            padding: 2rem;
            margin-top: 2rem;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        
        .alert-item {
            padding: 1rem;
            border-left: 4px solid #667eea;
            background: #f8f9fa;
            margin-bottom: 1rem;
            border-radius: 8px;
        }
        
        .ai-analysis {
            background: white;
            border-radius: 20px;
            padding: 2rem;
            margin-top: 2rem;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        
        .ai-input {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }
        
        .ai-input input {
            flex: 1;
            padding: 0.75rem;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 1rem;
        }
        
        .ai-input button {
            padding: 0.75rem 2rem;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 500;
        }
        
        .ai-response {
            background: #f8f9fa;
            padding: 1.5rem;
            border-radius: 10px;
            min-height: 100px;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .loading-pulse { animation: pulse 2s infinite; }
        
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        @keyframes slideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }
        
        /* Macro Dashboard Enhancements */
        #macro-tab .card {
            transition: transform 0.3s ease;
        }
        
        #macro-tab .card:hover {
            transform: translateY(-2px);
        }
        
        /* Progress bar animations */
        #gini-bar, #polarization-bar, #civil-war-bar {
            transition: width 1s ease-in-out;
        }
        
        /* Leading indicators pulse effect */
        #leading-indicators-section {
            animation: pulse-border 2s infinite;
        }
        
        @keyframes pulse-border {
            0% { border-color: rgba(245, 158, 11, 0.3); }
            50% { border-color: rgba(245, 158, 11, 0.6); }
            100% { border-color: rgba(245, 158, 11, 0.3); }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>DawsOS Portfolio Intelligence</h1>
            <p>Advanced AI-Powered Portfolio Management Platform</p>
        </div>

        <button class="logout-btn" id="logoutBtn" style="display: none;">Logout</button>

        <!-- Login Section -->
        <div class="auth-section" id="authSection">
            <h2>Login to Your Account</h2>
            <form id="loginForm">
                <div class="form-group">
                    <label>Email Address</label>
                    <input type="email" id="email" value="michael@dawsos.com" required>
                </div>
                <div class="form-group">
                    <label>Password</label>
                    <input type="password" id="password" placeholder="Enter password (admin123)" required>
                </div>
                <button type="submit" class="btn">Login</button>
                <div class="error-message" id="errorMessage"></div>
                <div class="success-message" id="successMessage"></div>
            </form>
        </div>

        <!-- Dashboard Section -->
        <div class="dashboard" id="dashboard">
            <!-- Tabs Navigation -->
            <div class="tabs">
                <button class="tab active" onclick="showTab('overview')">Overview</button>
                <button class="tab" onclick="showTab('holdings')">Holdings</button>
                <button class="tab" onclick="showTab('transactions')">Transactions</button>
                <button class="tab" onclick="showTab('scenarios')">Scenarios</button>
                <button class="tab" onclick="showTab('alerts')">Alerts</button>
                <button class="tab" onclick="showTab('ai')">AI Analysis</button>
                <button class="tab" onclick="showTab('optimize')">Optimize</button>
                <button class="tab" onclick="showTab('macro')">Macro Dashboard</button>
            </div>

            <!-- Overview Tab -->
            <div class="tab-content active" id="overview-tab">
                <!-- Export Dropdown -->
                <div style="display: flex; justify-content: flex-end; margin-bottom: 1.5rem; position: relative;">
                    <div class="dropdown">
                        <button onclick="toggleDropdown()" style="
                            padding: 0.75rem 1.5rem;
                            background: linear-gradient(135deg, #667eea, #764ba2);
                            color: white;
                            border: none;
                            border-radius: 10px;
                            font-weight: 600;
                            cursor: pointer;
                            display: flex;
                            align-items: center;
                            gap: 0.5rem;
                        ">
                            üì• Export
                            <span style="font-size: 0.8rem;">‚ñº</span>
                        </button>
                        <div id="exportDropdown" style="
                            display: none;
                            position: absolute;
                            top: 100%;
                            right: 0;
                            margin-top: 0.5rem;
                            background: white;
                            border-radius: 10px;
                            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
                            min-width: 200px;
                            z-index: 100;
                        ">
                            <a onclick="exportData('pdf')" style="display: block; padding: 0.75rem 1rem; color: #333; cursor: pointer; border-bottom: 1px solid #f0f0f0; hover: background: #f8f9fa;">üìÑ Export as PDF</a>
                            <a onclick="exportData('csv', 'holdings')" style="display: block; padding: 0.75rem 1rem; color: #333; cursor: pointer; border-bottom: 1px solid #f0f0f0;">üìä Export Holdings (CSV)</a>
                            <a onclick="exportData('csv', 'transactions')" style="display: block; padding: 0.75rem 1rem; color: #333; cursor: pointer;">üìà Export Transactions (CSV)</a>
                        </div>
                    </div>
                </div>
                
                <div class="stats-grid" id="statsGrid">
                    <div class="stat-card">
                        <div class="stat-label">Total Portfolio Value</div>
                        <div class="stat-value" id="totalValue">Loading...</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Unrealized P&L</div>
                        <div class="stat-value" id="unrealizedPnl">Loading...</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Day Return</div>
                        <div class="stat-value" id="dayReturn">Loading...</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">YTD Return</div>
                        <div class="stat-value" id="ytdReturn">Loading...</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Portfolio Beta</div>
                        <div class="stat-value" id="portfolioBeta">Loading...</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Sharpe Ratio</div>
                        <div class="stat-value" id="sharpeRatio">Loading...</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Value at Risk (95%)</div>
                        <div class="stat-value" id="var95">Loading...</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Max Drawdown</div>
                        <div class="stat-value" id="maxDrawdown">Loading...</div>
                    </div>
                </div>

                <div class="feature-grid">
                    <div class="feature-card" onclick="showTab('scenarios')">
                        <div class="feature-icon" style="background: linear-gradient(135deg, #667eea, #764ba2); color: white;">üìä</div>
                        <h3>Scenario Analysis</h3>
                        <p>Test your portfolio against market scenarios and stress conditions to understand risk exposure.</p>
                    </div>
                    <div class="feature-card" onclick="showTab('ai')">
                        <div class="feature-icon" style="background: linear-gradient(135deg, #10b981, #059669); color: white;">ü§ñ</div>
                        <h3>AI Analysis</h3>
                        <p>Get AI-powered insights and recommendations for your portfolio using Claude.</p>
                    </div>
                    <div class="feature-card" onclick="loadMacro()">
                        <div class="feature-icon" style="background: linear-gradient(135deg, #f59e0b, #d97706); color: white;">üåç</div>
                        <h3>Macro Insights</h3>
                        <p>Track economic indicators and market regimes to make informed investment decisions.</p>
                    </div>
                    <div class="feature-card" onclick="showTab('optimize')">
                        <div class="feature-icon" style="background: linear-gradient(135deg, #ef4444, #dc2626); color: white;">‚ö°</div>
                        <h3>Portfolio Optimization</h3>
                        <p>Get rebalancing recommendations based on mean-variance optimization.</p>
                    </div>
                </div>
            </div>

            <!-- Holdings Tab -->
            <div class="tab-content" id="holdings-tab">
                <div class="holdings-table">
                    <h3>Portfolio Holdings</h3>
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Symbol</th>
                                <th>Quantity</th>
                                <th>Price</th>
                                <th>Value</th>
                                <th>Weight</th>
                                <th>Daily Change</th>
                                <th>Beta</th>
                            </tr>
                        </thead>
                        <tbody id="holdingsBody">
                            <tr><td colspan="7" class="loading">Loading holdings...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Transactions Tab -->
            <div class="tab-content" id="transactions-tab">
                <div class="holdings-table">
                    <h3>Transaction History</h3>
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <div id="transactionSummary" style="display: flex; gap: 2rem; color: #666;">
                            <span>Total Invested: <strong id="totalInvested">Loading...</strong></span>
                            <span>Total Dividends: <strong id="totalDividends">Loading...</strong></span>
                            <span>Realized Gains: <strong id="realizedGains">Loading...</strong></span>
                        </div>
                        <div id="paginationControls" style="display: flex; gap: 1rem; align-items: center;">
                            <button onclick="prevPage()" id="prevBtn" style="padding: 0.5rem 1rem; background: #667eea; color: white; border: none; border-radius: 8px; cursor: pointer;">Previous</button>
                            <span id="pageInfo">Page 1 of 1</span>
                            <button onclick="nextPage()" id="nextBtn" style="padding: 0.5rem 1rem; background: #667eea; color: white; border: none; border-radius: 8px; cursor: pointer;">Next</button>
                        </div>
                    </div>
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Type</th>
                                <th>Symbol</th>
                                <th>Shares</th>
                                <th>Price</th>
                                <th>Amount</th>
                                <th>Gain/Loss</th>
                            </tr>
                        </thead>
                        <tbody id="transactionsBody">
                            <tr><td colspan="7" class="loading">Loading transactions...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Scenarios Tab -->
            <div class="tab-content" id="scenarios-tab">
                <div class="scenario-section active">
                    <h3>Scenario Analysis</h3>
                    <p style="color: #666; margin-bottom: 1rem;">Test your portfolio against market scenarios with macro-aware AI</p>
                    
                    <!-- Macro Context Bar -->
                    <div style="background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 1rem; border-radius: 12px; margin-bottom: 1.5rem;">
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; text-align: center;">
                            <div>
                                <div style="font-size: 0.85rem; opacity: 0.9;">Current Regime</div>
                                <div style="font-size: 1.2rem; font-weight: bold;" id="scenarioRegime">Loading...</div>
                            </div>
                            <div>
                                <div style="font-size: 0.85rem; opacity: 0.9;">STDC Phase</div>
                                <div style="font-size: 1.2rem; font-weight: bold;" id="scenarioStdc">Loading...</div>
                            </div>
                            <div>
                                <div style="font-size: 0.85rem; opacity: 0.9;">LTDC Phase</div>
                                <div style="font-size: 1.2rem; font-weight: bold;" id="scenarioLtdc">Loading...</div>
                            </div>
                            <div>
                                <div style="font-size: 0.85rem; opacity: 0.9;">Risk Level</div>
                                <div style="font-size: 1.2rem; font-weight: bold;" id="scenarioRisk">Loading...</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Scenario Selection Grid -->
                    <div class="scenario-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
                        <div class="scenario-card" onclick="runScenario('market_crash')" style="background: linear-gradient(135deg, #f44336, #d32f2f); color: white; padding: 1.5rem; border-radius: 12px; cursor: pointer; transition: all 0.3s;">
                            <h4 style="margin-bottom: 0.5rem;">üìâ Market Crash</h4>
                            <p style="font-size: 0.9rem; opacity: 0.95;">-20% Equity Shock</p>
                        </div>
                        <div class="scenario-card" onclick="runScenario('interest_rate')" style="background: linear-gradient(135deg, #ff9800, #f57c00); color: white; padding: 1.5rem; border-radius: 12px; cursor: pointer; transition: all 0.3s;">
                            <h4 style="margin-bottom: 0.5rem;">üìä Rate Hike</h4>
                            <p style="font-size: 0.9rem; opacity: 0.95;">+2% Interest Rates</p>
                        </div>
                        <div class="scenario-card" onclick="runScenario('inflation')" style="background: linear-gradient(135deg, #ffc107, #f9a825); color: white; padding: 1.5rem; border-radius: 12px; cursor: pointer; transition: all 0.3s;">
                            <h4 style="margin-bottom: 0.5rem;">üí∏ High Inflation</h4>
                            <p style="font-size: 0.9rem; opacity: 0.95;">6%+ CPI Shock</p>
                        </div>
                        <div class="scenario-card" onclick="runScenario('tech_crash')" style="background: linear-gradient(135deg, #9c27b0, #7b1fa2); color: white; padding: 1.5rem; border-radius: 12px; cursor: pointer; transition: all 0.3s;">
                            <h4 style="margin-bottom: 0.5rem;">üíª Tech Crash</h4>
                            <p style="font-size: 0.9rem; opacity: 0.95;">-30% Tech Sector</p>
                        </div>
                        <div class="scenario-card" onclick="runScenario('recovery')" style="background: linear-gradient(135deg, #4caf50, #388e3c); color: white; padding: 1.5rem; border-radius: 12px; cursor: pointer; transition: all 0.3s;">
                            <h4 style="margin-bottom: 0.5rem;">üìà Recovery Rally</h4>
                            <p style="font-size: 0.9rem; opacity: 0.95;">+15% Risk-On</p>
                        </div>
                        <div class="scenario-card" onclick="runScenario('credit_crunch')" style="background: linear-gradient(135deg, #795548, #5d4037); color: white; padding: 1.5rem; border-radius: 12px; cursor: pointer; transition: all 0.3s;">
                            <h4 style="margin-bottom: 0.5rem;">üè¶ Credit Crunch</h4>
                            <p style="font-size: 0.9rem; opacity: 0.95;">Spreads Widen</p>
                        </div>
                    </div>
                    
                    <!-- Loading Indicator -->
                    <div id="scenarioLoading" style="display: none; text-align: center; padding: 2rem;">
                        <div style="width: 40px; height: 40px; border: 3px solid #f3f3f3; border-top: 3px solid #667eea; border-radius: 50%; margin: 0 auto; animation: spin 1s linear infinite;"></div>
                        <p style="margin-top: 1rem; color: #666;">Analyzing scenario with macro adjustments...</p>
                    </div>
                    
                    <!-- Results Section -->
                    <div id="scenarioResults" style="margin-top: 2rem; display: none;">
                        <!-- Results will be dynamically populated here -->
                    </div>
                </div>
            </div>

            <!-- Alerts Tab -->
            <div class="tab-content" id="alerts-tab">
                <div class="alerts-container">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                        <h3>Alert Management <span id="alertCount" style="background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.9rem; margin-left: 1rem;">0</span></h3>
                        <button onclick="toggleCreateAlertForm()" style="padding: 0.75rem 1.5rem; background: linear-gradient(135deg, #667eea, #764ba2); color: white; border: none; border-radius: 10px; cursor: pointer; font-weight: 600;">
                            + New Alert
                        </button>
                    </div>
                    
                    <!-- Create New Alert Form -->
                    <div id="createAlertForm" style="display: none; background: rgba(102, 126, 234, 0.1); padding: 1.5rem; border-radius: 15px; margin-bottom: 2rem;">
                        <h4 style="margin-bottom: 1.5rem;">Create New Alert</h4>
                        <div style="display: grid; gap: 1rem;">
                            <div>
                                <label style="display: block; margin-bottom: 0.5rem; color: #666;">Alert Type</label>
                                <select id="alertType" onchange="updateAlertForm()" style="width: 100%; padding: 0.75rem; border: 2px solid #e0e0e0; border-radius: 8px;">
                                    <option value="price">üíπ Price Alert</option>
                                    <option value="portfolio">üìä Portfolio Alert</option>
                                    <option value="macro">üåç Macro Alert</option>
                                </select>
                            </div>
                            
                            <!-- Dynamic fields based on type -->
                            <div id="alertTypeFields">
                                <!-- Price Alert Fields (default) -->
                                <div id="priceFields">
                                    <div style="margin-bottom: 1rem;">
                                        <label style="display: block; margin-bottom: 0.5rem; color: #666;">Symbol</label>
                                        <select id="alertSymbol" style="width: 100%; padding: 0.75rem; border: 2px solid #e0e0e0; border-radius: 8px;">
                                            <option value="AAPL">AAPL - Apple</option>
                                            <option value="GOOGL">GOOGL - Google</option>
                                            <option value="MSFT">MSFT - Microsoft</option>
                                            <option value="AMZN">AMZN - Amazon</option>
                                            <option value="NVDA">NVDA - NVIDIA</option>
                                            <option value="TSLA">TSLA - Tesla</option>
                                            <option value="META">META - Meta</option>
                                            <option value="BRK.B">BRK.B - Berkshire</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <!-- Portfolio Alert Fields (hidden by default) -->
                                <div id="portfolioFields" style="display: none;">
                                    <div style="margin-bottom: 1rem;">
                                        <label style="display: block; margin-bottom: 0.5rem; color: #666;">Metric</label>
                                        <select id="portfolioMetric" style="width: 100%; padding: 0.75rem; border: 2px solid #e0e0e0; border-radius: 8px;">
                                            <option value="total_value">Total Portfolio Value</option>
                                            <option value="unrealized_pnl">Unrealized P&L</option>
                                            <option value="sharpe_ratio">Sharpe Ratio</option>
                                            <option value="portfolio_beta">Portfolio Beta</option>
                                            <option value="volatility">Volatility</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <!-- Macro Alert Fields (hidden by default) -->
                                <div id="macroFields" style="display: none;">
                                    <div style="margin-bottom: 1rem;">
                                        <label style="display: block; margin-bottom: 0.5rem; color: #666;">Indicator</label>
                                        <select id="macroIndicator" style="width: 100%; padding: 0.75rem; border: 2px solid #e0e0e0; border-radius: 8px;">
                                            <option value="vix">VIX - Volatility Index</option>
                                            <option value="interest_rate">Interest Rate</option>
                                            <option value="inflation">Inflation Rate</option>
                                            <option value="gdp_growth">GDP Growth</option>
                                            <option value="unemployment">Unemployment Rate</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                                <div>
                                    <label style="display: block; margin-bottom: 0.5rem; color: #666;">Condition</label>
                                    <select id="alertCondition" style="width: 100%; padding: 0.75rem; border: 2px solid #e0e0e0; border-radius: 8px;">
                                        <option value="above">Above</option>
                                        <option value="below">Below</option>
                                        <option value="change">Change %</option>
                                    </select>
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 0.5rem; color: #666;">Threshold</label>
                                    <input type="number" id="alertThreshold" placeholder="Enter value" style="width: 100%; padding: 0.75rem; border: 2px solid #e0e0e0; border-radius: 8px;">
                                </div>
                            </div>
                            
                            <div>
                                <label style="display: block; margin-bottom: 0.5rem; color: #666;">Alert Message</label>
                                <input type="text" id="alertMessage" placeholder="Enter alert description" style="width: 100%; padding: 0.75rem; border: 2px solid #e0e0e0; border-radius: 8px;">
                            </div>
                            
                            <div style="display: flex; gap: 1rem; margin-top: 1rem;">
                                <button onclick="createAlert()" style="flex: 1; padding: 0.75rem; background: linear-gradient(135deg, #10b981, #059669); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">
                                    Create Alert
                                </button>
                                <button onclick="toggleCreateAlertForm()" style="flex: 1; padding: 0.75rem; background: #e0e0e0; color: #666; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">
                                    Cancel
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Active Alerts Section -->
                    <div>
                        <h4 style="margin-bottom: 1.5rem;">Active Alerts</h4>
                        <div id="alertsList" style="display: grid; gap: 1rem;">
                            <!-- Alerts will be populated here -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- AI Analysis Tab -->
            <div class="tab-content" id="ai-tab">
                <div class="ai-analysis">
                    <h3>AI Portfolio Analysis</h3>
                    <div class="ai-input">
                        <input type="text" id="aiQuery" placeholder="Ask a question about your portfolio...">
                        <button onclick="runAIAnalysis()">Analyze</button>
                    </div>
                    <div class="ai-response" id="aiResponse">
                        <p style="color: #666;">Ask a question to get AI-powered insights about your portfolio.</p>
                    </div>
                </div>
            </div>

            <!-- Optimize Tab -->
            <div class="tab-content" id="optimize-tab">
                <div class="ai-analysis">
                    <h3>Portfolio Optimization</h3>
                    <p style="margin-bottom: 1.5rem; color: #666;">Select your risk tolerance to get rebalancing recommendations</p>
                    <div style="margin-bottom: 2rem;">
                        <label for="riskSlider" style="display: block; margin-bottom: 0.5rem; color: #666;">Risk Tolerance: <span id="riskValue">0.5</span></label>
                        <input type="range" id="riskSlider" min="0" max="1" step="0.1" value="0.5" style="width: 100%;" onchange="document.getElementById('riskValue').textContent = this.value">
                    </div>
                    <button class="btn" onclick="runOptimization()">Generate Recommendations</button>
                    <div id="optimizationResults" style="margin-top: 2rem;"></div>
                </div>
            </div>

            <!-- Macro Dashboard Tab -->
            <div class="tab-content" id="macro-tab">
                <div style="background: white; border-radius: 20px; padding: 2rem; box-shadow: 0 10px 30px rgba(0,0,0,0.1);">
                    <h2 style="color: #333; margin-bottom: 1.5rem;">Macro Economic Dashboard - Dalio Framework</h2>
                    <button class="btn" onclick="loadMacroData()" style="width: auto; padding: 0.75rem 2rem; margin-bottom: 2rem;">
                        Refresh Macro Data
                    </button>
                    
                    <!-- Master Reasoning Panel -->
                    <div id="master-reasoning-panel" style="display: none; margin-bottom: 1.5rem; background: linear-gradient(135deg, rgba(147, 51, 234, 0.1), rgba(102, 126, 234, 0.1)); border: 2px solid rgba(147, 51, 234, 0.3); border-radius: 15px; padding: 1.5rem;">
                        <h3 style="color: #9333ea; font-size: 1.2rem; margin-bottom: 1rem;">
                            üß† Dalio Framework Analysis Engine
                        </h3>
                        
                        <!-- Synthesis Reasoning -->
                        <div id="synthesis-section" style="display: flex; flex-direction: column; gap: 1rem;">
                            <div>
                                <h4 style="font-size: 0.9rem; font-weight: 600; color: #666; margin-bottom: 0.5rem;">Combined Assessment:</h4>
                                <div id="combined-assessment" style="display: flex; flex-direction: column; gap: 0.5rem;">
                                    <!-- Populated dynamically -->
                                </div>
                            </div>
                            
                            <div>
                                <h4 style="font-size: 0.9rem; font-weight: 600; color: #666; margin-bottom: 0.5rem;">Historical Parallels:</h4>
                                <div id="historical-parallels" style="display: flex; flex-direction: column; gap: 0.5rem;">
                                    <!-- Populated dynamically -->
                                </div>
                            </div>
                            
                            <div>
                                <h4 style="font-size: 0.9rem; font-weight: 600; color: #666; margin-bottom: 0.5rem;">Dalio's Key Principles Applied:</h4>
                                <div id="key-insights" style="display: flex; flex-direction: column; gap: 0.5rem;">
                                    <!-- Populated dynamically -->
                                </div>
                            </div>
                        </div>
                        
                        <!-- Causal Chain Visualization -->
                        <div style="margin-top: 1rem; padding: 1rem; background: rgba(255, 255, 255, 0.5); border-radius: 10px;">
                            <h4 style="font-size: 0.9rem; font-weight: 600; color: #666; margin-bottom: 0.75rem;">üìä Causal Chain:</h4>
                            <div style="display: flex; align-items: center; justify-content: space-between; font-size: 0.75rem;">
                                <div style="text-align: center;">
                                    <div style="font-weight: bold; color: #333;">DATA</div>
                                    <div style="color: #666;">24 indicators</div>
                                </div>
                                <div style="color: #667eea; font-size: 1rem;">‚Üí</div>
                                <div style="text-align: center;">
                                    <div style="font-weight: bold; color: #333;">CYCLES</div>
                                    <div style="color: #666;">4 frameworks</div>
                                </div>
                                <div style="color: #667eea; font-size: 1rem;">‚Üí</div>
                                <div style="text-align: center;">
                                    <div style="font-weight: bold; color: #333;">PATTERNS</div>
                                    <div style="color: #666;">Historical analysis</div>
                                </div>
                                <div style="color: #667eea; font-size: 1rem;">‚Üí</div>
                                <div style="text-align: center;">
                                    <div style="font-weight: bold; color: #333;">REGIME</div>
                                    <div style="color: #666;">Current state</div>
                                </div>
                                <div style="color: #667eea; font-size: 1rem;">‚Üí</div>
                                <div style="text-align: center;">
                                    <div style="font-weight: bold; color: #333;">ACTION</div>
                                    <div style="color: #666;">Portfolio strategy</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div id="macroContent">
                        <!-- Dalio Cycles Overview -->
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; margin-bottom: 2rem;">
                            <!-- Short-Term Debt Cycle Card -->
                            <div style="background: linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1)); border: 2px solid rgba(102, 126, 234, 0.3); border-radius: 15px; padding: 1.5rem;">
                                <h3 style="color: #667eea; font-size: 1.2rem; margin-bottom: 1rem; display: flex; justify-content: space-between; align-items: center;">
                                    Short-Term Debt Cycle (5-8 years)
                                    <button onclick="toggleReasoning('stdc')" style="font-size: 0.75rem; background: rgba(102, 126, 234, 0.2); color: white; border: 1px solid rgba(102, 126, 234, 0.5); padding: 0.25rem 0.75rem; border-radius: 0.5rem; cursor: pointer;">
                                        üìä Show Reasoning
                                    </button>
                                </h3>
                                <div style="margin-bottom: 1rem;">
                                    <div style="font-size: 1.8rem; font-weight: bold; color: #333;" id="stdc-phase">--</div>
                                    <div style="font-size: 0.9rem; color: #666; margin-top: 0.25rem;">Position in cycle</div>
                                </div>
                                <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                                    <div style="display: flex; justify-content: space-between;">
                                        <span style="color: #666;">Credit Growth</span>
                                        <span style="font-weight: 600;" id="stdc-credit">--</span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between;">
                                        <span style="color: #666;">Interest Rate Cycle</span>
                                        <span style="font-weight: 600;" id="stdc-rates">--</span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between;">
                                        <span style="color: #666;">Phase Duration</span>
                                        <span style="font-weight: 600;" id="stdc-duration">--</span>
                                    </div>
                                </div>
                                <!-- Visual cycle indicator -->
                                <div style="margin-top: 1rem;">
                                    <canvas id="stdc-cycle-chart" width="300" height="100"></canvas>
                                </div>
                                
                                <!-- NEW: Reasoning Panel (hidden by default) -->
                                <div id="stdc-reasoning" style="display: none; margin-top: 1rem; padding: 1rem; background: rgba(51, 51, 51, 0.3); border-radius: 10px;">
                                    <h4 style="font-size: 1rem; font-weight: 600; color: #667eea; margin-bottom: 0.75rem;">üìà Analysis Breakdown</h4>
                                    
                                    <!-- Raw Data Points -->
                                    <div style="margin-bottom: 0.75rem;">
                                        <h5 style="font-size: 0.85rem; font-weight: 600; color: #999; margin-bottom: 0.5rem;">Raw Data:</h5>
                                        <div id="stdc-raw-data" style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; font-size: 0.8rem;">
                                            <!-- Populated by JS -->
                                        </div>
                                    </div>
                                    
                                    <!-- Calculations -->
                                    <div style="margin-bottom: 0.75rem;">
                                        <h5 style="font-size: 0.85rem; font-weight: 600; color: #999; margin-bottom: 0.5rem;">Calculations:</h5>
                                        <div id="stdc-calculations" style="display: flex; flex-direction: column; gap: 0.25rem; font-size: 0.8rem; color: #333;">
                                            <!-- Populated by JS -->
                                        </div>
                                    </div>
                                    
                                    <!-- Logic Chain -->
                                    <div style="margin-bottom: 0.75rem;">
                                        <h5 style="font-size: 0.85rem; font-weight: 600; color: #999; margin-bottom: 0.5rem;">Logic Chain:</h5>
                                        <div id="stdc-logic" style="display: flex; flex-direction: column; gap: 0.25rem;">
                                            <!-- Populated by JS -->
                                        </div>
                                    </div>
                                    
                                    <!-- Conclusion -->
                                    <div style="padding: 0.75rem; background: rgba(102, 126, 234, 0.1); border-radius: 8px;">
                                        <h5 style="font-size: 0.85rem; font-weight: 600; color: #667eea; margin-bottom: 0.25rem;">Conclusion:</h5>
                                        <div id="stdc-conclusion" style="font-size: 0.85rem; color: #333;">
                                            <!-- Populated by JS -->
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Long-Term Debt Cycle Card -->
                            <div style="background: linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1)); border: 2px solid rgba(102, 126, 234, 0.3); border-radius: 15px; padding: 1.5rem;">
                                <h3 style="color: #667eea; font-size: 1.2rem; margin-bottom: 1rem; display: flex; justify-content: space-between; align-items: center;">
                                    Long-Term Debt Cycle (75-100 years)
                                    <button onclick="toggleReasoning('ltdc')" style="font-size: 0.75rem; background: rgba(102, 126, 234, 0.2); color: white; border: 1px solid rgba(102, 126, 234, 0.5); padding: 0.25rem 0.75rem; border-radius: 0.5rem; cursor: pointer;">
                                        üìä Show Reasoning
                                    </button>
                                </h3>
                                <div style="margin-bottom: 1rem;">
                                    <div style="font-size: 1.8rem; font-weight: bold; color: #333;" id="ltdc-phase">--</div>
                                    <div style="font-size: 0.9rem; color: #666; margin-top: 0.25rem;">Position in cycle</div>
                                </div>
                                <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                                    <div style="display: flex; justify-content: space-between;">
                                        <span style="color: #666;">Debt/GDP Ratio</span>
                                        <span style="font-weight: 600;" id="ltdc-debt-gdp">--</span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between;">
                                        <span style="color: #666;">Debt Service Ratio</span>
                                        <span style="font-weight: 600;" id="ltdc-service">--</span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between;">
                                        <span style="color: #666;">Deleveraging Risk</span>
                                        <span style="font-weight: 600;" id="ltdc-risk">--</span>
                                    </div>
                                </div>
                                <!-- Visual cycle indicator -->
                                <div style="margin-top: 1rem;">
                                    <canvas id="ltdc-cycle-chart" width="300" height="100"></canvas>
                                </div>
                                
                                <!-- LTDC Reasoning Panel (hidden by default) -->
                                <div id="ltdc-reasoning" style="display: none; margin-top: 1rem; padding: 1rem; background: rgba(51, 51, 51, 0.3); border-radius: 10px;">
                                    <h4 style="font-size: 1rem; font-weight: 600; color: #667eea; margin-bottom: 0.75rem;">üìà Analysis Breakdown</h4>
                                    
                                    <!-- Raw Data Points -->
                                    <div style="margin-bottom: 0.75rem;">
                                        <h5 style="font-size: 0.85rem; font-weight: 600; color: #999; margin-bottom: 0.5rem;">Raw Data:</h5>
                                        <div id="ltdc-raw-data" style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; font-size: 0.8rem;">
                                            <!-- Populated by JS -->
                                        </div>
                                    </div>
                                    
                                    <!-- Calculations -->
                                    <div style="margin-bottom: 0.75rem;">
                                        <h5 style="font-size: 0.85rem; font-weight: 600; color: #999; margin-bottom: 0.5rem;">Calculations:</h5>
                                        <div id="ltdc-calculations" style="display: flex; flex-direction: column; gap: 0.25rem; font-size: 0.8rem; color: #333;">
                                            <!-- Populated by JS -->
                                        </div>
                                    </div>
                                    
                                    <!-- Logic Chain -->
                                    <div style="margin-bottom: 0.75rem;">
                                        <h5 style="font-size: 0.85rem; font-weight: 600; color: #999; margin-bottom: 0.5rem;">Logic Chain:</h5>
                                        <div id="ltdc-logic" style="display: flex; flex-direction: column; gap: 0.25rem;">
                                            <!-- Populated by JS -->
                                        </div>
                                    </div>
                                    
                                    <!-- Conclusion -->
                                    <div style="padding: 0.75rem; background: rgba(102, 126, 234, 0.1); border-radius: 8px;">
                                        <h5 style="font-size: 0.85rem; font-weight: 600; color: #667eea; margin-bottom: 0.25rem;">Conclusion:</h5>
                                        <div id="ltdc-conclusion" style="font-size: 0.85rem; color: #333;">
                                            <!-- Populated by JS -->
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- New Cycle Cards -->
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; margin-bottom: 2rem;">
                            <!-- Empire Cycle Card (250 years) -->
                            <div style="background: linear-gradient(135deg, rgba(147, 51, 234, 0.1), rgba(139, 92, 246, 0.1)); border: 2px solid rgba(147, 51, 234, 0.3); border-radius: 15px; padding: 1.5rem;">
                                <h3 style="color: #9333ea; font-size: 1.2rem; margin-bottom: 1rem; display: flex; justify-content: space-between; align-items: center;">
                                    Empire Cycle (250 years)
                                    <button onclick="toggleReasoning('empire')" style="font-size: 0.75rem; background: rgba(147, 51, 234, 0.2); color: white; border: 1px solid rgba(147, 51, 234, 0.5); padding: 0.25rem 0.75rem; border-radius: 0.5rem; cursor: pointer;">
                                        üìä Show Reasoning
                                    </button>
                                </h3>
                                <div style="margin-bottom: 1rem;">
                                    <div style="font-size: 1.8rem; font-weight: bold; color: #333;" id="empire-phase">--</div>
                                    <div style="font-size: 0.9rem; color: #666; margin-top: 0.25rem;">
                                        Empire Score: <span id="empire-score" style="color: #333; font-weight: 600;">--</span>/100
                                    </div>
                                </div>
                                
                                <!-- 8 Empire Indicators Grid -->
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; font-size: 0.85rem;">
                                    <div style="display: flex; justify-content: space-between;">
                                        <span style="color: #666;">Education</span>
                                        <span style="color: #333; font-weight: 600;" id="empire-education">--</span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between;">
                                        <span style="color: #666;">Innovation</span>
                                        <span style="color: #333; font-weight: 600;" id="empire-innovation">--</span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between;">
                                        <span style="color: #666;">GDP Share</span>
                                        <span style="color: #333; font-weight: 600;" id="empire-gdp-share">--</span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between;">
                                        <span style="color: #666;">Trade Share</span>
                                        <span style="color: #333; font-weight: 600;" id="empire-trade">--</span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between;">
                                        <span style="color: #666;">Military</span>
                                        <span style="color: #333; font-weight: 600;" id="empire-military">--</span>
                                    </div>
                                    <div style="display: flex; justify-between;">
                                        <span style="color: #666;">Financial Hub</span>
                                        <span style="color: #333; font-weight: 600;" id="empire-financial">--</span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between;">
                                        <span style="color: #666;">Reserve Currency</span>
                                        <span style="color: #333; font-weight: 600;" id="empire-reserve">--</span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between;">
                                        <span style="color: #666;">Competitiveness</span>
                                        <span style="color: #333; font-weight: 600;" id="empire-competitive">--</span>
                                    </div>
                                </div>
                                
                                <!-- Empire Trend Arrow -->
                                <div style="margin-top: 1rem; text-align: center;">
                                    <span id="empire-trend" style="font-size: 1.1rem; font-weight: 600;">--</span>
                                </div>
                                
                                <!-- Empire Reasoning Panel (hidden by default) -->
                                <div id="empire-reasoning" style="display: none; margin-top: 1rem; padding: 1rem; background: rgba(51, 51, 51, 0.3); border-radius: 10px;">
                                    <h4 style="font-size: 1rem; font-weight: 600; color: #9333ea; margin-bottom: 0.75rem;">üìà Analysis Breakdown</h4>
                                    
                                    <!-- Raw Data Points -->
                                    <div style="margin-bottom: 0.75rem;">
                                        <h5 style="font-size: 0.85rem; font-weight: 600; color: #999; margin-bottom: 0.5rem;">Raw Data:</h5>
                                        <div id="empire-raw-data" style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; font-size: 0.8rem;">
                                            <!-- Populated by JS -->
                                        </div>
                                    </div>
                                    
                                    <!-- Calculations -->
                                    <div style="margin-bottom: 0.75rem;">
                                        <h5 style="font-size: 0.85rem; font-weight: 600; color: #999; margin-bottom: 0.5rem;">Calculations:</h5>
                                        <div id="empire-calculations" style="display: flex; flex-direction: column; gap: 0.25rem; font-size: 0.8rem; color: #333;">
                                            <!-- Populated by JS -->
                                        </div>
                                    </div>
                                    
                                    <!-- Logic Chain -->
                                    <div style="margin-bottom: 0.75rem;">
                                        <h5 style="font-size: 0.85rem; font-weight: 600; color: #999; margin-bottom: 0.5rem;">Logic Chain:</h5>
                                        <div id="empire-logic" style="display: flex; flex-direction: column; gap: 0.25rem;">
                                            <!-- Populated by JS -->
                                        </div>
                                    </div>
                                    
                                    <!-- Conclusion -->
                                    <div style="padding: 0.75rem; background: rgba(147, 51, 234, 0.1); border-radius: 8px;">
                                        <h5 style="font-size: 0.85rem; font-weight: 600; color: #9333ea; margin-bottom: 0.25rem;">Conclusion:</h5>
                                        <div id="empire-conclusion" style="font-size: 0.85rem; color: #333;">
                                            <!-- Populated by JS -->
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Internal Order/Disorder Cycle Card -->
                            <div style="background: linear-gradient(135deg, rgba(239, 68, 68, 0.1), rgba(245, 158, 11, 0.1)); border: 2px solid rgba(239, 68, 68, 0.3); border-radius: 15px; padding: 1.5rem;">
                                <h3 style="color: #ef4444; font-size: 1.2rem; margin-bottom: 1rem; display: flex; justify-content: space-between; align-items: center;">
                                    Internal Order/Disorder Cycle
                                    <button onclick="toggleReasoning('internal')" style="font-size: 0.75rem; background: rgba(239, 68, 68, 0.2); color: white; border: 1px solid rgba(239, 68, 68, 0.5); padding: 0.25rem 0.75rem; border-radius: 0.5rem; cursor: pointer;">
                                        üìä Show Reasoning
                                    </button>
                                </h3>
                                <div style="margin-bottom: 1rem;">
                                    <div style="font-size: 1.5rem; font-weight: bold; color: #333;">
                                        Stage <span id="internal-stage-num">--</span>: <span id="internal-stage-name">--</span>
                                    </div>
                                    <div style="font-size: 0.9rem; color: #666; margin-top: 0.25rem;">
                                        Risk Level: <span id="internal-risk" style="color: #333; font-weight: 600;">--</span>
                                    </div>
                                </div>
                                
                                <!-- Critical Metrics with Progress Bars -->
                                <div style="margin-bottom: 1rem;">
                                    <div style="margin-bottom: 0.75rem;">
                                        <div style="display: flex; justify-content: space-between; margin-bottom: 0.25rem;">
                                            <span style="color: #666; font-size: 0.85rem;">Wealth Gap (Gini)</span>
                                            <span style="color: #333; font-weight: 600; font-size: 0.85rem;" id="internal-gini">--</span>
                                        </div>
                                        <div style="width: 100%; background: #e5e7eb; border-radius: 9999px; height: 8px;">
                                            <div id="gini-bar" style="background: linear-gradient(to right, #10b981, #ef4444); height: 8px; border-radius: 9999px; width: 0%;"></div>
                                        </div>
                                    </div>
                                    
                                    <div style="margin-bottom: 0.75rem;">
                                        <div style="display: flex; justify-content: space-between; margin-bottom: 0.25rem;">
                                            <span style="color: #666; font-size: 0.85rem;">Political Polarization</span>
                                            <span style="color: #333; font-weight: 600; font-size: 0.85rem;" id="internal-polarization">--%</span>
                                        </div>
                                        <div style="width: 100%; background: #e5e7eb; border-radius: 9999px; height: 8px;">
                                            <div id="polarization-bar" style="background: linear-gradient(to right, #3b82f6, #ef4444); height: 8px; border-radius: 9999px; width: 0%;"></div>
                                        </div>
                                    </div>
                                    
                                    <div>
                                        <div style="display: flex; justify-content: space-between; margin-bottom: 0.25rem;">
                                            <span style="color: #666; font-size: 0.85rem;">Civil War Probability</span>
                                            <span style="color: #333; font-weight: bold; font-size: 0.85rem;" id="civil-war-prob">--%</span>
                                        </div>
                                        <div style="width: 100%; background: #e5e7eb; border-radius: 9999px; height: 8px;">
                                            <div id="civil-war-bar" style="background: linear-gradient(to right, #eab308, #dc2626); height: 8px; border-radius: 9999px; width: 0%;"></div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Additional Internal Metrics -->
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; font-size: 0.85rem;">
                                    <div style="display: flex; justify-content: space-between;">
                                        <span style="color: #666;">Fiscal Deficit</span>
                                        <span style="color: #333; font-weight: 600;" id="internal-deficit">--</span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between;">
                                        <span style="color: #666;">Social Unrest</span>
                                        <span style="color: #333; font-weight: 600;" id="internal-unrest">--</span>
                                    </div>
                                </div>
                                
                                <!-- Internal Reasoning Panel (hidden by default) -->
                                <div id="internal-reasoning" style="display: none; margin-top: 1rem; padding: 1rem; background: rgba(51, 51, 51, 0.3); border-radius: 10px;">
                                    <h4 style="font-size: 1rem; font-weight: 600; color: #ef4444; margin-bottom: 0.75rem;">üìà Analysis Breakdown</h4>
                                    
                                    <!-- Raw Data Points -->
                                    <div style="margin-bottom: 0.75rem;">
                                        <h5 style="font-size: 0.85rem; font-weight: 600; color: #999; margin-bottom: 0.5rem;">Raw Data:</h5>
                                        <div id="internal-raw-data" style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; font-size: 0.8rem;">
                                            <!-- Populated by JS -->
                                        </div>
                                    </div>
                                    
                                    <!-- Calculations -->
                                    <div style="margin-bottom: 0.75rem;">
                                        <h5 style="font-size: 0.85rem; font-weight: 600; color: #999; margin-bottom: 0.5rem;">Calculations:</h5>
                                        <div id="internal-calculations" style="display: flex; flex-direction: column; gap: 0.25rem; font-size: 0.8rem; color: #333;">
                                            <!-- Populated by JS -->
                                        </div>
                                    </div>
                                    
                                    <!-- Logic Chain -->
                                    <div style="margin-bottom: 0.75rem;">
                                        <h5 style="font-size: 0.85rem; font-weight: 600; color: #999; margin-bottom: 0.5rem;">Logic Chain:</h5>
                                        <div id="internal-logic" style="display: flex; flex-direction: column; gap: 0.25rem;">
                                            <!-- Populated by JS -->
                                        </div>
                                    </div>
                                    
                                    <!-- Conclusion -->
                                    <div style="padding: 0.75rem; background: rgba(239, 68, 68, 0.1); border-radius: 8px;">
                                        <h5 style="font-size: 0.85rem; font-weight: 600; color: #ef4444; margin-bottom: 0.25rem;">Conclusion:</h5>
                                        <div id="internal-conclusion" style="font-size: 0.85rem; color: #333;">
                                            <!-- Populated by JS -->
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Leading Indicators Alert Section -->
                        <div id="leading-indicators-section" style="display: none; background: linear-gradient(135deg, rgba(245, 158, 11, 0.1), rgba(251, 191, 36, 0.1)); border: 2px solid rgba(245, 158, 11, 0.3); border-radius: 15px; padding: 1.5rem; margin-bottom: 2rem;">
                            <h3 style="color: #f59e0b; font-size: 1.2rem; margin-bottom: 1rem;">
                                ‚ö†Ô∏è Leading Indicators & Early Warning Signals
                            </h3>
                            <div id="leading-indicators-list" style="display: flex; flex-direction: column; gap: 0.75rem;">
                                <!-- Will be populated dynamically -->
                            </div>
                        </div>
                        
                        <!-- Debt Metrics Section -->
                        <div style="background: #f8f9fa; border-radius: 15px; padding: 1.5rem; margin-bottom: 2rem;">
                            <h3 style="color: #667eea; margin-bottom: 1rem;">Debt Dynamics</h3>
                            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem;">
                                <div style="text-align: center;">
                                    <div style="font-size: 1.5rem; font-weight: bold; color: #333;" id="debt-to-gdp">--</div>
                                    <div style="font-size: 0.85rem; color: #666;">Debt/GDP</div>
                                </div>
                                <div style="text-align: center;">
                                    <div style="font-size: 1.5rem; font-weight: bold; color: #333;" id="credit-impulse">--</div>
                                    <div style="font-size: 0.85rem; color: #666;">Credit Impulse</div>
                                </div>
                                <div style="text-align: center;">
                                    <div style="font-size: 1.5rem; font-weight: bold; color: #333;" id="real-rates">--</div>
                                    <div style="font-size: 0.85rem; color: #666;">Real Rates</div>
                                </div>
                                <div style="text-align: center;">
                                    <div style="font-size: 1.5rem; font-weight: bold; color: #333;" id="productivity">--</div>
                                    <div style="font-size: 0.85rem; color: #666;">Productivity</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Deleveraging Analysis (shown only during deleveraging) -->
                        <div id="deleveraging-section" style="display: none; background: linear-gradient(135deg, rgba(251, 191, 36, 0.1), rgba(245, 158, 11, 0.1)); border: 2px solid rgba(251, 191, 36, 0.4); border-radius: 15px; padding: 1.5rem; margin-bottom: 2rem;">
                            <h3 style="color: #f59e0b; margin-bottom: 1rem;">Deleveraging Analysis</h3>
                            <div style="margin-bottom: 1rem;">
                                <div style="font-size: 1.4rem; font-weight: bold; color: #333;">
                                    Beautiful Deleveraging Score: <span id="deleveraging-score">--</span>/100
                                </div>
                            </div>
                            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem;">
                                <div>
                                    <div style="font-size: 1.2rem; color: #333;" id="lever-austerity">--</div>
                                    <div style="font-size: 0.85rem; color: #666;">Austerity</div>
                                </div>
                                <div>
                                    <div style="font-size: 1.2rem; color: #333;" id="lever-defaults">--</div>
                                    <div style="font-size: 0.85rem; color: #666;">Debt Restructuring</div>
                                </div>
                                <div>
                                    <div style="font-size: 1.2rem; color: #333;" id="lever-redistribution">--</div>
                                    <div style="font-size: 0.85rem; color: #666;">Redistribution</div>
                                </div>
                                <div>
                                    <div style="font-size: 1.2rem; color: #333;" id="lever-printing">--</div>
                                    <div style="font-size: 0.85rem; color: #666;">Money Printing</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Original Indicators Section -->
                        <div id="macro-indicators-grid" style="display: none;">
                            <!-- Will be filled by existing loadMacroData function -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let authToken = null;
        const API_BASE = '';

        // Check if already logged in
        if (localStorage.getItem('auth_token')) {
            authToken = localStorage.getItem('auth_token');
            showDashboard();
        }

        // Login form handler
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            
            try {
                const response = await fetch(`${API_BASE}/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });

                if (response.ok) {
                    const data = await response.json();
                    authToken = data.access_token;
                    localStorage.setItem('auth_token', authToken);
                    document.getElementById('errorMessage').textContent = '';
                    document.getElementById('successMessage').textContent = 'Login successful!';
                    setTimeout(() => showDashboard(), 500);
                } else {
                    document.getElementById('errorMessage').textContent = 'Invalid credentials. Password: admin123';
                }
            } catch (error) {
                document.getElementById('errorMessage').textContent = 'Connection error: ' + error.message;
            }
        });

        // Logout handler
        document.getElementById('logoutBtn').addEventListener('click', () => {
            localStorage.removeItem('auth_token');
            authToken = null;
            document.getElementById('authSection').style.display = 'block';
            document.getElementById('dashboard').classList.remove('active');
            document.getElementById('logoutBtn').style.display = 'none';
        });

        // Show dashboard
        async function showDashboard() {
            document.getElementById('authSection').style.display = 'none';
            document.getElementById('dashboard').classList.add('active');
            document.getElementById('logoutBtn').style.display = 'block';
            await loadPortfolioData();
            await loadAlerts();
        }

        // Tab navigation
        function showTab(tabName) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById(`${tabName}-tab`).classList.add('active');
            
            // Load transactions when transactions tab is selected
            if (tabName === 'transactions' && authToken) {
                loadTransactions();
            }
            
            // Load macro data when scenarios tab is selected
            if (tabName === 'scenarios') {
                loadScenarioMacroData();
            }
        }

        // Load portfolio data
        async function loadPortfolioData() {
            try {
                const response = await fetch(`${API_BASE}/execute`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({
                        pattern: 'portfolio_overview',
                        inputs: {}
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    const portfolio = data.result;
                    
                    // Update stats
                    document.getElementById('totalValue').textContent = `$${portfolio.total_value.toLocaleString()}`;
                    document.getElementById('unrealizedPnl').textContent = `$${portfolio.unrealized_pnl.toLocaleString()}`;
                    document.getElementById('unrealizedPnl').className = portfolio.unrealized_pnl >= 0 ? 'stat-value positive' : 'stat-value negative';
                    document.getElementById('dayReturn').textContent = `${(portfolio.returns_1d * 100).toFixed(2)}%`;
                    document.getElementById('dayReturn').className = portfolio.returns_1d >= 0 ? 'stat-value positive' : 'stat-value negative';
                    document.getElementById('ytdReturn').textContent = `${(portfolio.returns_ytd * 100).toFixed(2)}%`;
                    document.getElementById('ytdReturn').className = portfolio.returns_ytd >= 0 ? 'stat-value positive' : 'stat-value negative';
                    document.getElementById('portfolioBeta').textContent = portfolio.portfolio_beta.toFixed(2);
                    document.getElementById('sharpeRatio').textContent = portfolio.sharpe_ratio.toFixed(2);
                    document.getElementById('var95').textContent = `$${portfolio.var_95.toLocaleString()}`;
                    document.getElementById('maxDrawdown').textContent = `${(portfolio.max_drawdown * 100).toFixed(2)}%`;
                    document.getElementById('maxDrawdown').className = 'stat-value negative';

                    // Update holdings table
                    if (portfolio.holdings) {
                        const holdingsBody = document.getElementById('holdingsBody');
                        holdingsBody.innerHTML = portfolio.holdings.map(h => `
                            <tr>
                                <td><strong>${h.symbol}</strong></td>
                                <td>${h.quantity}</td>
                                <td>$${h.price.toFixed(2)}</td>
                                <td>$${h.value.toLocaleString()}</td>
                                <td>${(h.weight * 100).toFixed(1)}%</td>
                                <td class="${h.change >= 0 ? 'positive' : 'negative'}">
                                    ${h.change >= 0 ? '+' : ''}${(h.change * 100).toFixed(2)}%
                                </td>
                                <td>${h.beta.toFixed(2)}</td>
                            </tr>
                        `).join('');
                    }
                }
            } catch (error) {
                console.error('Error loading portfolio data:', error);
            }
        }

        // Load alerts
        async function loadAlerts() {
            try {
                const response = await fetch(`${API_BASE}/api/alerts`);
                if (response.ok) {
                    const data = await response.json();
                    const alertsList = document.getElementById('alertsList');
                    const alertCount = document.getElementById('alertCount');
                    
                    // Update alert count
                    const activeCount = data.filter(a => a.active).length;
                    alertCount.textContent = data.length > 0 ? `${activeCount}/${data.length}` : '0';
                    
                    if (data.length === 0) {
                        alertsList.innerHTML = `
                            <div style="text-align: center; padding: 2rem; color: #999;">
                                <div style="font-size: 3rem; margin-bottom: 1rem;">üì≠</div>
                                <p>No alerts configured yet. Click "New Alert" to create your first alert.</p>
                            </div>
                        `;
                    } else {
                        alertsList.innerHTML = data.map(alert => {
                            const icon = alert.type === 'price' ? 'üíπ' : alert.type === 'portfolio' ? 'üìä' : 'üåç';
                            const bgColor = alert.active ? 'rgba(16, 185, 129, 0.1)' : 'rgba(156, 163, 175, 0.1)';
                            const borderColor = alert.active ? '#10b981' : '#9ca3af';
                            
                            let details = '';
                            if (alert.type === 'price') {
                                details = `${alert.symbol} ${alert.condition} $${alert.threshold}`;
                            } else if (alert.type === 'portfolio') {
                                details = `${alert.metric} ${alert.condition} ${alert.threshold}`;
                            } else if (alert.type === 'macro') {
                                details = `${alert.metric} ${alert.condition} ${alert.threshold}`;
                            }
                            
                            return `
                                <div style="background: ${bgColor}; border-left: 4px solid ${borderColor}; padding: 1.5rem; border-radius: 10px; transition: all 0.3s;">
                                    <div style="display: flex; justify-content: space-between; align-items: start;">
                                        <div style="flex: 1;">
                                            <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.5rem;">
                                                <span style="font-size: 1.5rem;">${icon}</span>
                                                <strong style="text-transform: uppercase; color: ${borderColor}; font-size: 0.9rem;">
                                                    ${alert.type} ALERT
                                                </strong>
                                                ${alert.last_triggered ? `<span style="background: #fbbf24; color: #78350f; padding: 0.25rem 0.5rem; border-radius: 5px; font-size: 0.75rem;">Triggered</span>` : ''}
                                            </div>
                                            <div style="font-size: 1.1rem; margin-bottom: 0.5rem;">${alert.message}</div>
                                            <div style="color: #666; font-size: 0.9rem;">
                                                <strong>Condition:</strong> ${details}
                                            </div>
                                            <div style="color: #999; font-size: 0.8rem; margin-top: 0.5rem;">
                                                Created: ${new Date(alert.created_at).toLocaleDateString()}
                                            </div>
                                        </div>
                                        <div style="display: flex; gap: 0.5rem; align-items: center;">
                                            <label class="toggle-switch" style="position: relative; display: inline-block; width: 50px; height: 26px;">
                                                <input type="checkbox" ${alert.active ? 'checked' : ''} onchange="toggleAlert('${alert.id}', this.checked)" style="opacity: 0; width: 0; height: 0;">
                                                <span style="position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: ${alert.active ? '#10b981' : '#ccc'}; transition: .4s; border-radius: 34px;">
                                                    <span style="position: absolute; content: ''; height: 20px; width: 20px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; transform: ${alert.active ? 'translateX(24px)' : 'translateX(0)'};"></span>
                                                </span>
                                            </label>
                                            <button onclick="deleteAlert('${alert.id}')" style="background: #ef4444; color: white; border: none; padding: 0.5rem; border-radius: 5px; cursor: pointer;" title="Delete Alert">
                                                üóëÔ∏è
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            `;
                        }).join('');
                    }
                }
            } catch (error) {
                console.error('Error loading alerts:', error);
            }
        }
        
        // Toggle create alert form
        function toggleCreateAlertForm() {
            const form = document.getElementById('createAlertForm');
            form.style.display = form.style.display === 'none' ? 'block' : 'none';
            if (form.style.display === 'block') {
                updateAlertForm(); // Initialize form with default type
            }
        }
        
        // Update alert form based on selected type
        function updateAlertForm() {
            const alertType = document.getElementById('alertType').value;
            const priceFields = document.getElementById('priceFields');
            const portfolioFields = document.getElementById('portfolioFields');
            const macroFields = document.getElementById('macroFields');
            
            // Hide all type-specific fields
            priceFields.style.display = 'none';
            portfolioFields.style.display = 'none';
            macroFields.style.display = 'none';
            
            // Show relevant fields
            if (alertType === 'price') {
                priceFields.style.display = 'block';
            } else if (alertType === 'portfolio') {
                portfolioFields.style.display = 'block';
            } else if (alertType === 'macro') {
                macroFields.style.display = 'block';
            }
        }
        
        // Create new alert
        async function createAlert() {
            const alertType = document.getElementById('alertType').value;
            const condition = document.getElementById('alertCondition').value;
            const threshold = parseFloat(document.getElementById('alertThreshold').value);
            const message = document.getElementById('alertMessage').value;
            
            if (!threshold || !message) {
                showNotification('Please fill in all required fields', 'error');
                return;
            }
            
            const alertData = {
                type: alertType,
                condition: condition,
                threshold: threshold,
                message: message
            };
            
            // Add type-specific fields
            if (alertType === 'price') {
                alertData.symbol = document.getElementById('alertSymbol').value;
            } else if (alertType === 'portfolio') {
                alertData.metric = document.getElementById('portfolioMetric').value;
            } else if (alertType === 'macro') {
                alertData.metric = document.getElementById('macroIndicator').value;
            }
            
            try {
                const response = await fetch(`${API_BASE}/api/alerts`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify(alertData)
                });
                
                if (response.ok) {
                    showNotification('Alert created successfully!', 'success');
                    toggleCreateAlertForm();
                    loadAlerts(); // Reload alerts list
                    
                    // Clear form
                    document.getElementById('alertThreshold').value = '';
                    document.getElementById('alertMessage').value = '';
                } else {
                    showNotification('Failed to create alert', 'error');
                }
            } catch (error) {
                console.error('Error creating alert:', error);
                showNotification('Error creating alert', 'error');
            }
        }
        
        // Toggle alert active status
        async function toggleAlert(alertId, active) {
            try {
                const response = await fetch(`${API_BASE}/api/alerts/${alertId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({ active })
                });
                
                if (response.ok) {
                    showNotification(active ? 'Alert activated' : 'Alert deactivated', 'success');
                    loadAlerts(); // Reload alerts list
                } else {
                    showNotification('Failed to update alert', 'error');
                }
            } catch (error) {
                console.error('Error toggling alert:', error);
                showNotification('Error updating alert', 'error');
            }
        }
        
        // Delete alert
        async function deleteAlert(alertId) {
            if (!confirm('Are you sure you want to delete this alert?')) {
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/api/alerts/${alertId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                if (response.ok) {
                    showNotification('Alert deleted successfully', 'success');
                    loadAlerts(); // Reload alerts list
                } else {
                    showNotification('Failed to delete alert', 'error');
                }
            } catch (error) {
                console.error('Error deleting alert:', error);
                showNotification('Error deleting alert', 'error');
            }
        }
        
        // Show notification
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 1rem 1.5rem;
                background: ${type === 'success' ? '#10b981' : type === 'error' ? '#ef4444' : '#667eea'};
                color: white;
                border-radius: 10px;
                box-shadow: 0 10px 30px rgba(0,0,0,0.2);
                z-index: 10000;
                animation: slideIn 0.3s ease;
            `;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => {
                    document.body.removeChild(notification);
                }, 300);
            }, 3000);
        }

        // Load macro data for scenarios
        async function loadScenarioMacroData() {
            try {
                const response = await fetch('/api/macro');
                const data = await response.json();
                
                if (document.getElementById('scenarioRegime')) {
                    document.getElementById('scenarioRegime').textContent = data.current_regime || 'Unknown';
                    document.getElementById('scenarioStdc').textContent = data.stdc_phase || 'Unknown';
                    document.getElementById('scenarioLtdc').textContent = data.ltdc_phase || 'Unknown';
                    document.getElementById('scenarioRisk').textContent = data.risk_level || 'Unknown';
                }
            } catch (error) {
                console.error('Error loading macro data:', error);
            }
        }

        // Run scenario
        async function runScenario(scenarioType) {
            const loading = document.getElementById('scenarioLoading');
            const resultsDiv = document.getElementById('scenarioResults');
            
            loading.style.display = 'block';
            resultsDiv.style.display = 'none';
            
            try {
                const response = await fetch(`/api/scenario?scenario=${scenarioType}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                const data = await response.json();
                loading.style.display = 'none';
                
                const impactClass = data.impact_analysis?.base_impact_percent < 0 ? '#ef4444' : '#10b981';
                
                resultsDiv.innerHTML = `
                    <div style="background: rgba(102, 126, 234, 0.1); border-radius: 15px; padding: 1.5rem;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                            <h4>${data.scenario_name || 'Scenario Analysis'}</h4>
                            <span style="background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 0.5rem 1rem; border-radius: 20px; font-size: 0.85rem;">
                                Regime: ${data.macro_context?.current_regime || 'Unknown'}
                            </span>
                        </div>
                        <p style="color: #666; margin-bottom: 1.5rem;">${data.description || ''}</p>
                        
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; margin-bottom: 1.5rem;">
                            <div style="text-align: center;">
                                <div style="color: #666; font-size: 0.9rem;">Portfolio Impact</div>
                                <div style="font-size: 1.8rem; font-weight: bold; color: ${impactClass}">
                                    ${data.impact_analysis?.base_impact_percent || 0}%
                                </div>
                            </div>
                            <div style="text-align: center;">
                                <div style="color: #666; font-size: 0.9rem;">Dollar Impact</div>
                                <div style="font-size: 1.8rem; font-weight: bold; color: ${impactClass}">
                                    $${(data.impact_analysis?.portfolio_impact_amount || 0).toLocaleString()}
                                </div>
                            </div>
                            <div style="text-align: center;">
                                <div style="color: #666; font-size: 0.9rem;">Probability</div>
                                <div style="font-size: 1.8rem; font-weight: bold; color: #667eea">
                                    ${data.impact_analysis?.adjusted_probability || 0}%
                                </div>
                            </div>
                            <div style="text-align: center;">
                                <div style="color: #666; font-size: 0.9rem;">Confidence</div>
                                <div style="font-size: 1.8rem; font-weight: bold; color: #667eea">
                                    ${data.impact_analysis?.confidence_level || 0}%
                                </div>
                            </div>
                        </div>
                        
                        ${data.recommendations && data.recommendations.length > 0 ? `
                        <div style="background: #e8f5e9; border-left: 4px solid #4caf50; border-radius: 10px; padding: 1rem; margin: 1rem 0;">
                            <h5 style="color: #2e7d32; margin-bottom: 0.75rem;">üìã Recommended Actions</h5>
                            ${data.recommendations.map(rec => `
                                <div style="padding: 0.5rem 0; color: #333;">
                                    <span style="color: #4caf50; font-weight: bold; margin-right: 0.5rem;">‚úì</span> ${rec}
                                </div>
                            `).join('')}
                        </div>
                        ` : ''}
                        
                        ${data.hedge_suggestions && data.hedge_suggestions.length > 0 ? `
                        <div style="background: #fff3e0; border-left: 4px solid #ff9800; border-radius: 10px; padding: 1rem; margin: 1rem 0;">
                            <h5 style="color: #e65100; margin-bottom: 0.75rem;">üõ°Ô∏è Hedge Suggestions</h5>
                            ${data.hedge_suggestions.map(hedge => `
                                <div style="display: flex; justify-content: space-between; padding: 0.75rem 0; border-bottom: 1px solid rgba(0,0,0,0.1);">
                                    <span style="font-weight: 600;">${hedge.instrument}</span>
                                    <span style="color: #e65100; font-weight: bold;">$${hedge.size.toLocaleString()}</span>
                                </div>
                            `).join('')}
                        </div>
                        ` : ''}
                        
                        ${data.historical_analogues && data.historical_analogues.length > 0 ? `
                        <div style="background: #f3e5f5; border-left: 4px solid #9c27b0; border-radius: 10px; padding: 1rem; margin: 1rem 0;">
                            <h5 style="color: #6a1b9a; margin-bottom: 0.75rem;">üìö Historical Analogues</h5>
                            ${data.historical_analogues.map(analogue => `
                                <div style="padding: 0.5rem 0; color: #333; border-bottom: 1px dashed rgba(0,0,0,0.1);">${analogue}</div>
                            `).join('')}
                        </div>
                        ` : ''}
                    </div>
                `;
                
                resultsDiv.style.display = 'block';
                resultsDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                
            } catch (error) {
                loading.style.display = 'none';
                resultsDiv.innerHTML = `<div class="error-message">Error running scenario: ${error.message}. Please try again.</div>`;
                resultsDiv.style.display = 'block';
            }
        }

        // Run AI Analysis
        async function runAIAnalysis() {
            const query = document.getElementById('aiQuery').value;
            const responseDiv = document.getElementById('aiResponse');
            
            if (!query) return;
            
            responseDiv.innerHTML = '<div class="loading loading-pulse">Analyzing with AI...</div>';
            
            try {
                const response = await fetch(`${API_BASE}/api/ai/analyze`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({ query })
                });

                if (response.ok) {
                    const data = await response.json();
                    const analysis = data.analysis;
                    
                    responseDiv.innerHTML = `
                        <h4>AI Analysis</h4>
                        <div style="margin-top: 1rem;">
                            <strong>Insights:</strong>
                            <ul style="margin-top: 0.5rem; padding-left: 1.5rem;">
                                ${analysis.insights.map(i => `<li>${i}</li>`).join('')}
                            </ul>
                        </div>
                        <div style="margin-top: 1rem;">
                            <strong>Recommendations:</strong>
                            <ul style="margin-top: 0.5rem; padding-left: 1.5rem;">
                                ${analysis.recommendations.map(r => `<li>${r}</li>`).join('')}
                            </ul>
                        </div>
                        <div style="margin-top: 1rem;">
                            <strong>Risk Assessment:</strong>
                            <p>${analysis.risk_assessment}</p>
                        </div>
                    `;
                }
            } catch (error) {
                responseDiv.innerHTML = '<div class="error-message">Error with AI analysis. Please try again.</div>';
            }
        }

        // Run Optimization
        async function runOptimization() {
            const riskTolerance = document.getElementById('riskSlider').value;
            const resultsDiv = document.getElementById('optimizationResults');
            
            resultsDiv.innerHTML = '<div class="loading loading-pulse">Optimizing portfolio...</div>';
            
            try {
                const response = await fetch(`${API_BASE}/api/optimize`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({ risk_tolerance: parseFloat(riskTolerance) })
                });

                if (response.ok) {
                    const data = await response.json();
                    
                    resultsDiv.innerHTML = `
                        <div style="background: #f8f9fa; border-radius: 15px; padding: 1.5rem;">
                            <h4>Optimization Results</h4>
                            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 2rem; margin-top: 1rem;">
                                <div>
                                    <strong>Current Portfolio</strong>
                                    <ul style="margin-top: 0.5rem; list-style: none;">
                                        <li>Return: ${(data.current_portfolio.return * 100).toFixed(2)}%</li>
                                        <li>Risk: ${(data.current_portfolio.risk * 100).toFixed(2)}%</li>
                                        <li>Sharpe: ${data.current_portfolio.sharpe.toFixed(2)}</li>
                                    </ul>
                                </div>
                                <div>
                                    <strong>Optimized Portfolio</strong>
                                    <ul style="margin-top: 0.5rem; list-style: none;">
                                        <li>Return: ${(data.optimized_portfolio.return * 100).toFixed(2)}%</li>
                                        <li>Risk: ${(data.optimized_portfolio.risk * 100).toFixed(2)}%</li>
                                        <li>Sharpe: ${data.optimized_portfolio.sharpe.toFixed(2)}</li>
                                    </ul>
                                </div>
                            </div>
                            <div style="margin-top: 1.5rem;">
                                <strong>Recommended Trades:</strong>
                                <div style="margin-top: 0.5rem;">
                                    ${data.trades.map(t => `
                                        <div style="padding: 0.5rem; background: white; margin: 0.5rem 0; border-radius: 8px;">
                                            ${t.action} ${Math.abs(t.shares)} shares of ${t.symbol} ($${Math.abs(t.value).toFixed(2)})
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        </div>
                    `;
                }
            } catch (error) {
                resultsDiv.innerHTML = '<div class="error-message">Error optimizing portfolio. Please try again.</div>';
            }
        }

        // Transaction pagination variables
        let currentPage = 1;
        let totalPages = 1;

        // Load transactions
        async function loadTransactions(page = 1) {
            try {
                const response = await fetch(`${API_BASE}/api/transactions?page=${page}&page_size=20`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                if (response.ok) {
                    const data = await response.json();
                    const tbody = document.getElementById('transactionsBody');
                    
                    // Update summary
                    document.getElementById('totalInvested').textContent = `$${data.summary.total_invested.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
                    document.getElementById('totalDividends').textContent = `$${data.summary.total_dividends.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
                    document.getElementById('realizedGains').textContent = `$${data.summary.total_realized_gains.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
                    
                    // Update pagination
                    currentPage = data.pagination.page;
                    totalPages = data.pagination.total_pages;
                    document.getElementById('pageInfo').textContent = `Page ${currentPage} of ${totalPages}`;
                    document.getElementById('prevBtn').disabled = currentPage === 1;
                    document.getElementById('nextBtn').disabled = currentPage === totalPages;
                    
                    // Clear table
                    tbody.innerHTML = '';
                    
                    // Add transaction rows
                    data.transactions.forEach(t => {
                        const row = document.createElement('tr');
                        const typeClass = t.type === 'buy' ? 'negative' : t.type === 'sell' ? 'positive' : '';
                        const amountClass = t.amount > 0 ? 'positive' : t.amount < 0 ? 'negative' : '';
                        
                        row.innerHTML = `
                            <td>${t.date}</td>
                            <td style="text-transform: capitalize;">${t.type}</td>
                            <td><strong>${t.symbol}</strong></td>
                            <td>${t.shares}</td>
                            <td>$${t.price.toFixed(2)}</td>
                            <td class="${amountClass}">$${Math.abs(t.amount).toFixed(2)}</td>
                            <td class="${t.realized_gain > 0 ? 'positive' : ''}">${t.realized_gain > 0 ? '+' : ''}$${t.realized_gain.toFixed(2)}</td>
                        `;
                        tbody.appendChild(row);
                    });
                }
            } catch (error) {
                document.getElementById('transactionsBody').innerHTML = '<tr><td colspan="7" class="error-message">Error loading transactions</td></tr>';
            }
        }

        // Pagination functions
        function prevPage() {
            if (currentPage > 1) {
                loadTransactions(currentPage - 1);
            }
        }

        function nextPage() {
            if (currentPage < totalPages) {
                loadTransactions(currentPage + 1);
            }
        }

        // Toggle export dropdown
        function toggleDropdown() {
            const dropdown = document.getElementById('exportDropdown');
            dropdown.style.display = dropdown.style.display === 'none' ? 'block' : 'none';
            
            // Close dropdown when clicking outside
            document.addEventListener('click', function closeDropdown(e) {
                if (!e.target.closest('.dropdown')) {
                    dropdown.style.display = 'none';
                    document.removeEventListener('click', closeDropdown);
                }
            }, { once: true });
        }

        // Export data function
        async function exportData(format, type = 'holdings') {
            try {
                let url = '';
                let filename = '';
                
                if (format === 'pdf') {
                    url = `${API_BASE}/api/export/pdf`;
                    filename = `portfolio_report_${new Date().toISOString().split('T')[0]}.html`;
                } else if (format === 'csv') {
                    url = `${API_BASE}/api/export/csv?export_type=${type}`;
                    filename = `${type}_${new Date().toISOString().split('T')[0]}.csv`;
                }
                
                const response = await fetch(url, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                if (response.ok) {
                    const blob = await response.blob();
                    const downloadUrl = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = downloadUrl;
                    a.download = filename;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(downloadUrl);
                    
                    // Show success notification
                    showNotification('Export successful! File downloaded.');
                } else {
                    showNotification('Export failed. Please try again.', 'error');
                }
                
                // Close dropdown
                document.getElementById('exportDropdown').style.display = 'none';
            } catch (error) {
                showNotification('Export error: ' + error.message, 'error');
            }
        }

        // Show notification
        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 2rem;
                right: 2rem;
                padding: 1rem 1.5rem;
                background: ${type === 'success' ? 'linear-gradient(135deg, #10b981, #059669)' : 'linear-gradient(135deg, #ef4444, #dc2626)'};
                color: white;
                border-radius: 10px;
                box-shadow: 0 10px 30px rgba(0,0,0,0.2);
                z-index: 1000;
                animation: slideInRight 0.3s ease;
            `;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideOutRight 0.3s ease';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        // Load Macro Insights (from Overview tab)
        function loadMacro() {
            // Switch to the macro dashboard tab
            showTab('macro');
            // Load the macro data
            loadMacroData();
        }

        // Helper function to format phase names
        function formatPhase(phase) {
            if (!phase) return '--';
            // Convert UPPER_SNAKE_CASE to Title Case
            return phase.toLowerCase().split('_').map(word => 
                word.charAt(0).toUpperCase() + word.slice(1)
            ).join(' ');
        }
        
        // Helper function to draw cycle charts
        function drawCycleChart(canvasId, phase, cycleType) {
            const canvas = document.getElementById(canvasId);
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            const width = canvas.width;
            const height = canvas.height;
            
            // Clear canvas
            ctx.clearRect(0, 0, width, height);
            
            // Define phase positions for each cycle type
            const phases = cycleType === 'STDC' ? 
                ['EARLY_RECOVERY', 'MID_EXPANSION', 'LATE_EXPANSION', 'EARLY_CONTRACTION', 'RECESSION'] :
                ['PROSPERITY', 'BUBBLE', 'TOP', 'DEPRESSION', 'NORMALIZATION'];
            
            const currentIndex = phases.indexOf(phase);
            if (currentIndex === -1) return;
            
            // Draw cycle curve
            ctx.strokeStyle = '#9333ea'; // Purple
            ctx.lineWidth = 2;
            ctx.beginPath();
            
            // Draw sine wave
            for (let x = 0; x < width; x++) {
                const y = height/2 + Math.sin((x/width) * Math.PI * 2) * (height/3);
                if (x === 0) {
                    ctx.moveTo(x, y);
                } else {
                    ctx.lineTo(x, y);
                }
            }
            ctx.stroke();
            
            // Mark current position
            const posX = (currentIndex / phases.length) * width + 30;
            const posY = height/2 + Math.sin((currentIndex / phases.length) * Math.PI * 2) * (height/3);
            
            // Draw position marker
            ctx.fillStyle = '#f59e0b'; // Amber
            ctx.beginPath();
            ctx.arc(posX, posY, 8, 0, Math.PI * 2);
            ctx.fill();
            
            // Add glow effect
            ctx.shadowColor = '#f59e0b';
            ctx.shadowBlur = 10;
            ctx.beginPath();
            ctx.arc(posX, posY, 5, 0, Math.PI * 2);
            ctx.fill();
            ctx.shadowBlur = 0;
        }
        
        // Store reasoning data globally
        let macroReasoning = {};
        
        // Toggle reasoning panel visibility
        function toggleReasoning(cycle) {
            const panel = document.getElementById(`${cycle}-reasoning`);
            const button = event.target;
            
            if (panel.style.display === 'none' || !panel.style.display) {
                panel.style.display = 'block';
                button.textContent = 'üìâ Hide Reasoning';
                
                // Populate reasoning if available
                if (macroReasoning[cycle]) {
                    displayReasoning(cycle, macroReasoning[cycle]);
                }
            } else {
                panel.style.display = 'none';
                button.textContent = 'üìä Show Reasoning';
            }
        }
        
        // Display reasoning data in the UI
        function displayReasoning(cycle, reasoning) {
            if (!reasoning) return;
            
            // Display raw data as key-value pairs
            const rawDataEl = document.getElementById(`${cycle}-raw-data`);
            if (rawDataEl && reasoning.raw_data) {
                const rawDataHtml = Object.entries(reasoning.raw_data)
                    .map(([key, value]) => {
                        // Format the value properly
                        let formattedValue = value;
                        if (typeof value === 'number') {
                            formattedValue = value.toFixed(2);
                            // Add % or other units if appropriate
                            if (key.toLowerCase().includes('rate') || key.toLowerCase().includes('growth') || key.toLowerCase().includes('ratio')) {
                                formattedValue += '%';
                            }
                        } else if (typeof value === 'object') {
                            formattedValue = JSON.stringify(value);
                        }
                        
                        return `
                            <div style="display: flex; justify-content: space-between; padding: 0.25rem 0;">
                                <span style="color: #999; font-size: 0.8rem;">${formatLabel(key)}:</span>
                                <span style="color: #333; font-family: monospace; font-weight: 600; font-size: 0.8rem;">${formattedValue}</span>
                            </div>
                        `;
                    }).join('');
                rawDataEl.innerHTML = rawDataHtml || '<span style="color: #999; font-size: 0.8rem;">No raw data available</span>';
            }
            
            // Display calculations as formatted text blocks
            const calcEl = document.getElementById(`${cycle}-calculations`);
            if (calcEl && reasoning.calculations) {
                let calculationsHtml;
                if (Array.isArray(reasoning.calculations)) {
                    calculationsHtml = reasoning.calculations
                        .map(calc => `
                            <div style="padding: 0.5rem; background: rgba(255, 255, 255, 0.3); border-radius: 5px; margin: 0.25rem 0;">
                                <span style="color: #333; font-size: 0.8rem;">${calc}</span>
                            </div>
                        `).join('');
                } else if (typeof reasoning.calculations === 'object') {
                    calculationsHtml = Object.entries(reasoning.calculations)
                        .map(([key, value]) => `
                            <div style="padding: 0.5rem; background: rgba(255, 255, 255, 0.3); border-radius: 5px; margin: 0.25rem 0;">
                                <strong style="color: #667eea; font-size: 0.8rem;">${formatLabel(key)}:</strong>
                                <span style="color: #333; font-size: 0.8rem;"> ${value}</span>
                            </div>
                        `).join('');
                } else {
                    calculationsHtml = `
                        <div style="padding: 0.5rem; background: rgba(255, 255, 255, 0.3); border-radius: 5px; margin: 0.25rem 0;">
                            <span style="color: #333; font-size: 0.8rem;">${reasoning.calculations}</span>
                        </div>
                    `;
                }
                calcEl.innerHTML = calculationsHtml || '<span style="color: #999; font-size: 0.8rem;">No calculations available</span>';
            }
            
            // Display logic chain as bullet points
            const logicEl = document.getElementById(`${cycle}-logic`);
            if (logicEl && reasoning.logic_chain) {
                let logicHtml;
                if (Array.isArray(reasoning.logic_chain)) {
                    logicHtml = reasoning.logic_chain
                        .map((item, index) => `
                            <div style="display: flex; align-items: flex-start; margin-bottom: 0.5rem;">
                                <span style="color: #667eea; margin-right: 0.5rem; font-weight: bold; font-size: 0.8rem;">${index + 1}.</span>
                                <span style="color: #333; font-size: 0.8rem; line-height: 1.4;">${item}</span>
                            </div>
                        `).join('');
                } else {
                    logicHtml = `<span style="color: #333; font-size: 0.8rem;">${reasoning.logic_chain}</span>`;
                }
                logicEl.innerHTML = logicHtml || '<span style="color: #999; font-size: 0.8rem;">No logic chain available</span>';
            }
            
            // Display conclusion as a summary
            const conclusionEl = document.getElementById(`${cycle}-conclusion`);
            if (conclusionEl && reasoning.conclusion) {
                conclusionEl.innerHTML = `
                    <div style="font-size: 0.85rem; color: #333; line-height: 1.5;">
                        ${reasoning.conclusion}
                    </div>
                `;
            } else if (conclusionEl) {
                conclusionEl.innerHTML = '<span style="color: #999; font-size: 0.8rem;">No conclusion available</span>';
            }
        }
        
        function formatLabel(key) {
            return key.replace(/_/g, ' ')
                .split(' ')
                .map(word => word.charAt(0).toUpperCase() + word.slice(1))
                .join(' ');
        }
        
        // Display synthesis reasoning
        function displaySynthesisReasoning(synthesis) {
            if (!synthesis) return;
            
            // Show master reasoning panel
            const masterPanel = document.getElementById('master-reasoning-panel');
            if (masterPanel) {
                masterPanel.style.display = 'block';
            }
            
            // Display combined assessment
            const assessmentEl = document.getElementById('combined-assessment');
            if (assessmentEl && synthesis.combined_assessment) {
                assessmentEl.innerHTML = synthesis.combined_assessment
                    .map(item => `<div style="padding: 0.5rem; background: rgba(147, 51, 234, 0.1); border-radius: 5px; margin: 0.25rem 0; color: #333;">${item}</div>`).join('');
            }
            
            // Display historical parallels
            const parallelsEl = document.getElementById('historical-parallels');
            if (parallelsEl && synthesis.historical_parallels) {
                parallelsEl.innerHTML = synthesis.historical_parallels
                    .map(item => `<div style="padding: 0.5rem; background: rgba(245, 158, 11, 0.1); border-radius: 5px; margin: 0.25rem 0; color: #333;">${item}</div>`).join('');
            }
            
            // Display key insights
            const insightsEl = document.getElementById('key-insights');
            if (insightsEl && synthesis.key_insights) {
                insightsEl.innerHTML = synthesis.key_insights
                    .map(item => `<div style="padding: 0.5rem; background: rgba(102, 126, 234, 0.1); border-radius: 5px; margin: 0.25rem 0; color: #333;">${item}</div>`).join('');
            }
        }
        
        // Load Macro Data for Dashboard
        async function loadMacroData() {
            const macroContent = document.getElementById('macroContent');
            
            try {
                const response = await fetch(`${API_BASE}/execute`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({
                        pattern: 'macro_cycles_overview',
                        inputs: {}
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    const macro = data.result;
                    
                    // NEW: Store reasoning data globally if available
                    if (macro.reasoning) {
                        macroReasoning = macro.reasoning;
                        
                        // Display synthesis reasoning if available
                        if (macro.reasoning.synthesis) {
                            displaySynthesisReasoning(macro.reasoning.synthesis);
                        }
                    }
                    
                    // Update STDC display
                    if (macro.stdc_phase) {
                        document.getElementById('stdc-phase').textContent = formatPhase(macro.stdc_phase);
                        document.getElementById('stdc-credit').textContent = `${macro.stdc_metrics?.credit_growth || '--'}%`;
                        document.getElementById('stdc-rates').textContent = macro.stdc_metrics?.rate_cycle || '--';
                        document.getElementById('stdc-duration').textContent = macro.stdc_metrics?.duration || '--';
                        
                        // Draw STDC cycle visualization
                        drawCycleChart('stdc-cycle-chart', macro.stdc_phase, 'STDC');
                    }
                    
                    // Update LTDC display
                    if (macro.ltdc_phase) {
                        document.getElementById('ltdc-phase').textContent = formatPhase(macro.ltdc_phase);
                        document.getElementById('ltdc-debt-gdp').textContent = `${macro.debt_metrics?.debt_to_gdp || '--'}%`;
                        document.getElementById('ltdc-service').textContent = `${macro.debt_metrics?.debt_service_ratio || '--'}%`;
                        document.getElementById('ltdc-risk').textContent = macro.debt_metrics?.deleveraging_risk || '--';
                        
                        // Draw LTDC cycle visualization
                        drawCycleChart('ltdc-cycle-chart', macro.ltdc_phase, 'LTDC');
                    }
                    
                    // Update debt metrics
                    if (macro.debt_metrics) {
                        document.getElementById('debt-to-gdp').textContent = `${macro.debt_metrics.debt_to_gdp}%`;
                        document.getElementById('credit-impulse').textContent = `${macro.debt_metrics.credit_impulse}%`;
                        document.getElementById('real-rates').textContent = `${macro.debt_metrics.real_rates}%`;
                        document.getElementById('productivity').textContent = `${macro.debt_metrics.productivity_growth}%`;
                    }
                    
                    // NEW: Update Empire Cycle display
                    if (macro.empire_phase) {
                        document.getElementById('empire-phase').textContent = formatPhase(macro.empire_phase);
                        document.getElementById('empire-score').textContent = 
                            macro.empire_score ? macro.empire_score.toFixed(1) : '--';
                        
                        // Update 8 empire indicators
                        if (macro.empire_indicators) {
                            const ind = macro.empire_indicators;
                            document.getElementById('empire-education').textContent = 
                                ind.education_score ? ind.education_score.toFixed(1) : '--';
                            document.getElementById('empire-innovation').textContent = 
                                ind.innovation_score ? ind.innovation_score.toFixed(1) : '--';
                            document.getElementById('empire-gdp-share').textContent = 
                                ind.economic_output_share ? (ind.economic_output_share.toFixed(1) + '%') : '--';
                            document.getElementById('empire-trade').textContent = 
                                ind.world_trade_share ? (ind.world_trade_share.toFixed(1) + '%') : '--';
                            document.getElementById('empire-military').textContent = 
                                ind.military_strength ? (ind.military_strength.toFixed(1) + '%') : '--';
                            document.getElementById('empire-financial').textContent = 
                                ind.financial_center_score ? ind.financial_center_score.toFixed(1) : '--';
                            document.getElementById('empire-reserve').textContent = 
                                ind.reserve_currency_share ? (ind.reserve_currency_share.toFixed(1) + '%') : '--';
                            document.getElementById('empire-competitive').textContent = 
                                ind.competitiveness_score ? ind.competitiveness_score.toFixed(1) : '--';
                        }
                        
                        // Set trend arrow
                        const trend = macro.empire_trend || 'stable';
                        let trendSymbol = '‚Üí Stable';
                        let trendColor = '#9ca3af'; // gray
                        if (trend.toLowerCase().includes('declin')) {
                            trendSymbol = '‚Üì Declining';
                            trendColor = '#ef4444'; // red
                        } else if (trend.toLowerCase().includes('ascend') || trend.toLowerCase().includes('ris')) {
                            trendSymbol = '‚Üë Rising';
                            trendColor = '#10b981'; // green
                        }
                        document.getElementById('empire-trend').innerHTML = 
                            `<span style="color: ${trendColor};">${trendSymbol}</span>`;
                    }
                    
                    // NEW: Update Internal Cycle display
                    if (macro.internal_stage !== undefined) {
                        document.getElementById('internal-stage-num').textContent = macro.internal_stage || '--';
                        document.getElementById('internal-stage-name').textContent = 
                            macro.internal_stage_name || '--';
                        
                        // Set risk level with color
                        const risk = macro.internal_risk || 'UNKNOWN';
                        let riskColor = '#9ca3af'; // gray
                        if (risk === 'EXTREME') riskColor = '#ef4444'; // red
                        else if (risk === 'HIGH') riskColor = '#fb923c'; // orange
                        else if (risk === 'MEDIUM-HIGH') riskColor = '#eab308'; // yellow
                        else if (risk === 'MEDIUM') riskColor = '#facc15'; // light yellow
                        else if (risk === 'LOW') riskColor = '#10b981'; // green
                        
                        const riskElement = document.getElementById('internal-risk');
                        riskElement.style.color = riskColor;
                        riskElement.style.fontWeight = 'bold';
                        riskElement.textContent = risk;
                        
                        // Update wealth gap (Gini)
                        const gini = macro.wealth_gap || 0;
                        document.getElementById('internal-gini').textContent = gini.toFixed(3);
                        document.getElementById('gini-bar').style.width = (gini * 100) + '%';
                        
                        // Update polarization
                        const polarization = macro.political_polarization || 0;
                        document.getElementById('internal-polarization').textContent = 
                            polarization.toFixed(1) + '%';
                        document.getElementById('polarization-bar').style.width = polarization + '%';
                        
                        // Update civil war probability with color coding
                        const civilWarProb = macro.civil_war_probability || 0;
                        const probElement = document.getElementById('civil-war-prob');
                        probElement.textContent = civilWarProb.toFixed(1) + '%';
                        if (civilWarProb > 60) {
                            probElement.style.color = '#ef4444'; // red
                        } else if (civilWarProb > 40) {
                            probElement.style.color = '#fb923c'; // orange
                        } else {
                            probElement.style.color = '#eab308'; // yellow
                        }
                        document.getElementById('civil-war-bar').style.width = civilWarProb + '%';
                        
                        // Update additional metrics
                        const deficit = macro.indicators?.fiscal_deficit || macro.fiscal_deficit || 0;
                        document.getElementById('internal-deficit').textContent = 
                            Math.abs(deficit).toFixed(1) + '% GDP';
                        
                        const unrest = macro.social_unrest || 0;
                        document.getElementById('internal-unrest').textContent = 
                            unrest.toFixed(0) + '/100';
                    }
                    
                    // NEW: Display leading indicators
                    if (macro.leading_indicators && macro.leading_indicators.length > 0) {
                        const indicatorsList = document.getElementById('leading-indicators-list');
                        indicatorsList.innerHTML = '';
                        
                        macro.leading_indicators.forEach(indicator => {
                            const severityColor = 
                                indicator.severity === 'HIGH' ? '#ef4444' :
                                indicator.severity === 'MEDIUM' ? '#eab308' :
                                '#3b82f6';
                            
                            const item = document.createElement('div');
                            item.style.cssText = 'display: flex; align-items: flex-start; gap: 0.75rem; padding: 0.75rem; background: rgba(156, 163, 175, 0.1); border-radius: 8px;';
                            item.innerHTML = `
                                <span style="color: ${severityColor}; font-size: 1.25rem;">‚ö†</span>
                                <div style="flex: 1;">
                                    <div style="font-weight: 600; color: #333;">${indicator.signal}</div>
                                    <div style="font-size: 0.85rem; color: #666;">
                                        ${indicator.type} Cycle ‚Ä¢ ${indicator.timeframe}
                                    </div>
                                </div>
                                <span style="color: ${severityColor}; font-weight: bold; font-size: 0.85rem;">
                                    ${indicator.severity}
                                </span>
                            `;
                            indicatorsList.appendChild(item);
                        });
                        
                        document.getElementById('leading-indicators-section').style.display = 'block';
                    } else {
                        document.getElementById('leading-indicators-section').style.display = 'none';
                    }
                    
                    // Show deleveraging section if applicable
                    if (macro.deleveraging_score !== null && macro.deleveraging_score !== undefined) {
                        document.getElementById('deleveraging-section').style.display = 'block';
                        document.getElementById('deleveraging-score').textContent = macro.deleveraging_score;
                        // Update lever metrics if available
                        if (macro.deleveraging_levers) {
                            document.getElementById('lever-austerity').textContent = macro.deleveraging_levers.austerity || '--';
                            document.getElementById('lever-defaults').textContent = macro.deleveraging_levers.defaults || '--';
                            document.getElementById('lever-redistribution').textContent = macro.deleveraging_levers.redistribution || '--';
                            document.getElementById('lever-printing').textContent = macro.deleveraging_levers.printing || '--';
                        }
                    } else {
                        document.getElementById('deleveraging-section').style.display = 'none';
                    }
                    
                    // Also show the original indicators in a separate section
                    const indicatorsHtml = `
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; margin-bottom: 2rem;">
                            <div style="background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 1.5rem; border-radius: 15px;">
                                <div style="font-size: 0.9rem; opacity: 0.9;">Current Regime</div>
                                <div style="font-size: 2rem; font-weight: bold; margin-top: 0.5rem;">${macro.regime}</div>
                            </div>
                            <div style="background: ${macro.risk_level === 'High' ? 'linear-gradient(135deg, #ef4444, #dc2626)' : macro.risk_level === 'Medium-High' ? 'linear-gradient(135deg, #f59e0b, #d97706)' : 'linear-gradient(135deg, #10b981, #059669)'}; color: white; padding: 1.5rem; border-radius: 15px;">
                                <div style="font-size: 0.9rem; opacity: 0.9;">Risk Level</div>
                                <div style="font-size: 2rem; font-weight: bold; margin-top: 0.5rem;">${macro.risk_level}</div>
                            </div>
                        </div>
                        
                        <div style="margin-bottom: 2rem;">
                            <h3 style="color: #333; margin-bottom: 1.5rem; font-size: 1.5rem;">Key Economic Indicators</h3>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem;">
                                <div style="background: #f8f9fa; padding: 1.5rem; border-radius: 12px; border: 1px solid #e0e0e0;">
                                    <div style="color: #666; font-size: 0.9rem; margin-bottom: 0.5rem;">GDP Growth</div>
                                    <div style="font-size: 1.8rem; font-weight: bold; color: #333;">${macro.indicators.gdp_growth}%</div>
                                    <div style="font-size: 0.8rem; color: ${macro.indicators.gdp_growth > 2 ? '#10b981' : macro.indicators.gdp_growth > 0 ? '#f59e0b' : '#ef4444'};">
                                        ${macro.indicators.gdp_growth > 2 ? '‚Üë Strong' : macro.indicators.gdp_growth > 0 ? '‚Üí Moderate' : '‚Üì Weak'}
                                    </div>
                                </div>
                                <div style="background: #f8f9fa; padding: 1.5rem; border-radius: 12px; border: 1px solid #e0e0e0;">
                                    <div style="color: #666; font-size: 0.9rem; margin-bottom: 0.5rem;">Inflation</div>
                                    <div style="font-size: 1.8rem; font-weight: bold; color: #333;">${macro.indicators.inflation}%</div>
                                    <div style="font-size: 0.8rem; color: ${macro.indicators.inflation < 2 ? '#667eea' : macro.indicators.inflation < 4 ? '#10b981' : '#ef4444'};">
                                        ${macro.indicators.inflation < 2 ? 'Below Target' : macro.indicators.inflation < 4 ? 'On Target' : 'Above Target'}
                                    </div>
                                </div>
                                <div style="background: #f8f9fa; padding: 1.5rem; border-radius: 12px; border: 1px solid #e0e0e0;">
                                    <div style="color: #666; font-size: 0.9rem; margin-bottom: 0.5rem;">Unemployment</div>
                                    <div style="font-size: 1.8rem; font-weight: bold; color: #333;">${macro.indicators.unemployment}%</div>
                                    <div style="font-size: 0.8rem; color: ${macro.indicators.unemployment < 4 ? '#10b981' : macro.indicators.unemployment < 6 ? '#f59e0b' : '#ef4444'};">
                                        ${macro.indicators.unemployment < 4 ? 'Full Employment' : macro.indicators.unemployment < 6 ? 'Healthy' : 'Elevated'}
                                    </div>
                                </div>
                                <div style="background: #f8f9fa; padding: 1.5rem; border-radius: 12px; border: 1px solid #e0e0e0;">
                                    <div style="color: #666; font-size: 0.9rem; margin-bottom: 0.5rem;">Interest Rate</div>
                                    <div style="font-size: 1.8rem; font-weight: bold; color: #333;">${macro.indicators.interest_rate}%</div>
                                    <div style="font-size: 0.8rem; color: #667eea;">
                                        Fed Funds Rate
                                    </div>
                                </div>
                                <div style="background: #f8f9fa; padding: 1.5rem; border-radius: 12px; border: 1px solid #e0e0e0;">
                                    <div style="color: #666; font-size: 0.9rem; margin-bottom: 0.5rem;">VIX Index</div>
                                    <div style="font-size: 1.8rem; font-weight: bold; color: #333;">${macro.indicators.vix}</div>
                                    <div style="font-size: 0.8rem; color: ${macro.indicators.vix < 20 ? '#10b981' : macro.indicators.vix < 30 ? '#f59e0b' : '#ef4444'};">
                                        ${macro.indicators.vix < 20 ? 'Low Volatility' : macro.indicators.vix < 30 ? 'Moderate' : 'High Volatility'}
                                    </div>
                                </div>
                                <div style="background: #f8f9fa; padding: 1.5rem; border-radius: 12px; border: 1px solid #e0e0e0;">
                                    <div style="color: #666; font-size: 0.9rem; margin-bottom: 0.5rem;">Dollar Index</div>
                                    <div style="font-size: 1.8rem; font-weight: bold; color: #333;">${macro.indicators.dollar_index}</div>
                                    <div style="font-size: 0.8rem; color: ${macro.indicators.dollar_index > 100 ? '#10b981' : '#f59e0b'};">
                                        ${macro.indicators.dollar_index > 100 ? 'Strong USD' : 'Weak USD'}
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div style="margin-bottom: 2rem;">
                            <h3 style="color: #333; margin-bottom: 1.5rem; font-size: 1.5rem;">Strategic Recommendations</h3>
                            <div style="background: linear-gradient(135deg, #f8f9fa, #ffffff); padding: 2rem; border-radius: 15px; border: 1px solid #e0e0e0;">
                                ${macro.recommendations.map(rec => `
                                    <div style="padding: 1rem; margin-bottom: 1rem; background: white; border-radius: 10px; border-left: 4px solid #667eea;">
                                        <span style="color: #667eea; margin-right: 0.75rem; font-size: 1.2rem;">üìä</span>
                                        <span style="color: #333; line-height: 1.6;">${rec}</span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>

                        <div style="margin-bottom: 2rem;">
                            <h3 style="color: #333; margin-bottom: 1.5rem; font-size: 1.5rem;">Market Outlook</h3>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem;">
                                <div style="background: white; padding: 1.5rem; border-radius: 12px; border: 1px solid #e0e0e0;">
                                    <h4 style="color: #667eea; margin-bottom: 1rem;">üìà Near-term (1-3 months)</h4>
                                    <p style="color: #666; line-height: 1.6;">
                                        ${macro.risk_level === 'High' ? 
                                            'Elevated volatility expected. Consider defensive positioning and increased cash allocations.' :
                                            macro.risk_level === 'Medium-High' ?
                                            'Moderate uncertainty. Maintain diversification and monitor key economic releases closely.' :
                                            'Stable conditions with opportunities for risk-on positioning. Consider growth-oriented allocations.'}
                                    </p>
                                </div>
                                <div style="background: white; padding: 1.5rem; border-radius: 12px; border: 1px solid #e0e0e0;">
                                    <h4 style="color: #764ba2; margin-bottom: 1rem;">üéØ Medium-term (3-12 months)</h4>
                                    <p style="color: #666; line-height: 1.6;">
                                        ${macro.regime === 'Expansion' ? 
                                            'Economic expansion likely to continue. Favor cyclical sectors and risk assets.' :
                                            macro.regime === 'Slowdown' ?
                                            'Growth deceleration expected. Rotate into quality names and defensive sectors.' :
                                            macro.regime === 'Recovery' ?
                                            'Economic recovery underway. Consider early-cycle sectors and value opportunities.' :
                                            'Uncertain outlook. Focus on capital preservation and high-quality assets.'}
                                    </p>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    // Update the original indicators grid
                    document.getElementById('macro-indicators-grid').innerHTML = indicatorsHtml;
                    document.getElementById('macro-indicators-grid').style.display = 'block';
                    
                } else {
                    // Reset all elements to default state on error
                    document.getElementById('stdc-phase').textContent = '--';
                    document.getElementById('stdc-credit').textContent = '--';
                    document.getElementById('stdc-rates').textContent = '--';
                    document.getElementById('stdc-duration').textContent = '--';
                    document.getElementById('ltdc-phase').textContent = '--';
                    document.getElementById('ltdc-debt-gdp').textContent = '--';
                    document.getElementById('ltdc-service').textContent = '--';
                    document.getElementById('ltdc-risk').textContent = '--';
                    document.getElementById('debt-to-gdp').textContent = '--';
                    document.getElementById('credit-impulse').textContent = '--';
                    document.getElementById('real-rates').textContent = '--';
                    document.getElementById('productivity').textContent = '--';
                    document.getElementById('deleveraging-section').style.display = 'none';
                    document.getElementById('macro-indicators-grid').innerHTML = '<div class="error-message">Failed to load macro insights. Please try again.</div>';
                }
            } catch (error) {
                console.error('Error loading macro insights:', error);
                macroContent.innerHTML = '<div class="error-message">An error occurred while loading macro insights. Please try again.</div>';
            }
        }
    </script>
</body>
</html>