# Prometheus Alerting Rules
# Purpose: SLO enforcement and critical alerts
# Updated: 2025-10-26

groups:
  # ============================================================================
  # SLO Alerts
  # ============================================================================
  - name: slo_alerts
    interval: 1m
    rules:
      # API Latency SLO: p99 < 500ms
      - alert: APILatencyP99Breach
        expr: |
          histogram_quantile(0.99,
            rate(dawsos_api_request_duration_seconds_bucket[5m])
          ) > 0.5
        for: 5m
        labels:
          severity: warning
          slo: api_latency_p99
        annotations:
          summary: "API p99 latency exceeds 500ms"
          description: "p99 latency is {{ $value }}s (SLO: 0.5s) for {{ $labels.pattern_id }}"

      # API Latency SLO: p95 < 300ms
      - alert: APILatencyP95Breach
        expr: |
          histogram_quantile(0.95,
            rate(dawsos_api_request_duration_seconds_bucket[5m])
          ) > 0.3
        for: 5m
        labels:
          severity: warning
          slo: api_latency_p95
        annotations:
          summary: "API p95 latency exceeds 300ms"
          description: "p95 latency is {{ $value }}s (SLO: 0.3s) for {{ $labels.pattern_id }}"

      # Pricing Pack Build Duration: < 10 minutes
      - alert: PackBuildDurationExceeded
        expr: |
          dawsos_pack_build_duration_seconds > 600
        labels:
          severity: warning
          slo: pack_build_duration
        annotations:
          summary: "Pricing pack build exceeds 10 minutes"
          description: "Pack {{ $labels.pack_id }} took {{ $value }}s (SLO: 600s)"

  # ============================================================================
  # Error Rate Alerts
  # ============================================================================
  - name: error_alerts
    interval: 1m
    rules:
      # High Error Rate: > 1%
      - alert: HighErrorRate
        expr: |
          sum(rate(dawsos_request_errors_total[5m]))
          / sum(rate(dawsos_requests_total[5m])) > 0.01
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Error rate exceeds 1%"
          description: "Error rate is {{ $value | humanizePercentage }} (threshold: 1%)"

      # Critical Error Rate: > 5%
      - alert: CriticalErrorRate
        expr: |
          sum(rate(dawsos_request_errors_total[5m]))
          / sum(rate(dawsos_requests_total[5m])) > 0.05
        for: 2m
        labels:
          severity: critical
        annotations:
          summary: "Error rate exceeds 5%"
          description: "Error rate is {{ $value | humanizePercentage }} (threshold: 5%)"

  # ============================================================================
  # Pack Health Alerts
  # ============================================================================
  - name: pack_alerts
    interval: 1m
    rules:
      # Pack Not Fresh
      - alert: PackNotFresh
        expr: |
          dawsos_pack_freshness < 1
        for: 30m
        labels:
          severity: warning
        annotations:
          summary: "Pricing pack not fresh"
          description: "Pack {{ $labels.pack_id }} is in warming state for >30 minutes"

      # Pack Error State
      - alert: PackInErrorState
        expr: |
          dawsos_pack_freshness == 2
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "Pricing pack in error state"
          description: "Pack {{ $labels.pack_id }} has failed reconciliation or build"

  # ============================================================================
  # Circuit Breaker Alerts
  # ============================================================================
  - name: circuit_breaker_alerts
    interval: 1m
    rules:
      # Circuit Breaker Open
      - alert: CircuitBreakerOpen
        expr: |
          dawsos_circuit_breaker_state == 1
        for: 2m
        labels:
          severity: warning
        annotations:
          summary: "Circuit breaker OPEN"
          description: "Circuit breaker for {{ $labels.agent_name }} is OPEN (provider outage)"

      # Circuit Breaker Failures Spike
      - alert: CircuitBreakerFailuresSpike
        expr: |
          rate(dawsos_circuit_breaker_failures_total[5m]) > 1
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Circuit breaker failures spike"
          description: "{{ $labels.agent_name }} is experiencing {{ $value }} failures/sec"

  # ============================================================================
  # Service Health Alerts
  # ============================================================================
  - name: service_health_alerts
    interval: 30s
    rules:
      # Backend Service Down
      - alert: BackendServiceDown
        expr: |
          up{job="dawsos-backend"} == 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "Backend service is down"
          description: "DawsOS backend API is not responding"

      # Low Request Volume (potential issue)
      - alert: LowRequestVolume
        expr: |
          rate(dawsos_requests_total[5m]) < 0.01
        for: 10m
        labels:
          severity: info
        annotations:
          summary: "Unusually low request volume"
          description: "Request rate is {{ $value }}/sec (may indicate connectivity issues)"
