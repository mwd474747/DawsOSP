{% extends "base.html" %}

{% block title %}Portfolio Summary - {{ report_data.portfolio_name | default('DawsOS Portfolio') }}{% endblock %}

{% block content %}
<!-- Cover Page -->
<div class="cover-page">
    <h1>{{ report_data.portfolio_name | default('Portfolio Summary') }}</h1>
    <div class="subtitle">
        {% if report_data.date_range %}
        {{ report_data.date_range }}
        {% else %}
        Performance Report
        {% endif %}
    </div>
    <div class="timestamp">
        Generated: {{ timestamp }}
    </div>
</div>

<div class="page-break"></div>

<!-- Table of Contents -->
<h1>Table of Contents</h1>
<div class="toc">
    <div class="toc-item">
        <span class="toc-title">Performance Summary</span>
        <span class="toc-page">3</span>
    </div>
    <div class="toc-item">
        <span class="toc-title">Holdings Breakdown</span>
        <span class="toc-page">4</span>
    </div>
    {% if report_data.macro %}
    <div class="toc-item">
        <span class="toc-title">Macro Analysis</span>
        <span class="toc-page">5</span>
    </div>
    {% endif %}
    {% if report_data.ratings %}
    <div class="toc-item">
        <span class="toc-title">Ratings Summary</span>
        <span class="toc-page">6</span>
    </div>
    {% endif %}
</div>

<div class="page-break"></div>

<!-- Performance Summary -->
<h1>Performance Summary</h1>

{% if report_data._warnings %}
<div class="warning">
    <span class="warning-icon">⚠️</span>
    {% for warning in report_data._warnings %}
    <div>{{ warning }}</div>
    {% endfor %}
</div>
{% endif %}

{% if report_data.performance or report_data.kpis %}
<h2>Key Performance Indicators</h2>

<div class="kpi-grid">
    {% set kpis = report_data.performance or report_data.kpis %}

    {% if kpis.twr is defined %}
    <div class="kpi-card">
        <div class="kpi-label">Time-Weighted Return</div>
        <div class="kpi-value">{{ "%.2f"|format(kpis.twr * 100) }}%</div>
    </div>
    {% endif %}

    {% if kpis.mwr is defined %}
    <div class="kpi-card">
        <div class="kpi-label">Money-Weighted Return</div>
        <div class="kpi-value">{{ "%.2f"|format(kpis.mwr * 100) }}%</div>
    </div>
    {% endif %}

    {% if kpis.volatility is defined %}
    <div class="kpi-card">
        <div class="kpi-label">Volatility (Annualized)</div>
        <div class="kpi-value">{{ "%.2f"|format(kpis.volatility * 100) }}%</div>
    </div>
    {% endif %}

    {% if kpis.sharpe is defined %}
    <div class="kpi-card">
        <div class="kpi-label">Sharpe Ratio</div>
        <div class="kpi-value">{{ "%.2f"|format(kpis.sharpe) }}</div>
    </div>
    {% endif %}

    {% if kpis.max_drawdown is defined %}
    <div class="kpi-card">
        <div class="kpi-label">Max Drawdown</div>
        <div class="kpi-value">{{ "%.2f"|format(kpis.max_drawdown * 100) }}%</div>
    </div>
    {% endif %}

    {% if kpis.total_value is defined %}
    <div class="kpi-card">
        <div class="kpi-label">Portfolio Value</div>
        <div class="kpi-value">${{ "{:,.0f}".format(kpis.total_value) }}</div>
    </div>
    {% endif %}
</div>

{% if report_data.currency_attr or report_data.currency_attribution %}
<h3>Currency Attribution</h3>
{% set curr_attr = report_data.currency_attr or report_data.currency_attribution %}

<table>
    <thead>
        <tr>
            <th>Component</th>
            <th class="numeric">Contribution</th>
        </tr>
    </thead>
    <tbody>
        {% if curr_attr.local_return is defined %}
        <tr>
            <td>Local Return</td>
            <td class="numeric">{{ "%.2f"|format(curr_attr.local_return * 100) }}%</td>
        </tr>
        {% endif %}
        {% if curr_attr.fx_return is defined %}
        <tr>
            <td>FX Return</td>
            <td class="numeric">{{ "%.2f"|format(curr_attr.fx_return * 100) }}%</td>
        </tr>
        {% endif %}
        {% if curr_attr.interaction is defined %}
        <tr>
            <td>Interaction Effect</td>
            <td class="numeric">{{ "%.2f"|format(curr_attr.interaction * 100) }}%</td>
        </tr>
        {% endif %}
    </tbody>
</table>
{% endif %}

{% endif %}

<div class="page-break"></div>

<!-- Holdings Breakdown -->
<h1>Holdings Breakdown</h1>

{% if report_data.positions or report_data.valued or report_data.holdings %}
{% set holdings = report_data.valued or report_data.positions or report_data.holdings %}

<table class="holdings-table">
    <thead>
        <tr>
            <th>Symbol</th>
            <th>Name</th>
            <th class="numeric">Quantity</th>
            <th class="numeric">Price</th>
            <th class="numeric">Value</th>
            <th class="numeric">Weight</th>
            <th class="numeric">P/L %</th>
            {% if report_data.ratings %}
            <th>Ratings</th>
            {% endif %}
        </tr>
    </thead>
    <tbody>
        {% for holding in holdings %}
        {% if holding.symbol %}
        <tr>
            <td class="symbol-col">{{ holding.symbol }}</td>
            <td>{{ holding.name | default(holding.symbol) }}</td>
            <td class="numeric monospace">{{ "{:,.0f}".format(holding.quantity | default(holding.qty | default(0))) }}</td>
            <td class="numeric monospace">${{ "%.2f".format(holding.price | default(holding.market_price | default(0))) }}</td>
            <td class="numeric monospace">${{ "{:,.0f}".format(holding.value | default(holding.market_value | default(0))) }}</td>
            <td class="numeric monospace">{{ "%.1f".format((holding.weight | default(0)) * 100) }}%</td>
            <td class="numeric monospace {% if holding.pl_pct and holding.pl_pct > 0 %}positive{% elif holding.pl_pct and holding.pl_pct < 0 %}negative{% endif %}">
                {{ "%.2f".format((holding.pl_pct | default(holding.gain_loss_pct | default(0))) * 100) }}%
            </td>
            {% if report_data.ratings %}
            <td>
                {% if holding.ratings %}
                {% if holding.ratings.dividend_safety is defined %}
                <span class="badge {% if holding.ratings.dividend_safety >= 8 %}badge-high{% elif holding.ratings.dividend_safety >= 5 %}badge-medium{% else %}badge-low{% endif %}">
                    D:{{ "%.1f".format(holding.ratings.dividend_safety) }}
                </span>
                {% endif %}
                {% if holding.ratings.moat is defined %}
                <span class="badge {% if holding.ratings.moat >= 8 %}badge-high{% elif holding.ratings.moat >= 5 %}badge-medium{% else %}badge-low{% endif %}">
                    M:{{ "%.1f".format(holding.ratings.moat) }}
                </span>
                {% endif %}
                {% if holding.ratings.resilience is defined %}
                <span class="badge {% if holding.ratings.resilience >= 8 %}badge-high{% elif holding.ratings.resilience >= 5 %}badge-medium{% else %}badge-low{% endif %}">
                    R:{{ "%.1f".format(holding.ratings.resilience) }}
                </span>
                {% endif %}
                {% endif %}
            </td>
            {% endif %}
        </tr>
        {% endif %}
        {% endfor %}
    </tbody>
</table>

{% else %}
<p>No holdings data available.</p>
{% endif %}

<!-- Macro Analysis Section -->
{% if report_data.macro or report_data.regime %}
<div class="page-break"></div>

<h1>Macro Analysis</h1>

{% set macro = report_data.macro or {} %}
{% set regime = report_data.regime or macro.regime %}

{% if regime %}
<h2>Current Macro Regime</h2>

<div class="regime-card">
    <div class="regime-label">{{ regime.label | default('Unknown Regime') }}</div>
    {% if regime.probability is defined %}
    <div class="regime-probability">Probability: {{ "%.0f".format(regime.probability * 100) }}%</div>
    {% endif %}
    {% if regime.drivers %}
    <div class="regime-drivers">
        Key Drivers: {{ regime.drivers | map(attribute='indicator') | join(', ') }}
    </div>
    {% endif %}
</div>

{% if regime.drivers %}
<h3>Regime Drivers</h3>
<table>
    <thead>
        <tr>
            <th>Indicator</th>
            <th class="numeric">Current Value</th>
            <th class="numeric">Z-Score</th>
        </tr>
    </thead>
    <tbody>
        {% for driver in regime.drivers %}
        <tr>
            <td>{{ driver.indicator }}</td>
            <td class="numeric monospace">{{ driver.value }}</td>
            <td class="numeric monospace">{{ "%.2f".format(driver.zscore | default(0)) }}</td>
        </tr>
        {% endfor %}
    </tbody>
</table>
{% endif %}
{% endif %}

{% if macro.factors %}
<h3>Factor Exposures</h3>
<table>
    <thead>
        <tr>
            <th>Factor</th>
            <th class="numeric">Beta</th>
            <th class="numeric">Variance Share</th>
        </tr>
    </thead>
    <tbody>
        {% for factor in macro.factors %}
        <tr>
            <td>{{ factor.name }}</td>
            <td class="numeric monospace">{{ "%.2f".format(factor.beta | default(0)) }}</td>
            <td class="numeric monospace">{{ "%.1f".format((factor.variance_share | default(0)) * 100) }}%</td>
        </tr>
        {% endfor %}
    </tbody>
</table>
{% endif %}

{% endif %}

<!-- Ratings Summary Section -->
{% if report_data.ratings %}
<div class="page-break"></div>

<h1>Ratings Summary</h1>

{% if report_data.ratings.aggregate or report_data.ratings.portfolio_aggregate %}
{% set agg = report_data.ratings.aggregate or report_data.ratings.portfolio_aggregate %}

<h2>Portfolio-Wide Ratings</h2>

<div class="ratings-grid">
    {% if agg.dividend_safety is defined %}
    <div class="rating-card">
        <div class="rating-title">Dividend Safety</div>
        <div class="rating-score">{{ "%.1f".format(agg.dividend_safety) }}<span class="rating-max">/10</span></div>
    </div>
    {% endif %}

    {% if agg.moat_strength is defined %}
    <div class="rating-card">
        <div class="rating-title">Moat Strength</div>
        <div class="rating-score">{{ "%.1f".format(agg.moat_strength) }}<span class="rating-max">/10</span></div>
    </div>
    {% endif %}

    {% if agg.resilience is defined %}
    <div class="rating-card">
        <div class="rating-title">Resilience</div>
        <div class="rating-score">{{ "%.1f".format(agg.resilience) }}<span class="rating-max">/10</span></div>
    </div>
    {% endif %}
</div>
{% endif %}

{% if report_data.ratings.flagged_holdings %}
<h3>Holdings Requiring Attention</h3>
<p style="font-size: 10pt; color: #666;">Holdings with ratings below 5.0:</p>

<table>
    <thead>
        <tr>
            <th>Symbol</th>
            <th>Rating Type</th>
            <th class="numeric">Score</th>
            <th>Concern</th>
        </tr>
    </thead>
    <tbody>
        {% for flag in report_data.ratings.flagged_holdings %}
        <tr>
            <td class="symbol-col">{{ flag.symbol }}</td>
            <td>{{ flag.rating_type }}</td>
            <td class="numeric monospace">{{ "%.1f".format(flag.score) }}</td>
            <td>{{ flag.concern | default('Below threshold') }}</td>
        </tr>
        {% endfor %}
    </tbody>
</table>
{% endif %}

{% endif %}

<!-- Metadata Footer -->
<div class="metadata-footer">
    {% if report_data._metadata %}
    {% set metadata = report_data._metadata %}

    {% if metadata.pricing_pack_id %}
    <div class="metadata-item">
        <div class="metadata-label">Pricing Pack</div>
        <div class="metadata-value">{{ metadata.pricing_pack_id[:20] }}</div>
    </div>
    {% endif %}

    {% if metadata.ledger_commit_hash %}
    <div class="metadata-item">
        <div class="metadata-label">Ledger Hash</div>
        <div class="metadata-value">{{ metadata.ledger_commit_hash[:12] }}</div>
    </div>
    {% endif %}

    <div class="metadata-item">
        <div class="metadata-label">Generated</div>
        <div class="metadata-value">{{ timestamp[:19] }}</div>
    </div>
    {% endif %}
</div>

{% endblock %}
