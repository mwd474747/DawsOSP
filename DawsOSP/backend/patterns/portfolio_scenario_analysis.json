{
  "id": "portfolio_scenario_analysis",
  "name": "Portfolio Scenario Analysis",
  "description": "Stress test portfolio with macro scenarios and identify hedge opportunities",
  "version": "1.0.0",
  "category": "risk",
  "tags": ["scenario", "stress_test", "hedge", "risk"],
  "author": "DawsOS",
  "created": "2025-10-23",
  "inputs": {
    "portfolio_id": {
      "type": "uuid",
      "required": true,
      "description": "Portfolio UUID"
    },
    "scenario_id": {
      "type": "string",
      "required": false,
      "description": "Preset scenario ID (e.g., 'late_cycle_rates_up')"
    },
    "custom_shocks": {
      "type": "object",
      "required": false,
      "description": "Custom scenario shocks (rates_bps, usd_vs_cad_pct, cpi_surprise_pct)"
    }
  },
  "outputs": {
    "panels": [
      {
        "id": "scenario_summary",
        "title": "Scenario Impact",
        "type": "metrics_grid",
        "refresh_ttl": 0
      },
      {
        "id": "delta_table",
        "title": "Position Deltas",
        "type": "table",
        "refresh_ttl": 0
      },
      {
        "id": "winners_losers",
        "title": "Winners & Losers",
        "type": "dual_list",
        "refresh_ttl": 0
      },
      {
        "id": "hedge_suggestions",
        "title": "Hedge Ideas",
        "type": "action_cards",
        "refresh_ttl": 0
      }
    ]
  },
  "steps": [
    {
      "capability": "ledger.positions",
      "args": {
        "portfolio_id": "{{inputs.portfolio_id}}"
      },
      "as": "positions"
    },
    {
      "capability": "pricing.apply_pack",
      "args": {
        "positions": "{{state.positions}}",
        "pack_id": "{{ctx.pricing_pack_id}}"
      },
      "as": "valued_base"
    },
    {
      "capability": "macro.run_scenario",
      "args": {
        "portfolio_id": "{{inputs.portfolio_id}}",
        "pack_id": "{{ctx.pricing_pack_id}}",
        "scenario_id": "{{inputs.scenario_id}}",
        "custom_shocks": "{{inputs.custom_shocks}}"
      },
      "as": "scenario_result"
    },
    {
      "capability": "optimizer.suggest_hedges",
      "args": {
        "portfolio_id": "{{inputs.portfolio_id}}",
        "scenario_result": "{{state.scenario_result}}",
        "max_cost_bps": 20
      },
      "as": "hedge_suggestions"
    },
    {
      "capability": "charts.scenario_deltas",
      "args": {
        "base": "{{state.valued_base}}",
        "shocked": "{{state.scenario_result}}"
      },
      "as": "charts"
    }
  ],
  "presentation": {
    "scenario_summary": {
      "metrics": [
        {
          "label": "Scenario Name",
          "value": "{{scenario_result.scenario_name}}",
          "format": "text"
        },
        {
          "label": "Total P&L Impact",
          "value": "{{scenario_result.total_pnl_delta}}",
          "format": "currency",
          "color_condition": "sign"
        },
        {
          "label": "Return Impact",
          "value": "{{scenario_result.return_delta}}",
          "format": "percentage",
          "color_condition": "sign"
        },
        {
          "label": "Max Position Loss",
          "value": "{{scenario_result.max_position_loss}}",
          "format": "currency",
          "color": "red"
        },
        {
          "label": "Positions Impacted",
          "value": "{{scenario_result.positions_impacted}}",
          "format": "number"
        }
      ]
    },
    "delta_table": {
      "columns": [
        {"field": "symbol", "header": "Symbol", "width": 100},
        {"field": "base_value", "header": "Base Value", "format": "currency", "width": 120},
        {"field": "shocked_value", "header": "Shocked Value", "format": "currency", "width": 120},
        {"field": "delta_value", "header": "Delta ($)", "format": "currency", "width": 120, "color_condition": "sign"},
        {"field": "delta_pct", "header": "Delta (%)", "format": "percentage", "width": 100, "color_condition": "sign"},
        {"field": "primary_driver", "header": "Driver", "width": 120}
      ],
      "data": "{{scenario_result.position_deltas}}"
    },
    "winners_losers": {
      "winners": {
        "title": "Top 5 Winners",
        "data": "{{scenario_result.winners}}",
        "value_field": "delta_value",
        "label_field": "symbol"
      },
      "losers": {
        "title": "Top 5 Losers",
        "data": "{{scenario_result.losers}}",
        "value_field": "delta_value",
        "label_field": "symbol"
      }
    },
    "hedge_suggestions": {
      "cards": "{{hedge_suggestions.suggestions}}",
      "card_template": {
        "title": "{{instrument}}",
        "subtitle": "{{strategy}}",
        "metrics": [
          {"label": "Estimated Cost", "value": "{{cost_bps}}", "format": "bps"},
          {"label": "Hedge Effectiveness", "value": "{{effectiveness}}", "format": "percentage"},
          {"label": "Suggested Size", "value": "{{size}}", "format": "currency"}
        ]
      }
    }
  },
  "rights_required": ["portfolio_read", "scenario_analysis"],
  "export_allowed": {
    "pdf": true,
    "csv": true
  },
  "observability": {
    "otel_span_name": "pattern.portfolio_scenario_analysis",
    "metrics": [
      "pattern_execution_duration_seconds",
      "scenario_computation_duration_seconds"
    ]
  }
}
