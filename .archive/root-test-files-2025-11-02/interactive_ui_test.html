<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>DawsOS Interactive UI Test</title>
    <style>
        body {
            font-family: 'IBM Plex Sans', system-ui, -apple-system, sans-serif;
            background: #0A0E27;
            color: #E4E4E6;
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }
        .test-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 30px;
            border-radius: 12px;
            margin-bottom: 30px;
            box-shadow: 0 10px 40px rgba(102, 126, 234, 0.2);
        }
        .test-section {
            background: #161B33;
            border: 1px solid #2A3050;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 8px;
        }
        .test-button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
        }
        .test-button:hover {
            background: #45a049;
        }
        .test-result {
            background: #1A1F38;
            padding: 15px;
            margin-top: 10px;
            border-radius: 5px;
            border: 1px solid #2A3050;
            font-family: 'IBM Plex Mono', monospace;
            font-size: 14px;
            overflow-x: auto;
        }
        .success {
            color: #4CAF50;
            font-weight: bold;
        }
        .error {
            color: #F44336;
            font-weight: bold;
        }
        .info {
            color: #64B5F6;
        }
        h1 {
            margin: 0;
            font-size: 2em;
            text-align: center;
        }
        h2 {
            color: #E4E4E6;
            margin-top: 0;
        }
        iframe {
            width: 100%;
            height: 600px;
            border: 2px solid #2A3050;
            border-radius: 8px;
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        .stat-card {
            background: #1A1F38;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #2A3050;
        }
        .stat-label {
            font-size: 0.9em;
            color: #9CA3AF;
            margin-bottom: 5px;
        }
        .stat-value {
            font-size: 1.5em;
            font-weight: bold;
            color: #E4E4E6;
        }
    </style>
</head>
<body>
    <div class="test-header">
        <h1>üöÄ DawsOS Interactive UI Testing Suite</h1>
    </div>

    <div class="test-section">
        <h2>üìä Real-Time Test Statistics</h2>
        <div class="stats">
            <div class="stat-card">
                <div class="stat-label">Portfolio Value</div>
                <div class="stat-value" id="portfolio-value">Loading...</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Total Positions</div>
                <div class="stat-value" id="position-count">Loading...</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">API Response Time</div>
                <div class="stat-value" id="response-time">Loading...</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Patterns Executed</div>
                <div class="stat-value" id="pattern-count">0</div>
            </div>
        </div>
    </div>

    <div class="test-section">
        <h2>üîê 1. Authentication Tests</h2>
        <button class="test-button" onclick="testLogin()">Test Login</button>
        <button class="test-button" onclick="testTokenRefresh()">Test Token Refresh</button>
        <button class="test-button" onclick="testLogout()">Test Logout</button>
        <div id="auth-result" class="test-result"></div>
    </div>

    <div class="test-section">
        <h2>üìà 2. Pattern Execution Tests</h2>
        <button class="test-button" onclick="testPortfolioOverview()">Portfolio Overview</button>
        <button class="test-button" onclick="testMacroCycles()">Macro Cycles</button>
        <button class="test-button" onclick="testBuffettChecklist()">Buffett Checklist</button>
        <button class="test-button" onclick="testScenarioAnalysis()">Scenario Analysis</button>
        <button class="test-button" onclick="testNewsImpact()">News Impact</button>
        <button class="test-button" onclick="testAllPatterns()">Test All 12 Patterns</button>
        <div id="pattern-result" class="test-result"></div>
    </div>

    <div class="test-section">
        <h2>üéØ 3. Data Validation Tests</h2>
        <button class="test-button" onclick="testRealPositions()">Verify Real Positions</button>
        <button class="test-button" onclick="testPricing()">Check Pricing Data</button>
        <button class="test-button" onclick="testTransactions()">Verify Transactions</button>
        <button class="test-button" onclick="testMetrics()">Check Performance Metrics</button>
        <div id="data-result" class="test-result"></div>
    </div>

    <div class="test-section">
        <h2>üñ•Ô∏è 4. Live Application Preview</h2>
        <iframe id="app-frame" src="http://localhost:5000"></iframe>
    </div>

    <script>
        const API_BASE = 'http://localhost:5000';
        let authToken = null;
        let patternCount = 0;
        
        // Helper function to display results
        function showResult(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'success' ? 'success' : type === 'error' ? 'error' : 'info';
            element.innerHTML = `<span class="${className}">[${timestamp}] ${message}</span>\n` + element.innerHTML;
        }

        // Authentication tests
        async function testLogin() {
            try {
                const response = await fetch(`${API_BASE}/api/auth/login`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        email: 'michael@dawsos.com',
                        password: 'admin123'
                    })
                });
                const data = await response.json();
                if (response.ok) {
                    authToken = data.access_token;
                    showResult('auth-result', `‚úÖ Login successful! User: ${data.user.email}, Role: ${data.user.role}`, 'success');
                    
                    // Auto-navigate app to dashboard
                    document.getElementById('app-frame').src = `${API_BASE}/?token=${authToken}&view=dashboard`;
                } else {
                    showResult('auth-result', `‚ùå Login failed: ${data.detail}`, 'error');
                }
            } catch (error) {
                showResult('auth-result', `‚ùå Login error: ${error.message}`, 'error');
            }
        }

        async function testTokenRefresh() {
            if (!authToken) {
                showResult('auth-result', '‚ö†Ô∏è Please login first', 'error');
                return;
            }
            try {
                const response = await fetch(`${API_BASE}/api/auth/refresh`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    }
                });
                const data = await response.json();
                if (response.ok) {
                    authToken = data.access_token;
                    showResult('auth-result', `‚úÖ Token refreshed! New expiration: ${data.expires_in} seconds`, 'success');
                } else {
                    showResult('auth-result', `‚ùå Refresh failed: ${data.detail}`, 'error');
                }
            } catch (error) {
                showResult('auth-result', `‚ùå Refresh error: ${error.message}`, 'error');
            }
        }

        async function testLogout() {
            authToken = null;
            showResult('auth-result', '‚úÖ Logged out successfully', 'success');
            document.getElementById('app-frame').src = API_BASE;
        }

        // Pattern tests
        async function executePattern(patternId, inputs) {
            if (!authToken) {
                showResult('pattern-result', '‚ö†Ô∏è Please login first', 'error');
                return null;
            }
            
            const startTime = Date.now();
            try {
                const response = await fetch(`${API_BASE}/api/patterns/execute`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({pattern_id: patternId, inputs})
                });
                const data = await response.json();
                const responseTime = Date.now() - startTime;
                
                document.getElementById('response-time').textContent = `${responseTime}ms`;
                
                if (response.ok) {
                    patternCount++;
                    document.getElementById('pattern-count').textContent = patternCount;
                    return data;
                } else {
                    throw new Error(data.detail || 'Pattern execution failed');
                }
            } catch (error) {
                showResult('pattern-result', `‚ùå ${patternId} error: ${error.message}`, 'error');
                return null;
            }
        }

        async function testPortfolioOverview() {
            const result = await executePattern('portfolio_overview', {
                portfolio_id: '64ff3be6-0ed1-4990-a32b-4ded17f0320c',
                lookback_days: 30
            });
            if (result) {
                const positions = result.data?.valued_positions?.positions || [];
                document.getElementById('position-count').textContent = positions.length;
                
                const totalValue = positions.reduce((sum, p) => sum + parseFloat(p.value || 0), 0);
                document.getElementById('portfolio-value').textContent = `$${totalValue.toLocaleString('en-US', {maximumFractionDigits: 0})}`;
                
                showResult('pattern-result', `‚úÖ Portfolio Overview: ${positions.length} positions, Total: $${totalValue.toLocaleString()}`, 'success');
            }
        }

        async function testMacroCycles() {
            const result = await executePattern('macro_cycles_overview', {
                portfolio_id: '64ff3be6-0ed1-4990-a32b-4ded17f0320c'
            });
            if (result) {
                const indicators = result.data?.macro_indicators || [];
                const cycles = result.data?.cycle_phases || {};
                showResult('pattern-result', `‚úÖ Macro Cycles: ${indicators.length} indicators, ${Object.keys(cycles).length} cycles`, 'success');
            }
        }

        async function testBuffettChecklist() {
            const result = await executePattern('buffett_checklist', {
                security_id: '0b225e3f-5c2c-4dc6-8d3c-2bcf9700c32c'  // BRK.B
            });
            if (result) {
                showResult('pattern-result', `‚úÖ Buffett Checklist executed for BRK.B`, 'success');
            }
        }

        async function testScenarioAnalysis() {
            const result = await executePattern('portfolio_scenario_analysis', {
                portfolio_id: '64ff3be6-0ed1-4990-a32b-4ded17f0320c',
                scenario_type: 'deleveraging'
            });
            if (result) {
                const scenarios = result.data?.portfolio_scenario || [];
                showResult('pattern-result', `‚úÖ Scenario Analysis: ${scenarios.length} scenarios analyzed`, 'success');
            }
        }

        async function testNewsImpact() {
            const result = await executePattern('news_impact_analysis', {
                portfolio_id: '64ff3be6-0ed1-4990-a32b-4ded17f0320c',
                lookback_hours: 24
            });
            if (result) {
                const news = result.data?.news || [];
                showResult('pattern-result', `‚úÖ News Impact: ${news.length} articles analyzed`, 'success');
            }
        }

        async function testAllPatterns() {
            const patterns = [
                ['portfolio_overview', {portfolio_id: '64ff3be6-0ed1-4990-a32b-4ded17f0320c'}],
                ['macro_cycles_overview', {portfolio_id: '64ff3be6-0ed1-4990-a32b-4ded17f0320c'}],
                ['buffett_checklist', {security_id: '0b225e3f-5c2c-4dc6-8d3c-2bcf9700c32c'}],
                ['portfolio_scenario_analysis', {portfolio_id: '64ff3be6-0ed1-4990-a32b-4ded17f0320c', scenario_type: 'deleveraging'}],
                ['news_impact_analysis', {portfolio_id: '64ff3be6-0ed1-4990-a32b-4ded17f0320c', lookback_hours: 24}],
                ['currency_attribution', {portfolio_id: '64ff3be6-0ed1-4990-a32b-4ded17f0320c', lookback_days: 30}],
                ['security_fundamentals', {security_id: '0b225e3f-5c2c-4dc6-8d3c-2bcf9700c32c'}],
                ['portfolio_optimization', {portfolio_id: '64ff3be6-0ed1-4990-a32b-4ded17f0320c', target_return: 0.12}],
                ['macro_regime_detection', {portfolio_id: '64ff3be6-0ed1-4990-a32b-4ded17f0320c'}],
                ['dalio_cycle_analysis', {portfolio_id: '64ff3be6-0ed1-4990-a32b-4ded17f0320c', cycle_type: 'long_term_debt'}],
                ['risk_deleveraging', {portfolio_id: '64ff3be6-0ed1-4990-a32b-4ded17f0320c'}],
                ['alert_presets', {portfolio_id: '64ff3be6-0ed1-4990-a32b-4ded17f0320c', preset_type: 'drawdown'}]
            ];
            
            let successCount = 0;
            for (const [patternId, inputs] of patterns) {
                const result = await executePattern(patternId, inputs);
                if (result && result.status === 'success') {
                    successCount++;
                    showResult('pattern-result', `‚úÖ ${patternId}: Success`, 'success');
                } else {
                    showResult('pattern-result', `‚ùå ${patternId}: Failed`, 'error');
                }
                await new Promise(resolve => setTimeout(resolve, 500)); // Small delay between tests
            }
            
            showResult('pattern-result', `üìä SUMMARY: ${successCount}/12 patterns working`, successCount === 12 ? 'success' : 'error');
        }

        // Data validation tests
        async function testRealPositions() {
            const result = await executePattern('portfolio_overview', {
                portfolio_id: '64ff3be6-0ed1-4990-a32b-4ded17f0320c'
            });
            if (result) {
                const positions = result.data?.valued_positions?.positions || [];
                const symbols = positions.map(p => p.symbol);
                const uniqueSymbols = [...new Set(symbols)];
                showResult('data-result', `‚úÖ Real Positions: ${positions.length} positions across ${uniqueSymbols.length} securities: ${uniqueSymbols.join(', ')}`, 'success');
            }
        }

        async function testPricing() {
            const result = await executePattern('portfolio_overview', {
                portfolio_id: '64ff3be6-0ed1-4990-a32b-4ded17f0320c'
            });
            if (result) {
                const positions = result.data?.valued_positions?.positions || [];
                const hasPrice = positions.filter(p => p.price && parseFloat(p.price) > 0);
                showResult('data-result', `‚úÖ Pricing Data: ${hasPrice.length}/${positions.length} positions have valid prices`, 'success');
            }
        }

        async function testTransactions() {
            if (!authToken) {
                showResult('data-result', '‚ö†Ô∏è Please login first', 'error');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/api/transactions/64ff3be6-0ed1-4990-a32b-4ded17f0320c`, {
                    headers: {'Authorization': `Bearer ${authToken}`}
                });
                const transactions = await response.json();
                if (response.ok) {
                    showResult('data-result', `‚úÖ Transactions: ${transactions.length} ledger entries found`, 'success');
                } else {
                    throw new Error('Failed to fetch transactions');
                }
            } catch (error) {
                showResult('data-result', `‚ùå Transaction test error: ${error.message}`, 'error');
            }
        }

        async function testMetrics() {
            const result = await executePattern('portfolio_overview', {
                portfolio_id: '64ff3be6-0ed1-4990-a32b-4ded17f0320c'
            });
            if (result) {
                const metrics = result.data?.perf_metrics || {};
                const hasMetrics = Object.keys(metrics).filter(k => metrics[k] !== null);
                showResult('data-result', `‚úÖ Performance Metrics: ${hasMetrics.length} metrics available`, 'success');
            }
        }

        // Auto-login on page load
        window.addEventListener('load', () => {
            setTimeout(testLogin, 1000);
        });
    </script>
</body>
</html>