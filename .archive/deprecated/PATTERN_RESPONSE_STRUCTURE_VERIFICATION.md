# Pattern Response Structure Verification Report

## Executive Summary

This report documents the discrepancies between backend pattern output structures and the UI's patternRegistry expectations in `full_ui.html`. Critical mismatches were found that would cause UI rendering failures if not addressed before migration.

## Critical Findings

### 1. portfolio_overview Pattern

**Status**: ❌ MISMATCH FOUND

**Pattern Outputs** (from backend/patterns/portfolio_overview.json):
```json
"outputs": ["perf_metrics", "currency_attr", "valued_positions", "sector_allocation", "historical_nav"]
```

**UI Expected DataPaths** (from patternRegistry):
```javascript
{
  'perf_metrics',           // ✅ Match
  'historical_nav',        // ✅ Match
  'currency_attr',         // ✅ Match
  'sector_allocation',     // ✅ Match
  'valued_positions.positions' // ❌ MISMATCH - expects nested path
}
```

**Issue**: The holdings table expects `valued_positions.positions` but the pattern stores the valued positions directly as `valued_positions`. The pattern step `pricing.apply_pack` returns a structure like:
```json
{
  "positions": [...],
  "total_value": ...
}
```
So `valued_positions.positions` would be the correct path if the capability returns this structure.

**Impact**: The holdings table in Dashboard, Attribution, and Performance pages won't display data.

### 2. portfolio_scenario_analysis Pattern

**Status**: ✅ MOSTLY CORRECT

**Pattern Outputs** (based on steps):
- `positions`
- `valued_base`
- `scenario_result`
- `hedge_suggestions`
- `charts`

**UI Expected DataPaths**:
```javascript
{
  'scenario_result',                    // ✅ Match
  'scenario_result.position_deltas',    // ✅ Match (if nested)
  'scenario_result',                    // ✅ Match (for winners_losers)
  'hedge_suggestions.suggestions'       // ✅ Match (if nested)
}
```

**Status**: Likely correct, but depends on the actual structure returned by capabilities.

### 3. portfolio_cycle_risk Pattern

**Status**: ❌ MAJOR MISMATCH

**Pattern Outputs** (based on steps):
- `stdc` (Short-term debt cycle)
- `ltdc` (Long-term debt cycle)
- `factor_exposures`
- `cycle_risk_map`
- `dar`

**UI Expected DataPaths**:
```javascript
{
  'risk_summary',    // ❌ NOT IN PATTERN
  'vulnerabilities'  // ❌ NOT IN PATTERN
}
```

**Issue**: The UI expects `risk_summary` and `vulnerabilities` but these are never generated by the pattern. The pattern's presentation layer defines a `risk_summary` metrics grid but doesn't map it to actual data.

**Impact**: Risk page will have empty panels.

### 4. news_impact_analysis Pattern

**Status**: ❌ MISMATCH FOUND

**Pattern Outputs** (based on steps):
- `positions`
- `valued`
- `news_items`
- `impact_analysis`
- `alert_result` (conditional)

**UI Expected DataPaths**:
```javascript
{
  'summary',     // ❌ MISMATCH - should be 'impact_analysis'
  'news_items'   // ✅ Match
}
```

**Issue**: The UI expects `summary` but the pattern outputs `impact_analysis`.

**Impact**: MarketData page news summary won't display.

### 5. buffett_checklist Pattern

**Status**: ✅ CORRECT

**Pattern Outputs**:
```json
"outputs": ["fundamentals", "dividend_safety", "moat_strength", "resilience", "aggregate", "explanation"]
```

**UI Expected DataPaths**:
```javascript
{
  'moat_strength',    // ✅ Match
  'dividend_safety',  // ✅ Match
  'resilience'        // ✅ Match
}
```

**Status**: Correctly matched. The UI uses the appropriate subset of outputs.

### 6. policy_rebalance Pattern

**Status**: ❌ MAJOR MISMATCH

**Pattern Outputs** (based on steps):
- `positions`
- `valued`
- `ratings`
- `rebalance_result`
- `impact`

**UI Expected DataPaths**:
```javascript
{
  'summary',  // ❌ MISMATCH - should be 'rebalance_result'
  'trades'    // ❌ MISMATCH - should be 'rebalance_result.trades'
}
```

**Issue**: The UI expects `summary` and `trades` at the root level, but the pattern outputs `rebalance_result` (which likely contains trades) and `impact`.

**Impact**: Optimizer page won't display rebalancing data.

## Additional Pattern Analysis

### 7. macro_cycles_overview Pattern

**Status**: ✅ CORRECT

**Pattern Outputs**:
```json
"outputs": {
  "stdc": "Short-term debt cycle analysis",
  "ltdc": "Long-term debt cycle analysis", 
  "empire": "Empire cycle analysis",
  "civil": "Civil/internal order cycle analysis"
}
```

**UI Expected DataPaths**:
```javascript
{
  'stdc',    // ✅ Match
  'ltdc',    // ✅ Match
  'empire',  // ✅ Match
  'civil'    // ✅ Match
}
```

### 8. macro_trend_monitor Pattern

**Status**: ❌ POTENTIAL MISMATCH

**Pattern Outputs** (based on steps):
- `regime_history`
- `factor_history`
- `trend_analysis`
- `alert_suggestions`

**UI Expected DataPaths**:
```javascript
{
  'trends',      // ❌ NOT IN PATTERN
  'indicators'   // ❌ NOT IN PATTERN
}
```

**Issue**: The UI expects `trends` and `indicators` but the pattern outputs different data structures.

### 9. holding_deep_dive Pattern

**Status**: ❌ POTENTIAL MISMATCH

**Pattern Outputs** (based on steps):
- `position`
- `position_perf`
- `contribution`
- `currency_attr`
- `risk`
- `transactions`
- `fundamentals` (conditional)
- `comparables` (conditional)

**UI Expected DataPaths**:
```javascript
{
  'metrics',       // ❌ NOT IN PATTERN
  'fundamentals'   // ✅ Match
}
```

**Issue**: The UI expects `metrics` but this is not generated by the pattern.

## Summary of Required Fixes

### High Priority (Breaking Issues):
1. **portfolio_overview**: Verify if `valued_positions.positions` is valid or should be changed in UI
2. **portfolio_cycle_risk**: Add `risk_summary` and `vulnerabilities` aggregation steps
3. **news_impact_analysis**: Change UI dataPath from `summary` to `impact_analysis`
4. **policy_rebalance**: Change UI dataPaths to match pattern outputs

### Medium Priority (Feature Gaps):
1. **macro_trend_monitor**: Add `trends` and `indicators` to pattern outputs
2. **holding_deep_dive**: Add `metrics` aggregation step

### Low Priority (Working Correctly):
1. **buffett_checklist**: No changes needed
2. **macro_cycles_overview**: No changes needed
3. **portfolio_scenario_analysis**: Verify nested structures work as expected

## Recommendations

1. **Immediate Action**: Fix the UI dataPaths to match actual pattern outputs before migration
2. **Pattern Updates**: Update patterns to generate missing data structures where needed
3. **Validation**: Add runtime validation to check dataPath existence before rendering
4. **Testing**: Create integration tests that verify pattern outputs match UI expectations

## Code Changes Required

### UI Changes (full_ui.html):
```javascript
// portfolio_overview - Line 2829
dataPath: 'valued_positions'  // Remove .positions if not nested

// portfolio_cycle_risk - Lines 2881, 2887
dataPath: 'cycle_risk_map'  // Instead of 'risk_summary'
dataPath: 'dar'              // Instead of 'vulnerabilities'

// news_impact_analysis - Line 2997
dataPath: 'impact_analysis'  // Instead of 'summary'

// policy_rebalance - Lines 3043, 3049
dataPath: 'rebalance_result' // Instead of 'summary'
dataPath: 'rebalance_result.trades' // Instead of 'trades'

// macro_trend_monitor - Lines 2939, 2945
dataPath: 'trend_analysis'   // Instead of 'trends'
dataPath: 'regime_history'   // Instead of 'indicators'

// holding_deep_dive - Line 3020
dataPath: 'position'         // Instead of 'metrics'
```

## Validation Script

To verify these findings programmatically, run:
```python
# Check if pattern outputs match UI expectations
import json

def validate_pattern_ui_match(pattern_file, ui_datapaths):
    with open(pattern_file) as f:
        pattern = json.load(f)
    
    # Extract outputs from pattern steps
    outputs = set()
    for step in pattern.get('steps', []):
        outputs.add(step.get('as'))
    
    # Check each UI datapath
    mismatches = []
    for datapath in ui_datapaths:
        root = datapath.split('.')[0]
        if root not in outputs:
            mismatches.append(datapath)
    
    return mismatches
```

## Next Steps

1. Review this report with the team
2. Decide whether to fix UI or patterns (recommend fixing UI as it's simpler)
3. Implement fixes in priority order
4. Test each pattern with real data before migration
5. Add monitoring to detect dataPath resolution failures in production