{
  "id": "tax_harvesting_opportunities",
  "name": "Tax Harvesting Opportunities",
  "description": "Identify tax loss harvesting opportunities and optimize tax efficiency",
  "version": "1.0.0",
  "category": "tax_compliance",
  "tags": ["tax", "optimization", "harvesting"],
  "author": "DawsOS",
  "created": "2025-11-06",
  "inputs": {
    "portfolio_id": {
      "type": "string",
      "required": true,
      "description": "Portfolio UUID"
    },
    "min_loss_threshold": {
      "type": "number",
      "required": false,
      "default": 1000,
      "description": "Minimum loss amount to consider for harvesting"
    },
    "avoid_wash_sales": {
      "type": "boolean",
      "required": false,
      "default": true,
      "description": "Filter out positions that would create wash sales"
    },
    "tax_rate": {
      "type": "number",
      "required": false,
      "default": 0.32,
      "description": "Marginal tax rate for benefit calculations"
    }
  },
  "outputs": ["current_positions", "unrealized_pl", "loss_positions", "wash_sale_risks", "opportunities"],
  "steps": [
    {
      "capability": "ledger.positions",
      "args": {
        "portfolio_id": "{{inputs.portfolio_id}}"
      },
      "as": "current_positions"
    },
    {
      "capability": "metrics.unrealized_pl",
      "args": {
        "positions": "{{current_positions}}"
      },
      "as": "unrealized_pl"
    },
    {
      "capability": "tax.identify_losses",
      "args": {
        "positions": "{{current_positions}}",
        "unrealized_pl": "{{unrealized_pl}}",
        "min_loss": "{{inputs.min_loss_threshold}}"
      },
      "as": "loss_positions"
    },
    {
      "capability": "tax.wash_sale_check",
      "args": {
        "portfolio_id": "{{inputs.portfolio_id}}",
        "positions": "{{loss_positions}}"
      },
      "as": "wash_sale_risks"
    },
    {
      "capability": "tax.calculate_benefit",
      "args": {
        "loss_positions": "{{loss_positions}}",
        "tax_rate": "{{inputs.tax_rate}}",
        "wash_sale_risks": "{{wash_sale_risks}}"
      },
      "as": "tax_benefits"
    },
    {
      "capability": "tax.rank_opportunities",
      "args": {
        "positions": "{{loss_positions}}",
        "benefits": "{{tax_benefits}}"
      },
      "as": "opportunities"
    }
  ]
}